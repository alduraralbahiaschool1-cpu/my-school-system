<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --font-main: 'Tajawal', sans-serif; 
            --primary-color: #4f46e5;
            --secondary-color: #6366f1;
        }
        
        * {
            font-family: var(--font-main);
            box-sizing: border-box;
        }
        
        body { 
            background-color: #f1f5f9; 
            overflow-x: hidden;
            direction: rtl;
            margin: 0;
            padding: 0;
        }
        
        /* Glassmorphism Effects */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        
        /* Input Styling */
        .input-std { 
            width: 100%;
            padding: 1rem;
            border-radius: 1rem;
            border: 2px solid #e2e8f0;
            background-color: #ffffff;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #1e293b;
            outline: none;
        }
        
        .input-std:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }
        
        /* Button Styles */
        .btn-action { 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            font-weight: 700;
            padding: 1rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px -5px rgba(79, 70, 229, 0.4);
        }
        
        .btn-action:active {
            transform: translateY(0);
        }
        
        .btn-emerald { 
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-rose { 
            background: linear-gradient(135deg, #e11d48 0%, #f43f5e 100%);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(225, 29, 72, 0.25);
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        /* Dashboard Cards */
        .dash-card { 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .dash-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .dash-card:hover::before {
            opacity: 1;
        }
        
        .dash-card:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 25px 40px -5px rgba(0, 0, 0, 0.2); 
        }
        
        .dash-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(0.8);
        }
        
        /* Animations */
        .fade-in { 
            animation: fadeIn 0.5s ease-out forwards; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* PIN Dots */
        .pin-dot { 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            border: 2px solid #94a3b8; 
            transition: all 0.2s; 
            background: transparent;
        }
        
        .pin-dot.active { 
            background-color: #4f46e5; 
            border-color: #4f46e5; 
            transform: scale(1.3); 
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
        }
        
        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { 
            width: 8px; 
        }
        
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .custom-scroll::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 8px;
            border: 2px solid #f1f5f9;
        }
        
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* Print Styles */
        @media print {
            body * { 
                visibility: hidden; 
            }
            #print-area, #print-area * { 
                visibility: visible; 
            }
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                height: 100%; 
            }
            @page { 
                size: A5 landscape; 
                margin: 0; 
            }
            .no-print { 
                display: none !important; 
            }
        }
        
        /* Permission Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        
        /* Student Edit List */
        .student-edit-item {
            transition: all 0.2s;
        }
        .student-edit-item:hover {
            background-color: #f8fafc;
            transform: translateX(-5px);
        }
        
        /* Custom grid for RTL */
        .dir-ltr {
            direction: ltr;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #1e293b;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Table Styles */
        .data-table th {
            background: #f8fafc;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        
        .data-table td {
            font-weight: 600;
            color: #334155;
        }
        
        .data-table tr:hover td {
            background: #f8fafc;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col antialiased">

    <!-- ========================================== -->
    <!-- 1. GOOGLE LOGIN LAYER                     -->
    <!-- ========================================== -->
    <div id="view-google-login" class="fixed inset-0 z-[70] bg-slate-900 flex flex-col items-center justify-center p-6 text-center">
        <div class="bg-white p-12 rounded-[3rem] shadow-2xl max-w-md w-full fade-in relative overflow-hidden border border-slate-200">
            <!-- Header Decoration -->
            <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
            
            <!-- Logo Icon -->
            <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center text-5xl mb-8 mx-auto text-indigo-600 shadow-inner ring-4 ring-white">
                ğŸ«
            </div>
            
            <h1 class="text-4xl font-black text-slate-800 mb-3 tracking-tight">Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</h1>
            <p class="text-slate-500 mb-10 font-medium text-lg">Ù†Ø¸Ø§Ù… Ù…Ø§Ù„ÙŠ Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Google Cloud</p>
            
            <!-- Google Sign In Button -->
            <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 text-slate-700 font-bold py-5 px-6 rounded-2xl transition-all shadow-sm group mb-6">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 group-hover:scale-110 transition duration-300">
                <span class="text-lg">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</span>
            </button>
            
            <!-- Status Message -->
            <p id="login-status" class="mt-8 text-sm text-indigo-600 font-black animate-pulse hidden">
                <i class="fa-solid fa-circle-notch fa-spin ml-2"></i>
                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
            </p>
        </div>
        
        <div class="mt-8 text-slate-500 text-sm">
            <p>Â© 2025 Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 2. YEAR SELECTION LAYER                   -->
    <!-- ========================================== -->
    <div id="view-year-select" class="hidden fixed inset-0 z-[60] bg-slate-900 flex flex-col items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl max-w-5xl w-full fade-in max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-black text-slate-800 mb-3">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h2>
                <p class="text-slate-500">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡ (ÙŠØªÙ… ÙØµÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ù…)</p>
            </div>
            
            <div id="years-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-10">
                <!-- Years will be injected here -->
            </div>
            
            <div class="border-t-2 border-slate-100 pt-8">
                <h3 class="font-bold text-slate-700 mb-4 text-center">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø§Ù… Ø¯Ø±Ø§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
                <div class="flex gap-4 justify-center max-w-md mx-auto">
                    <input type="text" id="new-year-input" placeholder="Ù…Ø«Ø§Ù„: 2026-2027" class="input-std text-center flex-1">
                    <button onclick="createNewYear()" class="btn-emerald whitespace-nowrap">
                        <i class="fa-solid fa-plus ml-2"></i> Ø¥Ù†Ø´Ø§Ø¡
                    </button>
                </div>
                <p class="text-center text-xs text-slate-400 mt-4">Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø§Ù… Ø¬Ø¯ÙŠØ¯ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</p>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 3. PIN LOGIN LAYER                        -->
    <!-- ========================================== -->
    <div id="view-pin-login" class="hidden fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-6">
        <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
            <!-- Left Side: Info -->
            <div class="space-y-8 text-white">
                <div>
                    <div class="flex items-center gap-4 mb-6 opacity-90 flex-wrap">
                        <span class="w-3 h-3 bg-emerald-400 rounded-full animate-pulse"></span>
                        <span class="text-sm font-mono bg-slate-800 px-3 py-1 rounded-lg" id="cloud-email-display"> waiting...</span>
                        <span id="current-year-display" class="bg-indigo-600 px-4 py-1.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-500/30">2025-2026</span>
                        <button onclick="changeYear()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg text-indigo-200 transition border border-white/10">
                            <i class="fa-solid fa-rotate ml-1"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù…
                        </button>
                    </div>
                    
                    <h1 class="text-6xl font-black mb-6 leading-tight drop-shadow-2xl">
                        Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©<br>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</span>
                    </h1>
                    
                    <p class="text-slate-400 text-xl font-light">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø§Ù„ÙŠ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹ÙˆØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
                </div>
                
                <!-- Users List -->
                <div class="bg-white/5 backdrop-blur-xl border border-white/10 p-6 rounded-3xl shadow-2xl">
                    <h3 class="font-bold mb-5 text-indigo-200 flex items-center gap-3 text-lg">
                        <i class="fa-solid fa-users-viewfinder bg-indigo-500/20 p-2 rounded-lg"></i>
                        Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
                    </h3>
                    <div id="login-users-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-72 overflow-y-auto custom-scroll pr-2">
                        <!-- Users injected here -->
                    </div>
                </div>
                
                <button onclick="fullLogout()" class="text-white/60 hover:text-white text-sm font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket rotate-180"></i>
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
                </button>
            </div>
            
            <!-- Right Side: PIN Pad -->
            <div id="pin-pad-area" class="bg-white/10 backdrop-blur-2xl border border-white/10 p-10 rounded-[3.5rem] shadow-2xl opacity-50 pointer-events-none transition-all duration-500 max-w-md mx-auto w-full">
                <div class="text-center mb-10">
                    <p id="pin-target-name" class="text-white font-bold mb-8 text-2xl">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
                    <div class="flex justify-center gap-5 dir-ltr mb-2">
                        <div class="pin-dot" id="pd-1"></div>
                        <div class="pin-dot" id="pd-2"></div>
                        <div class="pin-dot" id="pd-3"></div>
                        <div class="pin-dot" id="pd-4"></div>
                    </div>
                    <p id="pin-error" class="text-rose-400 text-sm mt-4 h-6 opacity-0 transition-opacity font-bold">
                        <i class="fa-solid fa-circle-exclamation ml-1"></i> Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­
                    </p>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <button onclick="typePin('1')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">1</button>
                    <button onclick="typePin('2')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">2</button>
                    <button onclick="typePin('3')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">3</button>
                    <button onclick="typePin('4')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">4</button>
                    <button onclick="typePin('5')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">5</button>
                    <button onclick="typePin('6')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">6</button>
                    <button onclick="typePin('7')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">7</button>
                    <button onclick="typePin('8')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">8</button>
                    <button onclick="typePin('9')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">9</button>
                    <button onclick="clearPin()" class="h-20 rounded-2xl bg-rose-500/20 hover:bg-rose-500/40 text-rose-300 text-xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">
                        <i class="fa-solid fa-delete-left"></i>
                    </button>
                    <button onclick="typePin('0')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">0</button>
                    <button onclick="submitPin()" class="h-20 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white text-xl font-bold transition-all shadow-lg shadow-indigo-900/50 active:scale-95 flex items-center justify-center">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 4. DASHBOARD (Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)         -->
    <!-- ========================================== -->
    <div id="view-dashboard" class="hidden min-h-screen flex flex-col p-6 md:p-8 relative bg-slate-50">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-slate-50 rounded-2xl border-2 border-slate-100 flex items-center justify-center overflow-hidden shadow-inner relative group">
                    <img id="dash-logo" src="" alt="logo" class="w-full h-full object-contain hidden">
                    <span id="dash-logo-placeholder" class="text-3xl group-hover:scale-110 transition">ğŸ«</span>
                    <div class="absolute inset-0 bg-indigo-500/10 hidden group-hover:block transition"></div>
                </div>
                <div>
                    <h1 id="dash-school-name" class="text-2xl font-black text-slate-800 tracking-tight">Ù…Ø¯Ø±Ø³ØªÙŠ</h1>
                    <div class="flex items-center gap-3 mt-1">
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold border border-indigo-200" id="dash-year-badge">2025-2026</span>
                        <span class="flex items-center gap-1.5 text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100">
                            <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                            Ù…ØªØµÙ„
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="toggleFullScreen()" class="w-12 h-12 rounded-2xl bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 transition shadow-sm" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">
                    <i class="fa-solid fa-expand text-lg"></i>
                </button>
                
                <div class="bg-slate-50 px-5 py-3 rounded-2xl border border-slate-200 flex flex-col items-start min-w-[140px]">
                    <p id="current-user-name" class="font-bold text-sm text-slate-800">...</p>
                    <p id="current-user-role" class="text-[11px] text-indigo-600 font-black uppercase tracking-wide">...</p>
                </div>
                
                <button onclick="userLogout()" class="w-12 h-12 rounded-2xl bg-rose-50 text-rose-500 flex items-center justify-center hover:bg-rose-500 hover:text-white transition shadow-sm border border-rose-100" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬">
                    <i class="fa-solid fa-power-off text-lg"></i>
                </button>
            </div>
        </header>

        <!-- Dashboard Grid -->
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-10">
            
            <!-- Card: Receipts (Permission: receipts) -->
            <div id="card-receipts" onclick="checkPermissionAndNav('receipts')" class="dash-card bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-emerald-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-file-invoice-dollar"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</h2>
                    <p class="opacity-90 text-sm font-medium">ØªØ­ØµÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</p>
                </div>
                <div class="absolute bottom-6 left-6 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-4 group-hover:translate-y-0">
                    <i class="fa-solid fa-arrow-left text-2xl"></i>
                </div>
            </div>

            <!-- Card: Payments (Permission: payments) -->
            <div id="card-payments" onclick="checkPermissionAndNav('payments')" class="dash-card bg-gradient-to-br from-rose-500 to-pink-600 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-rose-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-money-bill-transfer"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø³Ù†Ø¯ Ø¯ÙØ¹</h2>
                    <p class="opacity-90 text-sm font-medium">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ù†Ø«Ø±ÙŠØ§Øª</p>
                </div>
            </div>

            <!-- Card: Parents (Permission: parents) -->
            <div id="card-parents" onclick="checkPermissionAndNav('parents')" class="dash-card bg-gradient-to-br from-indigo-600 to-blue-700 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-indigo-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-users-viewfinder"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</h2>
                    <p class="opacity-90 text-sm font-medium">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø§Ø¨</p>
                </div>
            </div>

            <!-- Card: Reports (Permission: reports) -->
            <div id="card-reports" onclick="checkPermissionAndNav('reports')" class="dash-card bg-gradient-to-br from-amber-500 to-orange-600 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-amber-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-chart-pie"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
                    <p class="opacity-90 text-sm font-medium">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                </div>
            </div>

            <!-- Card: Daily Closing (Permission: daily) -->
            <div id="card-daily" onclick="checkPermissionAndNav('daily')" class="dash-card bg-gradient-to-br from-cyan-600 to-sky-700 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-cyan-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-cash-register"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
                    <p class="opacity-90 text-sm font-medium">ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</p>
                </div>
            </div>

            <!-- Card: Logs (Permission: logs) -->
            <div id="card-logs" onclick="checkPermissionAndNav('logs')" class="dash-card bg-gradient-to-br from-purple-600 to-violet-700 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-purple-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h2>
                    <p class="opacity-90 text-sm font-medium">Ø³Ø¬Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
                </div>
            </div>

            <!-- Card: Settings (Admin Only) -->
            <div id="card-settings" onclick="checkPermissionAndNav('settings')" class="dash-card bg-gradient-to-br from-slate-800 to-slate-900 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-slate-300/50 lg:col-span-2 h-64 flex flex-col justify-between group border border-slate-700">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/5 rounded-full blur-3xl group-hover:bg-white/10 transition duration-700"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                        <i class="fa-solid fa-gears"></i>
                    </div>
                    <span class="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest border border-white/10">
                        Admin Only
                    </span>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
                    <p class="opacity-90 text-sm font-medium">Ø§Ù„Ø£Ø¹ÙˆØ§Ù…ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 5. MODULES HEADER                          -->
    <!-- ========================================== -->
    <div id="view-modules" class="hidden min-h-screen flex flex-col bg-slate-50">
        <!-- Module Header -->
        <div class="bg-white px-8 py-5 shadow-sm border-b border-slate-200 flex justify-between items-center sticky top-0 z-40 no-print">
            <div class="flex items-center gap-4">
                <h2 id="module-title" class="text-2xl font-black text-slate-800">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…</h2>
                <span id="module-year-badge" class="bg-slate-100 text-slate-600 px-4 py-1.5 rounded-xl text-xs font-bold border border-slate-200">2025-2026</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleFullScreen()" class="w-11 h-11 bg-slate-100 rounded-xl hover:bg-slate-200 flex items-center justify-center text-slate-600 transition">
                    <i class="fa-solid fa-expand"></i>
                </button>
                <button onclick="goHome()" class="flex items-center gap-2 bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg shadow-slate-300/50">
                    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                    <i class="fa-solid fa-house"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full custom-scroll overflow-y-auto">
            
            <!-- A. PARENTS MODULE -->
            <div id="mod-parents" class="module-view hidden space-y-8 fade-in">
                <!-- Add Family Form -->
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-600 to-blue-600 p-6 text-white flex justify-between items-center">
                        <h3 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-user-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø¹Ø§Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                        <span class="text-xs bg-white/20 px-3 py-1.5 rounded-lg border border-white/10">Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©</span>
                    </div>
                    <div class="p-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
                                <input type="text" id="parent-name" class="input-std" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input type="tel" id="parent-phone" class="input-std font-mono" placeholder="09XXXXXXXX">
                            </div>
                        </div>

                        <!-- Students Section -->
                        <div class="bg-slate-50 rounded-3xl p-6 border border-slate-200 mb-8">
                            <h4 class="font-bold text-slate-700 mb-5 flex items-center gap-2 text-lg">
                                <i class="fa-solid fa-children text-indigo-500"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
                            </h4>
                            <div class="flex flex-col md:flex-row gap-3 mb-4">
                                <input type="text" id="new-student-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="flex-[2] p-3.5 rounded-xl border-2 border-slate-200 outline-none focus:border-indigo-500 transition font-bold">
                                <input type="text" id="new-student-mother" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="flex-[1] p-3.5 rounded-xl border-2 border-slate-200 outline-none focus:border-pink-400 transition bg-pink-50/30 font-bold">
                                <select id="new-student-grade" class="flex-1 p-3.5 rounded-xl border-2 border-slate-200 outline-none focus:border-indigo-500 transition font-bold text-sm bg-white cursor-pointer"></select>
                                <button onclick="addTempStudent()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 rounded-xl font-bold transition shadow-lg shadow-indigo-200 flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                                </button>
                            </div>
                            <div id="temp-students-list" class="space-y-2 max-h-48 overflow-y-auto custom-scroll"></div>
                        </div>

                        <div class="flex flex-col md:flex-row justify-between items-center gap-6 pt-6 border-t border-slate-100">
                            <div class="text-center md:text-right">
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</p>
                                <p id="parent-total-calc" class="text-5xl font-black text-indigo-600 tracking-tight">
                                    0 <span class="text-lg text-slate-400 font-medium">Ø¯.Ù„</span>
                                </p>
                            </div>
                            <button onclick="saveFamily()" class="btn-action w-full md:w-auto text-lg">
                                <span>Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ÙˆÙ…Ø²Ø§Ù…Ù†Ø©</span>
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Parents Table -->
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 p-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <h3 class="font-bold text-slate-800 text-xl flex items-center gap-2">
                            <i class="fa-solid fa-list text-slate-400"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª
                        </h3>
                        <div class="relative w-full md:w-80">
                            <i class="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" oninput="filterParentsTable(this.value)" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." class="w-full p-4 pr-12 border-2 border-slate-200 rounded-2xl outline-none focus:border-indigo-500 transition font-bold">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto custom-scroll rounded-2xl border border-slate-100">
                        <table class="w-full text-right">
                            <thead class="bg-slate-50 text-slate-500 font-bold text-sm border-b border-slate-200">
                                <tr>
                                    <th class="p-5 rounded-tr-2xl">Ø§Ù„Ø±Ù‚Ù…</th>
                                    <th class="p-5">ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                                    <th class="p-5">Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th class="p-5 text-center">Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</th>
                                    <th class="p-5">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…</th>
                                    <th class="p-5">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                    <th class="p-5">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                    <th class="p-5 rounded-tl-2xl">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="parents-list-body" class="divide-y divide-slate-100 text-sm font-bold text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Parent Details Modal -->
            <div id="parent-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
                <div class="bg-white rounded-[2.5rem] max-w-4xl w-full max-h-[90vh] overflow-y-auto custom-scroll shadow-2xl border border-slate-100 transform transition-all scale-100">
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-blue-600 p-6 text-white flex justify-between items-center sticky top-0 z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-xl backdrop-blur-sm">
                                <i class="fa-solid fa-user-group"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold" id="modal-p-name">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3>
                                <p class="text-indigo-100 text-sm opacity-90">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ <span id="modal-p-year"></span></p>
                            </div>
                        </div>
                        <button onclick="closeParentModal()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl transition flex items-center justify-center">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <div class="p-8 space-y-8">
                        <!-- Info Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <span class="text-slate-400 text-xs font-bold uppercase block mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span>
                                <span id="modal-p-phone" class="font-bold text-lg text-slate-800 font-mono">---</span>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <span class="text-slate-400 text-xs font-bold uppercase block mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ</span>
                                <span id="modal-p-id" class="font-bold text-lg text-slate-800 font-mono">#---</span>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <span class="text-slate-400 text-xs font-bold uppercase block mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span>
                                <span id="modal-p-date" class="font-bold text-lg text-slate-800">---</span>
                            </div>
                        </div>

                        <!-- Students List with Edit -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                <h4 class="font-bold text-slate-700 flex items-center gap-2">
                                    <i class="fa-solid fa-graduation-cap text-indigo-500"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
                                </h4>
                                <button onclick="openStudentsEditModal()" class="text-sm bg-amber-100 text-amber-700 px-3 py-1.5 rounded-lg font-bold hover:bg-amber-200 transition">
                                    <i class="fa-solid fa-pen-to-square ml-1"></i> ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
                                </button>
                            </div>
                            <div id="modal-students-list" class="divide-y divide-slate-100"></div>
                        </div>

                        <!-- Financial Summary -->
                        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-2xl p-6 border border-indigo-100">
                            <h4 class="font-bold text-indigo-900 mb-6 flex items-center gap-2">
                                <i class="fa-solid fa-chart-line"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„ÙŠ
                            </h4>
                            <div class="grid grid-cols-3 gap-6 text-center">
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-indigo-100">
                                    <div class="text-xs text-slate-500 font-bold uppercase mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…</div>
                                    <div id="modal-p-total" class="text-2xl font-black text-slate-800">0</div>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100">
                                    <div class="text-xs text-emerald-600 font-bold uppercase mb-2">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                                    <div id="modal-p-paid" class="text-2xl font-black text-emerald-600">0</div>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-rose-100">
                                    <div class="text-xs text-rose-600 font-bold uppercase mb-2">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                                    <div id="modal-p-remaining" class="text-2xl font-black text-rose-600">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-4 pt-4">
                            <button onclick="openEditModal(currentParentId)" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-4 rounded-2xl font-bold text-lg transition shadow-lg shadow-amber-200 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                            </button>
                            <button onclick="deleteCurrentParent()" class="flex-1 bg-rose-500 hover:bg-rose-600 text-white py-4 rounded-2xl font-bold text-lg transition shadow-lg shadow-rose-200 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Students Modal (NEW) -->
            <div id="edit-students-modal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
                <div class="bg-white rounded-[2.5rem] max-w-3xl w-full max-h-[85vh] overflow-y-auto custom-scroll shadow-2xl border border-slate-100">
                    <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-6 text-white flex justify-between items-center sticky top-0 z-10">
                        <h3 class="text-xl font-bold"><i class="fa-solid fa-user-pen ml-2"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</h3>
                        <button onclick="closeStudentsEditModal()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl transition">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="p-8 space-y-6">
                        <div id="edit-students-list" class="space-y-3">
                            <!-- Students edit forms injected here -->
                        </div>
                        
                        <div class="border-t-2 border-dashed border-slate-200 pt-6 mt-6">
                            <h4 class="font-bold text-slate-700 mb-4">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ø§Ø¦Ù„Ø©</h4>
                            <div class="flex gap-3">
                                <input type="text" id="edit-new-student-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="input-std flex-1">
                                <input type="text" id="edit-new-student-mother" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ù…" class="input-std w-48">
                                <select id="edit-new-student-grade" class="input-std w-48 bg-white cursor-pointer"></select>
                                <button onclick="addStudentToExisting()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 rounded-xl font-bold shadow-lg shadow-emerald-200">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button onclick="saveStudentsEdit()" class="flex-1 btn-emerald py-3 text-lg">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                            <button onclick="closeStudentsEditModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold text-lg transition">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Parent Modal -->
            <div id="edit-parent-modal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
                <div class="bg-white rounded-[2.5rem] max-w-lg w-full p-8 shadow-2xl border border-slate-100 transform scale-100 transition-transform">
                    <h3 class="text-2xl font-black mb-8 text-slate-800 text-center">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3>
                    <input type="hidden" id="edit-p-id">
                    
                    <div class="space-y-6 mb-8">
                        <div>
                            <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
                            <input type="text" id="edit-p-name" class="input-std text-lg">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="tel" id="edit-p-phone" class="input-std font-mono text-lg">
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="saveParentEdit()" class="flex-1 btn-emerald py-3 text-lg shadow-lg shadow-emerald-200">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                        <button onclick="document.getElementById('edit-parent-modal').classList.add('hidden')" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold text-lg transition">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            </div>

            <!-- B. RECEIPTS MODULE -->
            <div id="mod-receipts" class="module-view hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Receipt Form -->
                    <div class="lg:col-span-2 bg-white rounded-[2.5rem] shadow-xl border border-emerald-100 p-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-50 rounded-full -translate-y-1/2 translate-x-1/3 blur-3xl opacity-50"></div>
                        
                        <h3 class="text-2xl font-black text-emerald-700 mb-8 flex items-center gap-3 relative z-10">
                            <i class="fa-solid fa-file-invoice"></i> Ø¥ØµØ¯Ø§Ø± Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ Ø¬Ø¯ÙŠØ¯
                        </h3>
                        
                        <!-- Search Parent -->
                        <div class="relative mb-8 z-10">
                            <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
                            <div class="relative">
                                <i class="fa-solid fa-magnifying-glass absolute right-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="rec-search" oninput="searchParent(this.value)" class="w-full p-5 pr-12 bg-slate-50 border-2 border-transparent focus:border-emerald-500 rounded-2xl outline-none font-bold text-lg transition-all shadow-inner" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±...">
                            </div>
                            <div id="rec-results" class="absolute w-full bg-white shadow-2xl rounded-2xl mt-3 max-h-60 overflow-y-auto z-30 hidden border border-slate-100 custom-scroll"></div>
                        </div>

                        <!-- Parent Info Card -->
                        <div id="rec-info-card" class="hidden bg-emerald-50 rounded-2xl p-6 border-2 border-emerald-100 mb-8 relative z-10 shadow-sm">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h4 id="rec-p-name" class="font-black text-xl text-emerald-900 mb-1">---</h4>
                                    <p class="text-sm text-emerald-600 font-bold">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: <span id="rec-p-id" class="font-mono">---</span></p>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100 text-center min-w-[120px]">
                                    <p class="text-[11px] text-slate-400 font-bold uppercase mb-1">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</p>
                                    <p id="rec-p-debt" class="text-3xl font-black text-rose-600">0</p>
                                </div>
                            </div>
                            <div class="bg-white/70 p-4 rounded-xl border border-emerald-100/50">
                                <p class="text-xs text-slate-500 mb-2 font-bold uppercase">Ø§Ù„Ø·Ù„Ø§Ø¨:</p>
                                <p id="rec-students-preview" class="text-sm font-bold text-slate-700"></p>
                            </div>
                        </div>

                        <!-- Amount & Method -->
                        <div class="space-y-6 relative z-10">
                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ØµÙŠÙ„Ù‡ (Ø¯.Ù„)</label>
                                <input type="number" id="rec-amount" class="input-std text-4xl font-black text-emerald-600 h-20 text-center shadow-inner" placeholder="0.00">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                                    <select id="rec-method" onchange="toggleBankInfo()" class="input-std h-16 bg-white cursor-pointer text-lg">
                                        <option value="Ù†Ù‚Ø¯Ø§Ù‹">Ù†Ù‚Ø¯Ø§Ù‹ ğŸ’µ</option>
                                        <option value="ØµÙƒ">ØµÙƒ Ø¨Ù†ÙƒÙŠ ğŸ“„</option>
                                        <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ ğŸ“²</option>
                                    </select>
                                </div>
                                <div id="bank-field" class="hidden">
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ / Ø§Ù„Ù…ØµØ±Ù</label>
                                    <input type="text" id="rec-ref" class="input-std h-16 text-lg" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù…Ø© - Ø±Ù‚Ù… 12345">
                                </div>
                            </div>

                            <button onclick="printReceipt()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-5 rounded-2xl font-black text-xl transition shadow-xl shadow-emerald-200 flex items-center justify-center gap-3 mt-4">
                                <i class="fa-solid fa-print"></i> Ø¥ØµØ¯Ø§Ø± ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ù†Ø¯
                            </button>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 p-8 h-fit">
                        <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2 text-lg">
                            <i class="fa-solid fa-clock-rotate-left text-slate-400"></i> Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¨Ø¶
                        </h3>
                        <ul id="recent-receipts-list" class="space-y-4 max-h-[600px] overflow-y-auto custom-scroll"></ul>
                    </div>
                </div>
            </div>

            <!-- C. PAYMENTS MODULE -->
            <div id="mod-payments" class="module-view hidden fade-in">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-[2.5rem] shadow-xl border border-rose-100 p-10 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-rose-500 to-pink-600"></div>
                        <div class="absolute -top-20 -right-20 w-64 h-64 bg-rose-50 rounded-full blur-3xl opacity-50"></div>
                        
                        <h3 class="text-3xl font-black text-rose-700 mb-10 flex items-center gap-3 relative z-10">
                            <i class="fa-solid fa-money-bill-wave"></i> Ø³Ù†Ø¯ ØµØ±Ù (Ù…ØµØ±ÙˆÙØ§Øª)
                        </h3>
                        
                        <div class="space-y-8 relative z-10">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ÙŠØµØ±Ù Ù„Ø£Ù…Ø± (Ø§Ù„Ø¬Ù‡Ø©/Ø§Ù„Ø´Ø®Øµ)</label>
                                    <input type="text" id="pay-to" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©" class="input-std text-xl font-bold h-16">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                    <select id="pay-cat" class="input-std bg-slate-50 cursor-pointer text-lg h-16">
                                        <option>Ø±ÙˆØ§ØªØ¨ Ù…ÙˆØ¸ÙÙŠÙ†</option>
                                        <option>ØµÙŠØ§Ù†Ø© ÙˆØªØ¬Ù‡ÙŠØ²Ø§Øª</option>
                                        <option>Ù†Ø«Ø±ÙŠØ§Øª ÙˆÙ…ØµØ§Ø±ÙŠÙ ØªØ´ØºÙŠÙ„</option>
                                        <option>Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ø¹Ø¯Ø§Øª</option>
                                        <option>ÙÙˆØ§ØªÙŠØ± Ù…Ø±Ø§ÙÙ‚ (ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…Ø§Ø¡)</option>
                                        <option>Ù…ØµØ§Ø±ÙŠÙ ØªØ³ÙˆÙŠÙ‚</option>
                                        <option>Ø£Ø®Ø±Ù‰</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ù…Ø¨Ù„Øº Ø§Ù„ØµØ±Ù (Ø¯.Ù„)</label>
                                <input type="number" id="pay-amount" class="input-std text-5xl font-black text-rose-600 h-24 text-center shadow-inner" placeholder="0.00">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø§Ù„Ø¨ÙŠØ§Ù† / Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
                                <input type="text" id="pay-reason" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„ØµØ±Ù Ùˆ Ø§Ù„ØªÙØ§ØµÙŠÙ„..." class="input-std h-16 text-lg">
                            </div>

                            <button onclick="printPayment()" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-5 rounded-2xl font-black text-xl transition shadow-xl shadow-rose-200 flex items-center justify-center gap-3 mt-4">
                                <i class="fa-solid fa-print"></i> ØµØ±Ù Ù…Ø¨Ù„Øº ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ù†Ø¯
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- D. REPORTS MODULE -->
            <div id="mod-reports" class="module-view hidden fade-in">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 no-print">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</p>
                            <h2 id="rep-total-in" class="text-3xl font-black text-emerald-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-600 text-2xl">
                            <i class="fa-solid fa-arrow-down"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                            <h2 id="rep-total-out" class="text-3xl font-black text-rose-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-rose-100 rounded-2xl flex items-center justify-center text-rose-600 text-2xl">
                            <i class="fa-solid fa-arrow-up"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</p>
                            <h2 id="rep-balance" class="text-3xl font-black text-indigo-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 text-2xl">
                            <i class="fa-solid fa-scale-balanced"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</p>
                            <h2 id="rep-total-debt" class="text-3xl font-black text-amber-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 text-2xl">
                            <i class="fa-solid fa-circle-exclamation"></i>
                        </div>
                    </div>
                </div>

                <!-- Debt Report -->
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8 mb-8">
                    <div class="flex justify-between items-center mb-8 no-print">
                        <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-file-contract text-slate-400"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©
                        </h3>
                        <button onclick="printReport()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center gap-2 transition shadow-lg">
                            <i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        </button>
                    </div>
                    <div id="report-print-area">
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200">
                                    <tr>
                                        <th class="p-4 rounded-tr-2xl">Ù…</th>
                                        <th class="p-4">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                                        <th class="p-4">Ø§Ù„Ù‡Ø§ØªÙ</th>
                                        <th class="p-4">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                                        <th class="p-4">Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„ÙƒÙ„ÙŠØ©</th>
                                        <th class="p-4">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                        <th class="p-4 text-rose-600 rounded-tl-2xl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø§Ù„Ø¯ÙŠÙ†)</th>
                                    </tr>
                                </thead>
                                <tbody id="report-debt-body" class="divide-y divide-slate-100 font-bold"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- E. DAILY CLOSING MODULE -->
            <div id="mod-daily" class="module-view hidden fade-in">
                <div class="max-w-5xl mx-auto">
                    <div class="bg-white rounded-[2.5rem] shadow-xl border border-cyan-100 p-8 mb-6 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-cyan-500 to-blue-600"></div>
                        
                        <div class="flex justify-between items-center mb-10 flex-wrap gap-4">
                            <div>
                                <h3 class="text-3xl font-black text-cyan-800 mb-2 flex items-center gap-3">
                                    <i class="fa-solid fa-cash-register text-cyan-600"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ
                                </h3>
                                <p class="text-slate-500" id="daily-date-display"></p>
                            </div>
                            <div class="flex gap-3 no-print">
                                <input type="date" id="daily-date-picker" onchange="loadDailyClosing()" class="input-std py-3 px-4 text-sm w-44">
                                <button onclick="printDailyClosing()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg shadow-cyan-200 flex items-center gap-2">
                                    <i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                            <!-- Income Column -->
                            <div class="bg-emerald-50 rounded-3xl p-6 border border-emerald-100">
                                <h4 class="font-bold text-emerald-800 mb-6 flex items-center gap-2 text-lg pb-4 border-b border-emerald-200">
                                    <i class="fa-solid fa-arrow-down text-emerald-600"></i> Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª (Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª)
                                </h4>
                                <div class="space-y-3 max-h-80 overflow-y-auto custom-scroll" id="daily-in-list"></div>
                                <div class="mt-6 pt-6 border-t-2 border-emerald-200 flex justify-between items-center">
                                    <span class="font-bold text-emerald-800 text-lg">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯</span>
                                    <span id="daily-in-total" class="text-2xl font-black text-emerald-700">0 Ø¯.Ù„</span>
                                </div>
                            </div>

                            <!-- Expenses Column -->
                            <div class="bg-rose-50 rounded-3xl p-6 border border-rose-100">
                                <h4 class="font-bold text-rose-800 mb-6 flex items-center gap-2 text-lg pb-4 border-b border-rose-200">
                                    <i class="fa-solid fa-arrow-up text-rose-600"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„ØµØ§Ø¯Ø±)
                                </h4>
                                <div class="space-y-3 max-h-80 overflow-y-auto custom-scroll" id="daily-out-list"></div>
                                <div class="mt-6 pt-6 border-t-2 border-rose-200 flex justify-between items-center">
                                    <span class="font-bold text-rose-800 text-lg">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§Ø¯Ø±</span>
                                    <span id="daily-out-total" class="text-2xl font-black text-rose-700">0 Ø¯.Ù„</span>
                                </div>
                            </div>
                        </div>

                        <!-- Net Total -->
                        <div class="bg-gradient-to-r from-cyan-50 to-blue-50 rounded-3xl p-8 border border-cyan-200 flex justify-between items-center shadow-inner">
                            <div>
                                <p class="text-lg text-cyan-800 font-bold mb-1">ØµØ§ÙÙŠ Ø­Ø±ÙƒØ© Ø§Ù„ÙŠÙˆÙ…</p>
                                <p class="text-sm text-cyan-600">Ø§Ù„ÙˆØ§Ø±Ø¯ - Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                            </div>
                            <div id="daily-net" class="text-5xl font-black text-cyan-700 tracking-tight">0 Ø¯.Ù„</div>
                        </div>
                    </div>

                    <!-- Daily Notes -->
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
                        <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-note-sticky text-amber-500"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ… (Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)
                        </h4>
                        <textarea id="daily-notes" class="w-full p-5 rounded-2xl border-2 border-slate-200 outline-none focus:border-cyan-500 transition resize-none h-40 text-lg font-medium" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø¹Ù† ÙŠÙˆÙ… Ø§Ù„Ø¹Ù…Ù„ Ù‡Ù†Ø§..."></textarea>
                        <div class="flex justify-end mt-4">
                            <button onclick="saveDailyNotes()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-cyan-200">
                                <i class="fa-solid fa-floppy-disk ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- F. LOGS MODULE -->
            <div id="mod-logs" class="module-view hidden fade-in">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <h3 class="font-bold text-2xl text-slate-800 flex items-center gap-3">
                            <i class="fa-solid fa-clock-rotate-left text-purple-600 text-3xl"></i> Ø³Ø¬Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                        </h3>
                        <div class="flex gap-3 w-full md:w-auto">
                            <div class="relative flex-1 md:w-64">
                                <i class="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="logs-search" oninput="filterLogs()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©..." class="w-full p-3 pr-12 border-2 border-slate-200 rounded-xl outline-none focus:border-purple-500 transition font-bold">
                            </div>
                            <select id="logs-filter" onchange="filterLogs()" class="input-std py-3 px-4 w-36 bg-white cursor-pointer">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                                <option value="in">Ù‚Ø¨Ø¶ ÙÙ‚Ø·</option>
                                <option value="out">ØµØ±Ù ÙÙ‚Ø·</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto custom-scroll max-h-[70vh] rounded-2xl border border-slate-100">
                        <table class="w-full text-right text-sm">
                            <thead class="bg-slate-50 text-slate-600 font-bold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-4">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th class="p-4">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                                    <th class="p-4">Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th class="p-4">Ø§Ù„Ø¬Ù‡Ø©/Ø§Ù„Ø§Ø³Ù…</th>
                                    <th class="p-4">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th class="p-4">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©/Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                    <th class="p-4">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                    <th class="p-4 text-center">Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-slate-100 font-bold text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- G. SETTINGS MODULE (Permissions & Backup) -->
            <div id="mod-settings" class="module-view hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- School Identity -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                        <h3 class="font-bold text-xl mb-8 text-indigo-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-school text-indigo-500"></i> Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                        </h3>
                        <div class="space-y-6">
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±Ø³Ù…ÙŠ</label>
                                <input type="text" id="set-school-name" class="input-std text-lg" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†ÙˆØ± Ø§Ù„Ø£Ù‡Ù„ÙŠØ©">
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Logo)</label>
                                <div class="flex items-center gap-4">
                                    <div id="logo-preview" class="w-24 h-24 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden">
                                        <span class="text-xs text-slate-400 text-center px-2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø¹Ø§Ø±</span>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" id="set-logo-file" accept="image/*" onchange="handleLogoUpload(this)" class="block w-full text-sm text-slate-600 file:mr-4 file:py-3 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer border-2 border-slate-200 rounded-xl p-2">
                                        <p class="text-xs text-slate-400 mt-2">ÙŠÙØ¶Ù„ ØµÙˆØ±Ø© Ù…Ø±Ø¨Ø¹Ø© Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© (PNG)</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="saveIdentity()" class="btn-action w-full py-4 text-lg shadow-lg shadow-indigo-200">
                                <i class="fa-solid fa-floppy-disk"></i> Ø­ÙØ¸ Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡Ø§
                            </button>
                        </div>
                    </div>

                    <!-- Backup & Restore System -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                        <h3 class="font-bold text-xl mb-8 text-emerald-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-cloud-arrow-up text-emerald-500"></i> Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯
                        </h3>
                        <div class="space-y-6">
                            
                            <!-- Export -->
                            <div class="p-6 bg-blue-50 rounded-2xl border border-blue-100">
                                <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-download"></i> ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                                </h4>
                                <p class="text-sm text-blue-700 mb-4">Ù‚Ù… Ø¨ØªÙ†Ø²ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙƒÙ…Ù„Ù JSON Ù…Ø­ÙÙˆØ¸ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
                                <button onclick="exportBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-blue-200 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-file-export"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                                </button>
                            </div>

                            <!-- Import -->
                            <div class="p-6 bg-amber-50 rounded-2xl border border-amber-100">
                                <h4 class="font-bold text-amber-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-upload"></i> Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                                </h4>
                                <p class="text-sm text-amber-700 mb-4">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON (ÙŠØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</p>
                                
                                <div class="space-y-3">
                                    <label class="flex items-center gap-2 p-3 bg-white rounded-xl border border-amber-200 cursor-pointer hover:bg-amber-50 transition">
                                        <i class="fa-solid fa-file-import text-amber-500 text-xl"></i>
                                        <span class="flex-1 text-sm font-bold text-amber-900">Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</span>
                                        <input type="file" id="restore-file" accept=".json" onchange="importBackup(this)" class="hidden">
                                    </label>
                                    
                                    <div id="restore-filename" class="text-sm text-slate-600 font-bold hidden">
                                        <i class="fa-solid fa-check-circle text-emerald-500 ml-1"></i> ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: <span id="selected-file-name"></span>
                                    </div>

                                    <button onclick="confirmRestore()" class="w-full bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-amber-200 flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-rotate"></i> Ø¨Ø¯Ø¡ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Years Management -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-8 text-indigo-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-calendar-days text-indigo-500"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹ÙˆØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØªØ±Ù‚ÙŠØ©
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                <h4 class="font-bold text-slate-700 mb-4">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø§Ù… Ø¬Ø¯ÙŠØ¯</h4>
                                <div class="flex gap-3">
                                    <input type="text" id="settings-new-year" placeholder="Ù…Ø«Ø§Ù„: 2026-2027" class="input-std text-sm flex-1">
                                    <button onclick="createYearFromSettings()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 rounded-xl font-bold shadow-lg shadow-indigo-200 transition">
                                        <i class="fa-solid fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                <h4 class="font-bold text-slate-700 mb-4">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù…Ù„</h4>
                                <select id="settings-current-year" onchange="switchYearFromSettings()" class="input-std text-sm bg-white cursor-pointer w-full"></select>
                            </div>
                        </div>

                        <!-- Student Promotion -->
                        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 p-8 rounded-3xl border border-emerald-100">
                            <h4 class="font-bold text-emerald-900 mb-6 text-lg flex items-center gap-2">
                                <i class="fa-solid fa-graduation-cap"></i> ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ
                            </h4>
                            <div class="flex items-center gap-4 flex-wrap">
                                <div class="flex-1 min-w-[200px]">
                                    <label class="text-xs font-bold text-slate-500 block mb-2">Ù…Ù† Ø§Ù„Ø¹Ø§Ù… (Ø§Ù„Ù…ØµØ¯Ø±)</label>
                                    <select id="promote-from-year" class="input-std text-sm bg-white cursor-pointer w-full"></select>
                                </div>
                                
                                <div class="text-2xl text-slate-400 pt-6">
                                    <i class="fa-solid fa-arrow-left"></i>
                                </div>
                                
                                <div class="flex-1 min-w-[200px]">
                                    <label class="text-xs font-bold text-slate-500 block mb-2">Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø§Ù… (Ø§Ù„ÙˆØ¬Ù‡Ø©)</label>
                                    <select id="promote-to-year" class="input-std text-sm bg-white cursor-pointer w-full"></select>
                                </div>
                                
                                <button onclick="promoteStudents()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-emerald-200 transition flex items-center gap-2 mt-6 md:mt-0">
                                    <i class="fa-solid fa-user-graduate"></i> ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨
                                </button>
                            </div>
                            <p class="text-sm text-emerald-700 mt-4 bg-white/50 p-3 rounded-xl">
                                <i class="fa-solid fa-circle-info ml-2"></i>
                                Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø¥Ù„Ù‰ ØµÙØ± Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            </p>
                        </div>
                    </div>

                    <!-- Grades Management -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-8 text-amber-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-tags text-amber-500"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø±Ø³ÙˆÙ…
                        </h3>
                        <div class="flex gap-3 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <input type="text" id="new-grade-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ (Ù…Ø«Ø§Ù„: Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„)" class="input-std text-sm flex-1 h-12">
                            <input type="number" id="new-grade-price" placeholder="Ø§Ù„Ø±Ø³ÙˆÙ…" class="input-std text-sm w-40 h-12">
                            <input type="number" id="new-grade-order" placeholder="Ø§Ù„ØªØ±ØªÙŠØ¨" class="input-std text-sm w-32 h-12" value="0">
                            <button onclick="addGrade()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 rounded-xl font-bold shadow-lg shadow-emerald-200 transition h-12 flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                            </button>
                        </div>
                        <div id="grades-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                    </div>

                    <!-- Users & Permissions Management -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-8 text-rose-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-users-gear text-rose-500"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                        </h3>
                        
                        <!-- Add User Form -->
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8">
                            <h4 class="font-bold text-slate-700 mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="text" id="new-u-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="input-std text-sm h-12">
                                <input type="password" id="new-u-pin" placeholder="Ø§Ù„Ø±Ù…Ø² (4 Ø£Ø±Ù‚Ø§Ù…)" class="input-std text-sm h-12 font-mono" maxlength="4">
                                <select id="new-u-role" class="input-std text-sm bg-white cursor-pointer h-12" onchange="togglePermissionsEditor()">
                                    <option value="staff">Ù…ÙˆØ¸Ù (Ù…Ø­Ø¯ÙˆØ¯)</option>
                                    <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… (ÙƒØ§Ù…Ù„)</option>
                                </select>
                                <button onclick="addNewUser()" class="bg-slate-800 hover:bg-slate-900 text-white rounded-xl font-bold shadow-lg transition h-12 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ©
                                </button>
                            </div>
                        </div>

                        <!-- Permissions Editor (for new staff) -->
                        <div id="permissions-editor" class="hidden mb-8 p-6 bg-indigo-50 rounded-2xl border border-indigo-100">
                            <h4 class="font-bold text-indigo-900 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-shield-halved"></i> ØªØ­Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-indigo-600 rounded" value="receipts" checked>
                                    <span class="font-bold text-slate-700">Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-rose-600 rounded" value="payments" checked>
                                    <span class="font-bold text-slate-700">Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-indigo-600 rounded" value="parents" checked>
                                    <span class="font-bold text-slate-700">Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-amber-600 rounded" value="reports" checked>
                                    <span class="font-bold text-slate-700">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-cyan-600 rounded" value="daily" checked>
                                    <span class="font-bold text-slate-700">Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-purple-600 rounded" value="logs" checked>
                                    <span class="font-bold text-slate-700">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</span>
                                </label>
                            </div>
                        </div>

                        <!-- Users Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-100 text-slate-600 font-bold border-b border-slate-200">
                                    <tr>
                                        <th class="p-4">Ø§Ù„Ø§Ø³Ù…</th>
                                        <th class="p-4">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                                        <th class="p-4">Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø³Ù…ÙˆØ­</th>
                                        <th class="p-4">Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„</th>
                                        <th class="p-4">Ø¥Ø¯Ø§Ø±Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="font-bold divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Excel Import -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-4 text-green-700 flex items-center gap-2">
                            <i class="fa-solid fa-file-excel text-green-600"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel
                        </h3>
                        <div class="p-6 bg-green-50 rounded-2xl border border-green-100">
                            <div class="flex items-center gap-4 mb-4">
                                <input type="file" accept=".xlsx,.xls" onchange="importExcel(this)" class="block w-full text-sm text-green-800 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 cursor-pointer">
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-green-200">
                                <p class="text-sm text-green-800 font-bold mb-2">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Ù…Ù„Ù Excel:</p>
                                <div class="flex flex-wrap gap-2 text-xs font-mono">
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">A: Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">B: Ø§Ù„Ù‡Ø§ØªÙ</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">C: Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">D: Ø§Ø³Ù… Ø§Ù„Ø£Ù…</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">E: Ø§Ù„ØµÙ</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">F: Ø§Ù„Ø±Ø³ÙˆÙ…</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Area -->
    <div id="print-area" class="hidden"></div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // ==========================================
        // GLOBAL VARIABLES & INITIALIZATION
        // ==========================================
        
        let currentUser = null;
        let currentParentId = null;
        let tempStudents = [];
        let pinBuffer = '';
        let selectedUserForPin = null;
        let restoreBuffer = null;
        
        // Database Structure
        window.db = {
            schoolName: 'Ù…Ø¯Ø±Ø³ØªÙŠ',
            logo: null,
            currentYear: '2025-2026',
            years: ['2025-2026'],
            users: [
                {id: 1, name: 'Ø§Ù„Ù…Ø¯ÙŠØ±', pin: '1234', role: 'admin', lastLogin: '-', permissions: ['all']}
            ],
            grades: [
                {id: 1, name: 'Ø±ÙŠØ§Ø¶ Ø§Ù„Ø£Ø·ÙØ§Ù„', price: 1500, order: 0},
                {id: 2, name: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„', price: 2000, order: 1},
                {id: 3, name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ', price: 2000, order: 2},
                {id: 4, name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«', price: 2500, order: 3}
            ]
        };
        
        window.yearData = {
            '2025-2026': {
                parents: [],
                transactions: [],
                dailyNotes: {}
            }
        };
        
        // ==========================================
        // AUTHENTICATION & LOGIN SYSTEM
        // ==========================================
        
        function signInWithGoogle() {
            document.getElementById('login-status').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('view-google-login').classList.add('hidden');
                document.getElementById('view-year-select').classList.remove('hidden');
                renderYearsGrid();
            }, 1500);
        }
        
        function renderYearsGrid() {
            const grid = document.getElementById('years-grid');
            grid.innerHTML = window.db.years.map(year => `
                <button onclick="selectYear('${year}')" class="p-6 bg-white border-2 border-slate-200 rounded-2xl hover:border-indigo-500 hover:bg-indigo-50 transition-all group text-center">
                    <div class="text-3xl mb-2">ğŸ“…</div>
                    <div class="font-bold text-slate-700 group-hover:text-indigo-700">${year}</div>
                </button>
            `).join('');
        }
        
        function selectYear(year) {
            window.db.currentYear = year;
            document.getElementById('view-year-select').classList.add('hidden');
            document.getElementById('view-pin-login').classList.remove('hidden');
            document.getElementById('current-year-display').textContent = year;
            renderLoginUsers();
        }
        
        function createNewYear() {
            const input = document.getElementById('new-year-input');
            const year = input.value.trim();
            if(year && !window.db.years.includes(year)) {
                window.db.years.push(year);
                window.yearData[year] = { parents: [], transactions: [], dailyNotes: {} };
                input.value = '';
                renderYearsGrid();
                showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            }
        }
        
        function changeYear() {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-modules').classList.add('hidden');
            document.getElementById('view-pin-login').classList.add('hidden');
            document.getElementById('view-year-select').classList.remove('hidden');
            renderYearsGrid();
        }
        
        function renderLoginUsers() {
            const container = document.getElementById('login-users-container');
            container.innerHTML = window.db.users.map(u => `
                <button onclick="selectUserForPin(${u.id})" class="w-full p-4 bg-white/10 hover:bg-white/20 border border-white/10 rounded-xl text-right transition flex items-center gap-3 group">
                    <div class="w-10 h-10 rounded-lg bg-indigo-500/30 flex items-center justify-center text-lg">
                        ${u.role === 'admin' ? 'ğŸ‘‘' : 'ğŸ‘¤'}
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-white">${u.name}</div>
                        <div class="text-xs text-indigo-200">${u.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…' : 'Ù…ÙˆØ¸Ù'}</div>
                    </div>
                    <i class="fa-solid fa-chevron-left text-white/50 group-hover:text-white transition"></i>
                </button>
            `).join('');
        }
        
        function selectUserForPin(userId) {
            selectedUserForPin = window.db.users.find(u => u.id === userId);
            document.getElementById('pin-target-name').textContent = selectedUserForPin.name;
            document.getElementById('pin-pad-area').classList.remove('opacity-50', 'pointer-events-none');
            clearPin();
        }
        
        function typePin(num) {
            if(pinBuffer.length < 4) {
                pinBuffer += num;
                updatePinDots();
            }
        }
        
        function clearPin() {
            pinBuffer = '';
            updatePinDots();
            document.getElementById('pin-error').style.opacity = '0';
        }
        
        function updatePinDots() {
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById(`pd-${i}`);
                if(i <= pinBuffer.length) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            }
        }
        
        function submitPin() {
            if(!selectedUserForPin) return;
            
            if(pinBuffer === selectedUserForPin.pin) {
                currentUser = selectedUserForPin;
                currentUser.lastLogin = new Date().toLocaleString('ar-LY');
                document.getElementById('view-pin-login').classList.add('hidden');
                initDashboard();
            } else {
                document.getElementById('pin-error').style.opacity = '1';
                setTimeout(clearPin, 1000);
            }
        }
        
        function fullLogout() {
            currentUser = null;
            selectedUserForPin = null;
            pinBuffer = '';
            document.getElementById('view-pin-login').classList.add('hidden');
            document.getElementById('view-google-login').classList.remove('hidden');
            document.getElementById('login-status').classList.add('hidden');
        }
        
        function userLogout() {
            currentUser = null;
            selectedUserForPin = null;
            pinBuffer = '';
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-modules').classList.add('hidden');
            document.getElementById('view-pin-login').classList.remove('hidden');
            clearPin();
        }
        
        // ==========================================
        // DASHBOARD & NAVIGATION
        // ==========================================
        
        function initDashboard() {
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('dash-school-name').textContent = window.db.schoolName;
            document.getElementById('dash-year-badge').textContent = window.db.currentYear;
            document.getElementById('current-user-name').textContent = currentUser.name;
            document.getElementById('current-user-role').textContent = currentUser.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…' : 'Ù…ÙˆØ¸Ù';
            
            if(window.db.logo) {
                document.getElementById('dash-logo').src = window.db.logo;
                document.getElementById('dash-logo').classList.remove('hidden');
                document.getElementById('dash-logo-placeholder').classList.add('hidden');
            }
            
            updatePermissions();
        }
        
        function updatePermissions() {
            const cards = ['receipts', 'payments', 'parents', 'reports', 'daily', 'logs', 'settings'];
            const isAdmin = currentUser.role === 'admin';
            
            cards.forEach(card => {
                const el = document.getElementById(`card-${card}`);
                if(card === 'settings' && !isAdmin) {
                    el.classList.add('disabled');
                } else if(!isAdmin && !currentUser.permissions.includes(card) && !currentUser.permissions.includes('all')) {
                    el.classList.add('disabled');
                } else {
                    el.classList.remove('disabled');
                }
            });
        }
        
        function checkPermissionAndNav(module) {
            const isAdmin = currentUser.role === 'admin';
            if(module === 'settings' && !isAdmin) {
                showToast('âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø­ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…');
                return;
            }
            if(!isAdmin && !currentUser.permissions.includes(module) && !currentUser.permissions.includes('all')) {
                showToast('âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©');
                return;
            }
            openModule(module);
        }
        
        function openModule(moduleName) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-modules').classList.remove('hidden');
            
            document.querySelectorAll('.module-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`mod-${moduleName}`).classList.remove('hidden');
            
            const titles = {
                parents: 'Ø¥Ø¯Ø§Ø±Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±',
                receipts: 'Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶',
                payments: 'Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù',
                reports: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
                daily: 'Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ',
                logs: 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª',
                settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©'
            };
            
            document.getElementById('module-title').textContent = titles[moduleName];
            document.getElementById('module-year-badge').textContent = window.db.currentYear;
            
            if(moduleName === 'parents') initParents();
            if(moduleName === 'receipts') initReceipts();
            if(moduleName === 'reports') initReports();
            if(moduleName === 'daily') initDaily();
            if(moduleName === 'logs') initLogs();
            if(moduleName === 'settings') initSettings();
        }
        
        function goHome() {
            document.getElementById('view-modules').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
        }
        
        function toggleFullScreen() {
            if(!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // ==========================================
        // PARENTS MODULE FUNCTIONS
        // ==========================================
        
        function getCurrentData() {
            return window.yearData[window.db.currentYear];
        }
        
        function initParents() {
            renderGradesSelect();
            renderParentsTable();
            tempStudents = [];
            updateTempStudentsList();
            document.getElementById('parent-name').value = '';
            document.getElementById('parent-phone').value = '';
            calculateTotal();
        }
        
        function renderGradesSelect() {
            const selects = ['new-student-grade', 'edit-new-student-grade'];
            const opts = window.db.grades.sort((a,b) => a.order - b.order).map(g => 
                `<option value="${g.name}" data-price="${g.price}">${g.name} (${g.price} Ø¯.Ù„)</option>`
            ).join('');
            
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = opts;
            });
        }
        
        function addTempStudent() {
            const name = document.getElementById('new-student-name').value.trim();
            const mother = document.getElementById('new-student-mother').value.trim();
            const gradeSelect = document.getElementById('new-student-grade');
            const grade = gradeSelect.value;
            const price = parseInt(gradeSelect.options[gradeSelect.selectedIndex].dataset.price) || 0;
            
            if(!name) return;
            
            tempStudents.push({
                id: Date.now(),
                name,
                mother: mother || '-',
                grade,
                price
            });
            
            document.getElementById('new-student-name').value = '';
            document.getElementById('new-student-mother').value = '';
            updateTempStudentsList();
            calculateTotal();
        }
        
        function removeTempStudent(id) {
            tempStudents = tempStudents.filter(s => s.id !== id);
            updateTempStudentsList();
            calculateTotal();
        }
        
        function updateTempStudentsList() {
            const list = document.getElementById('temp-students-list');
            if(tempStudents.length === 0) {
                list.innerHTML = '<p class="text-slate-400 text-center py-4 text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø¶Ø§ÙÙŠÙ† Ø¨Ø¹Ø¯</p>';
                return;
            }
            
            list.innerHTML = tempStudents.map(s => `
                <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-200">
                    <div>
                        <div class="font-bold text-slate-700">${s.name}</div>
                        <div class="text-xs text-slate-500">${s.grade} ${s.mother !== '-' ? '- Ø§Ù„Ø£Ù…: ' + s.mother : ''}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-indigo-600 text-sm">${s.price} Ø¯.Ù„</span>
                        <button onclick="removeTempStudent(${s.id})" class="w-8 h-8 bg-rose-50 text-rose-500 rounded-lg hover:bg-rose-500 hover:text-white transition flex items-center justify-center">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function calculateTotal() {
            const total = tempStudents.reduce((sum, s) => sum + s.price, 0);
            document.getElementById('parent-total-calc').innerHTML = `${total} <span class="text-lg text-slate-400 font-medium">Ø¯.Ù„</span>`;
        }
        
        function saveFamily() {
            const parentName = document.getElementById('parent-name').value.trim();
            const phone = document.getElementById('parent-phone').value.trim();
            
            if(!parentName || tempStudents.length === 0) {
                showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ÙˆØ¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            const totalFees = tempStudents.reduce((sum, s) => sum + s.price, 0);
            
            const family = {
                id: Date.now(),
                name: parentName,
                phone,
                students: [...tempStudents],
                totalFees,
                paid: 0,
                createdAt: new Date().toLocaleDateString('ar-LY')
            };
            
            getCurrentData().parents.push(family);
            saveToCloud();
            
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
            initParents();
        }
        
        function renderParentsTable() {
            const tbody = document.getElementById('parents-list-body');
            const parents = getCurrentData().parents;
            
            if(parents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø§Ø¦Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</td></tr>';
                return;
            }
            
            tbody.innerHTML = parents.map((p, idx) => {
                const remaining = p.totalFees - p.paid;
                return `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="p-5 font-mono text-slate-400">#${idx + 1}</td>
                        <td class="p-5 font-bold text-slate-800">${p.name}</td>
                        <td class="p-5 font-mono text-slate-600">${p.phone || '-'}</td>
                        <td class="p-5 text-center">
                            <span class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold">${p.students.length}</span>
                        </td>
                        <td class="p-5 font-bold text-slate-700">${p.totalFees.toLocaleString()}</td>
                        <td class="p-5 font-bold text-emerald-600">${p.paid.toLocaleString()}</td>
                        <td class="p-5 font-bold ${remaining > 0 ? 'text-rose-600' : 'text-emerald-600'}">${remaining.toLocaleString()}</td>
                        <td class="p-5">
                            <button onclick="openParentModal(${p.id})" class="bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white px-4 py-2 rounded-xl text-xs font-bold transition">
                                Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterParentsTable(query) {
            const rows = document.querySelectorAll('#parents-list-body tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }
        
        function openParentModal(parentId) {
            currentParentId = parentId;
            const p = getCurrentData().parents.find(x => x.id === parentId);
            if(!p) return;
            
            document.getElementById('modal-p-name').textContent = p.name;
            document.getElementById('modal-p-year').textContent = window.db.currentYear;
            document.getElementById('modal-p-phone').textContent = p.phone || '---';
            document.getElementById('modal-p-id').textContent = '#' + p.id;
            document.getElementById('modal-p-date').textContent = p.createdAt;
            
            document.getElementById('modal-students-list').innerHTML = p.students.map(s => `
                <div class="p-4 flex justify-between items-center hover:bg-slate-50">
                    <div>
                        <div class="font-bold text-slate-800">${s.name}</div>
                        <div class="text-xs text-slate-500">${s.grade} ${s.mother !== '-' ? '- Ø§Ù„Ø£Ù…: ' + s.mother : ''}</div>
                    </div>
                    <span class="font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg text-sm">${s.price} Ø¯.Ù„</span>
                </div>
            `).join('');
            
            const remaining = p.totalFees - p.paid;
            document.getElementById('modal-p-total').textContent = p.totalFees.toLocaleString() + ' Ø¯.Ù„';
            document.getElementById('modal-p-paid').textContent = p.paid.toLocaleString() + ' Ø¯.Ù„';
            document.getElementById('modal-p-remaining').textContent = remaining.toLocaleString() + ' Ø¯.Ù„';
            
            document.getElementById('parent-modal').classList.remove('hidden');
        }
        
        function closeParentModal() {
            document.getElementById('parent-modal').classList.add('hidden');
            currentParentId = null;
        }
        
        function openEditModal(parentId) {
            const p = getCurrentData().parents.find(x => x.id === parentId);
            if(!p) return;
            
            document.getElementById('edit-p-id').value = p.id;
            document.getElementById('edit-p-name').value = p.name;
            document.getElementById('edit-p-phone').value = p.phone;
            document.getElementById('edit-parent-modal').classList.remove('hidden');
        }
        
        function saveParentEdit() {
            const id = parseInt(document.getElementById('edit-p-id').value);
            const p = getCurrentData().parents.find(x => x.id === id);
            if(p) {
                p.name = document.getElementById('edit-p-name').value;
                p.phone = document.getElementById('edit-p-phone').value;
                saveToCloud();
                showToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                document.getElementById('edit-parent-modal').classList.add('hidden');
                openParentModal(id);
                renderParentsTable();
            }
        }
        
        function deleteCurrentParent() {
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŸ')) return;
            getCurrentData().parents = getCurrentData().parents.filter(p => p.id !== currentParentId);
            saveToCloud();
            closeParentModal();
            renderParentsTable();
            showToast('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©');
        }
        
        // ==========================================
        // RECEIPTS MODULE
        // ==========================================
        
        let selectedParentForReceipt = null;
        
        function initReceipts() {
            document.getElementById('rec-search').value = '';
            document.getElementById('rec-results').classList.add('hidden');
            document.getElementById('rec-info-card').classList.add('hidden');
            document.getElementById('rec-amount').value = '';
            document.getElementById('rec-ref').value = '';
            selectedParentForReceipt = null;
            loadRecentReceipts();
        }
        
        function searchParent(query) {
            const results = document.getElementById('rec-results');
            if(!query) {
                results.classList.add('hidden');
                return;
            }
            
            const matches = getCurrentData().parents.filter(p => 
                p.name.includes(query) || (p.phone && p.phone.includes(query))
            );
            
            if(matches.length === 0) {
                results.innerHTML = '<div class="p-4 text-slate-400 text-center text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
            } else {
                results.innerHTML = matches.map(p => `
                    <button onclick="selectParentForReceipt(${p.id})" class="w-full p-4 text-right hover:bg-slate-50 border-b border-slate-100 last:border-0 transition flex justify-between items-center">
                        <div>
                            <div class="font-bold text-slate-700">${p.name}</div>
                            <div class="text-xs text-slate-500">${p.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø§ØªÙ'}</div>
                        </div>
                        <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600">${p.students.length} Ø·Ù„Ø§Ø¨</span>
                    </button>
                `).join('');
            }
            results.classList.remove('hidden');
        }
        
        function selectParentForReceipt(parentId) {
            selectedParentForReceipt = getCurrentData().parents.find(p => p.id === parentId);
            document.getElementById('rec-results').classList.add('hidden');
            document.getElementById('rec-info-card').classList.remove('hidden');
            
            document.getElementById('rec-p-name').textContent = selectedParentForReceipt.name;
            document.getElementById('rec-p-id').textContent = selectedParentForReceipt.id;
            const debt = selectedParentForReceipt.totalFees - selectedParentForReceipt.paid;
            document.getElementById('rec-p-debt').textContent = debt.toLocaleString();
            document.getElementById('rec-students-preview').textContent = selectedParentForReceipt.students.map(s => s.name).join('ØŒ ');
        }
        
        function toggleBankInfo() {
            const method = document.getElementById('rec-method').value;
            const bankField = document.getElementById('bank-field');
            if(method === 'Ù†Ù‚Ø¯Ø§Ù‹') {
                bankField.classList.add('hidden');
            } else {
                bankField.classList.remove('hidden');
            }
        }
        
        function printReceipt() {
            if(!selectedParentForReceipt) {
                showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const amount = parseInt(document.getElementById('rec-amount').value);
            if(!amount || amount <= 0) {
                showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }
            
            const method = document.getElementById('rec-method').value;
            const ref = document.getElementById('rec-ref').value;
            
            // Update parent balance
            selectedParentForReceipt.paid += amount;
            
            // Create transaction
            const tx = {
                id: Date.now(),
                type: 'in',
                parentId: selectedParentForReceipt.id,
                parentName: selectedParentForReceipt.name,
                amount,
                method,
                ref: ref || '-',
                date: new Date().toLocaleString('ar-LY'),
                user: currentUser.name
            };
            
            getCurrentData().transactions.push(tx);
            saveToCloud();
            
            // Print
            const printContent = `
                <div style="padding: 40px; font-family: 'Tajawal', sans-serif; direction: rtl; text-align: center;">
                    <h1 style="font-size: 24px; margin-bottom: 20px;">${window.db.schoolName}</h1>
                    <h2 style="font-size: 20px; color: #059669; margin-bottom: 30px;">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ Ø±Ø³Ù…ÙŠ</h2>
                    <div style="border: 2px solid #e2e8f0; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: right;">
                        <p style="margin: 10px 0;"><strong>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</strong> #${tx.id}</p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${tx.date}</p>
                        <p style="margin: 10px 0;"><strong>Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù†:</strong> ${selectedParentForReceipt.name}</p>
                        <p style="margin: 10px 0;"><strong>Ù…Ø¨Ù„Øº:</strong> ${amount.toLocaleString()} Ø¯.Ù„</p>
                        <p style="margin: 10px 0;"><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${method} ${ref ? '- ' + ref : ''}</p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${currentUser.name}</p>
                    </div>
                    <p style="font-size: 12px; color: #94a3b8; margin-top: 40px;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§</p>
                </div>
            `;
            
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = printContent;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ ÙˆØ·Ø¨Ø§Ø¹ØªÙ‡');
            initReceipts();
        }
        
        function loadRecentReceipts() {
            const txs = getCurrentData().transactions.filter(t => t.type === 'in').slice(-10).reverse();
            const list = document.getElementById('recent-receipts-list');
            
            if(txs.length === 0) {
                list.innerHTML = '<p class="text-slate-400 text-center text-sm py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©</p>';
                return;
            }
            
            list.innerHTML = txs.map(t => `
                <li class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                    <div>
                        <div class="font-bold text-slate-700 text-sm">${t.parentName}</div>
                        <div class="text-xs text-slate-400">${t.date.split(' ')[0]}</div>
                    </div>
                    <span class="font-bold text-emerald-600">${t.amount.toLocaleString()} Ø¯.Ù„</span>
                </li>
            `).join('');
        }
        
        // ==========================================
        // PAYMENTS MODULE
        // ==========================================
        
        function printPayment() {
            const to = document.getElementById('pay-to').value.trim();
            const amount = parseInt(document.getElementById('pay-amount').value);
            const cat = document.getElementById('pay-cat').value;
            const reason = document.getElementById('pay-reason').value;
            
            if(!to || !amount) {
                showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© ÙˆØ§Ù„Ù…Ø¨Ù„Øº');
                return;
            }
            
            const tx = {
                id: Date.now(),
                type: 'out',
                to,
                amount,
                category: cat,
                reason: reason || '-',
                date: new Date().toLocaleString('ar-LY'),
                user: currentUser.name
            };
            
            getCurrentData().transactions.push(tx);
            saveToCloud();
            
            // Print
            const printContent = `
                <div style="padding: 40px; font-family: 'Tajawal', sans-serif; direction: rtl; text-align: center;">
                    <h1 style="font-size: 24px; margin-bottom: 20px;">${window.db.schoolName}</h1>
                    <h2 style="font-size: 20px; color: #e11d48; margin-bottom: 30px;">Ø³Ù†Ø¯ ØµØ±Ù / Ø¯ÙØ¹</h2>
                    <div style="border: 2px solid #e2e8f0; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: right;">
                        <p style="margin: 10px 0;"><strong>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</strong> #${tx.id}</p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${tx.date}</p>
                        <p style="margin: 10px 0;"><strong>ÙŠØµØ±Ù Ù„Ø£Ù…Ø±:</strong> ${to}</p>
                        <p style="margin: 10px 0;"><strong>Ù…Ø¨Ù„Øº:</strong> ${amount.toLocaleString()} Ø¯.Ù„</p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„Ø¨ÙŠØ§Ù†:</strong> ${cat} - ${reason}</p>
                        <p style="margin: 10px 0;"><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${currentUser.name}</p>
                    </div>
                </div>
            `;
            
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = printContent;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ ÙˆØ·Ø¨Ø§Ø¹ØªÙ‡');
            document.getElementById('pay-to').value = '';
            document.getElementById('pay-amount').value = '';
            document.getElementById('pay-reason').value = '';
        }
        
        // ==========================================
        // REPORTS MODULE
        // ==========================================
        
        function initReports() {
            const data = getCurrentData();
            const totalIn = data.transactions.filter(t => t.type === 'in').reduce((sum, t) => sum + t.amount, 0);
            const totalOut = data.transactions.filter(t => t.type === 'out').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIn - totalOut;
            const totalDebt = data.parents.reduce((sum, p) => sum + (p.totalFees - p.paid), 0);
            
            document.getElementById('rep-total-in').textContent = totalIn.toLocaleString() + ' Ø¯.Ù„';
            document.getElementById('rep-total-out').textContent = totalOut.toLocaleString() + ' Ø¯.Ù„';
            document.getElementById('rep-balance').textContent = balance.toLocaleString() + ' Ø¯.Ù„';
            document.getElementById('rep-total-debt').textContent = totalDebt.toLocaleString() + ' Ø¯.Ù„';
            
            const tbody = document.getElementById('report-debt-body');
            const debtors = data.parents.filter(p => (p.totalFees - p.paid) > 0);
            
            if(debtors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…Ø³ØªØ­Ù‚Ø© ğŸ‰</td></tr>';
            } else {
                tbody.innerHTML = debtors.map((p, idx) => {
                    const remaining = p.totalFees - p.paid;
                    return `
                        <tr>
                            <td class="p-4">${idx + 1}</td>
                            <td class="p-4 font-bold">${p.name}</td>
                            <td class="p-4 font-mono text-xs">${p.phone || '-'}</td>
                            <td class="p-4">${p.students.length}</td>
                            <td class="p-4">${p.totalFees.toLocaleString()}</td>
                            <td class="p-4 text-emerald-600">${p.paid.toLocaleString()}</td>
                            <td class="p-4 text-rose-600 font-bold">${remaining.toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
            }
        }
        
        function printReport() {
            window.print();
        }
        
        // ==========================================
        // DAILY CLOSING MODULE
        // ==========================================
        
        function initDaily() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('daily-date-picker').value = today;
            loadDailyClosing();
        }
        
        function loadDailyClosing() {
            const date = document.getElementById('daily-date-picker').value;
            const data = getCurrentData();
            const dateStr = new Date(date).toLocaleDateString('ar-LY');
            document.getElementById('daily-date-display').textContent = dateStr;
            
            // Filter transactions for selected date
            const dayTxs = data.transactions.filter(t => t.date.includes(dateStr));
            const inTxs = dayTxs.filter(t => t.type === 'in');
            const outTxs = dayTxs.filter(t => t.type === 'out');
            
            // Income List
            const inList = document.getElementById('daily-in-list');
            if(inTxs.length === 0) {
                inList.innerHTML = '<p class="text-slate-400 text-center py-4 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ§Ø±Ø¯Ø§Øª</p>';
            } else {
                inList.innerHTML = inTxs.map(t => `
                    <div class="flex justify-between items-center p-3 bg-white rounded-xl border border-emerald-100">
                        <div>
                            <div class="font-bold text-slate-700 text-sm">${t.parentName}</div>
                            <div class="text-xs text-slate-400">${t.method}</div>
                        </div>
                        <span class="font-bold text-emerald-600">${t.amount.toLocaleString()} Ø¯.Ù„</span>
                    </div>
                `).join('');
            }
            
            // Expenses List
            const outList = document.getElementById('daily-out-list');
            if(outTxs.length === 0) {
                outList.innerHTML = '<p class="text-slate-400 text-center py-4 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</p>';
            } else {
                outList.innerHTML = outTxs.map(t => `
                    <div class="flex justify-between items-center p-3 bg-white rounded-xl border border-rose-100">
                        <div>
                            <div class="font-bold text-slate-700 text-sm">${t.to}</div>
                            <div class="text-xs text-slate-400">${t.category}</div>
                        </div>
                        <span class="font-bold text-rose-600">${t.amount.toLocaleString()} Ø¯.Ù„</span>
                    </div>
                `).join('');
            }
            
            // Totals
            const inTotal = inTxs.reduce((sum, t) => sum + t.amount, 0);
            const outTotal = outTxs.reduce((sum, t) => sum + t.amount, 0);
            const net = inTotal - outTotal;
            
            document.getElementById('daily-in-total').textContent = inTotal.toLocaleString() + ' Ø¯.Ù„';
            document.getElementById('daily-out-total').textContent = outTotal.toLocaleString() + ' Ø¯.Ù„';
            document.getElementById('daily-net').textContent = net.toLocaleString() + ' Ø¯.Ù„';
            
            // Load notes
            document.getElementById('daily-notes').value = data.dailyNotes[date] || '';
        }
        
        function saveDailyNotes() {
            const date = document.getElementById('daily-date-picker').value;
            const notes = document.getElementById('daily-notes').value;
            getCurrentData().dailyNotes[date] = notes;
            saveToCloud();
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª');
        }
        
        function printDailyClosing() {
            window.print();
        }
        
        // ==========================================
        // LOGS MODULE
        // ==========================================
        
        function initLogs() {
            renderLogsTable();
        }
        
        function renderLogsTable() {
            const tbody = document.getElementById('logs-table-body');
            const txs = [...getCurrentData().transactions].reverse();
            
            if(txs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                return;
            }
            
            tbody.innerHTML = txs.map(t => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4 font-mono text-xs">#${t.id.toString().slice(-6)}</td>
                    <td class="p-4 text-xs">${t.date}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${t.type === 'in' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}">
                            ${t.type === 'in' ? 'Ù‚Ø¨Ø¶' : 'ØµØ±Ù'}
                        </span>
                    </td>
                    <td class="p-4 font-bold">${t.parentName || t.to}</td>
                    <td class="p-4 font-bold ${t.type === 'in' ? 'text-emerald-600' : 'text-rose-600'}">
                        ${t.amount.toLocaleString()} Ø¯.Ù„
                    </td>
                    <td class="p-4 text-xs text-slate-500">${t.method || t.category}</td>
                    <td class="p-4 text-xs">${t.user}</td>
                    <td class="p-4 text-center">
                        <button onclick="reprintTransaction(${t.id})" class="text-indigo-600 hover:text-indigo-800">
                            <i class="fa-solid fa-print"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterLogs() {
            const query = document.getElementById('logs-search').value.toLowerCase();
            const type = document.getElementById('logs-filter').value;
            const rows = document.querySelectorAll('#logs-table-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowType = row.querySelector('td:nth-child(3)').textContent.includes('Ù‚Ø¨Ø¶') ? 'in' : 'out';
                
                const matchesText = text.includes(query);
                const matchesType = type === 'all' || type === rowType;
                
                row.style.display = matchesText && matchesType ? '' : 'none';
            });
        }
        
        function reprintTransaction(txId) {
            const t = getCurrentData().transactions.find(x => x.id === txId);
            if(!t) return;
            
            let printContent = '';
            if(t.type === 'in') {
                printContent = `
                    <div style="padding: 40px; font-family: 'Tajawal', sans-serif; direction: rtl; text-align: center;">
                        <h1>${window.db.schoolName}</h1>
                        <h2 style="color: #059669;">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ (Ù†Ø³Ø®Ø©)</h2>
                        <div style="border: 2px solid #e2e8f0; padding: 20px; text-align: right; margin: 20px 0;">
                            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</strong> #${t.id}</p>
                            <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${t.date}</p>
                            <p><strong>Ù…Ù†:</strong> ${t.parentName}</p>
                            <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${t.amount.toLocaleString()} Ø¯.Ù„</p>
                            <p><strong>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©:</strong> ${t.method}</p>
                        </div>
                    </div>
                `;
            } else {
                printContent = `
                    <div style="padding: 40px; font-family: 'Tajawal', sans-serif; direction: rtl; text-align: center;">
                        <h1>${window.db.schoolName}</h1>
                        <h2 style="color: #e11d48;">Ø³Ù†Ø¯ ØµØ±Ù (Ù†Ø³Ø®Ø©)</h2>
                        <div style="border: 2px solid #e2e8f0; padding: 20px; text-align: right; margin: 20px 0;">
                            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</strong> #${t.id}</p>
                            <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${t.date}</p>
                            <p><strong>Ø¥Ù„Ù‰:</strong> ${t.to}</p>
                            <p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${t.amount.toLocaleString()} Ø¯.Ù„</p>
                            <p><strong>Ø§Ù„Ø¨ÙŠØ§Ù†:</strong> ${t.category}</p>
                        </div>
                    </div>
                `;
            }
            
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = printContent;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
        }
        
        // ==========================================
        // SETTINGS MODULE
        // ==========================================
        
        function initSettings() {
            document.getElementById('set-school-name').value = window.db.schoolName;
            if(window.db.logo) {
                document.getElementById('logo-preview').innerHTML = `<img src="${window.db.logo}" style="width:100%;height:100%;object-fit:contain;">`;
            }
            renderGrades();
            renderUsersTable();
            
            const yearOpts = window.db.years.map(y => `<option value="${y}">${y}</option>`).join('');
            document.getElementById('settings-current-year').innerHTML = yearOpts;
            document.getElementById('settings-current-year').value = window.db.currentYear;
            document.getElementById('promote-from-year').innerHTML = yearOpts;
            document.getElementById('promote-to-year').innerHTML = yearOpts;
        }
        
        function saveIdentity() {
            window.db.schoolName = document.getElementById('set-school-name').value;
            document.getElementById('dash-school-name').textContent = window.db.schoolName;
            saveToCloud();
            showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‡ÙˆÙŠØ©');
        }
        
        function handleLogoUpload(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    window.db.logo = e.target.result;
                    document.getElementById('logo-preview').innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:contain;">`;
                    document.getElementById('dash-logo').src = e.target.result;
                    document.getElementById('dash-logo').classList.remove('hidden');
                    document.getElementById('dash-logo-placeholder').classList.add('hidden');
                    saveToCloud();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function addGrade() {
            const name = document.getElementById('new-grade-name').value.trim();
            const price = parseInt(document.getElementById('new-grade-price').value);
            const order = parseInt(document.getElementById('new-grade-order').value) || 0;
            
            if(!name || !price) {
                showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ ÙˆØ§Ù„Ø±Ø³ÙˆÙ…');
                return;
            }
            
            window.db.grades.push({
                id: Date.now(),
                name,
                price,
                order
            });
            
            saveToCloud();
            renderGrades();
            showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ');
            
            document.getElementById('new-grade-name').value = '';
            document.getElementById('new-grade-price').value = '';
        }
        
        function renderGrades() {
            const list = document.getElementById('grades-list');
            const sorted = [...window.db.grades].sort((a,b) => a.order - b.order);
            
            list.innerHTML = sorted.map(g => `
                <div class="flex justify-between items-center bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-white rounded-lg flex items-center justify-center font-bold text-slate-400 border border-slate-200">${g.order}</span>
                        <span class="font-bold text-slate-700">${g.name}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-indigo-600 bg-white px-3 py-1 rounded-lg border border-slate-200">${g.price} Ø¯.Ù„</span>
                        <button onclick="deleteGrade(${g.id})" class="w-8 h-8 bg-rose-50 text-rose-500 rounded-lg hover:bg-rose-500 hover:text-white transition flex items-center justify-center">
                            <i class="fa-solid fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function deleteGrade(id) {
            window.db.grades = window.db.grades.filter(g => g.id !== id);
            saveToCloud();
            renderGrades();
        }
        
        function togglePermissionsEditor() {
            const role = document.getElementById('new-u-role').value;
            const editor = document.getElementById('permissions-editor');
            editor.classList.toggle('hidden', role !== 'staff');
        }
        
        function addNewUser() {
            const name = document.getElementById('new-u-name').value.trim();
            const pin = document.getElementById('new-u-pin').value;
            const role = document.getElementById('new-u-role').value;
            
            if(!name || pin.length !== 4) {
                showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø³Ø±ÙŠ Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…');
                return;
            }
            
            let permissions = ['all'];
            if(role === 'staff') {
                permissions = Array.from(document.querySelectorAll('.perm-check:checked')).map(cb => cb.value);
                if(permissions.length === 0) {
                    showToast('âš ï¸ Ø§Ø®ØªØ± ØµÙ„Ø§Ø­ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                    return;
                }
            }
            
            window.db.users.push({
                id: Date.now(),
                name,
                pin,
                role,
                permissions,
                lastLogin: '-'
            });
            
            saveToCloud();
            renderUsersTable();
            showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            
            document.getElementById('new-u-name').value = '';
            document.getElementById('new-u-pin').value = '';
        }
        
        function renderUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = window.db.users.map(u => {
                const permLabels = {
                    receipts: 'Ù‚Ø¨Ø¶',
                    payments: 'ØµØ±Ù',
                    parents: 'Ø¹Ø§Ø¦Ù„Ø§Øª',
                    reports: 'ØªÙ‚Ø§Ø±ÙŠØ±',
                    daily: 'Ø¥ØºÙ„Ø§Ù‚',
                    logs: 'Ø³Ø¬Ù„Ø§Øª'
                };
                
                const permText = u.role === 'admin' 
                    ? '<span class="text-emerald-600 font-bold">ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>'
                    : u.permissions.map(p => `<span class="inline-block bg-slate-100 px-2 py-1 rounded text-xs ml-1">${permLabels[p] || p}</span>`).join('');
                
                return `
                    <tr>
                        <td class="p-4 font-bold">${u.name}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-xs font-bold ${u.role === 'admin' ? 'bg-rose-100 text-rose-700' : 'bg-blue-100 text-blue-700'}">
                                ${u.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ù…ÙˆØ¸Ù'}
                            </span>
                        </td>
                        <td class="p-4 text-xs">${permText}</td>
                        <td class="p-4 text-xs text-slate-400">${u.lastLogin}</td>
                        <td class="p-4">
                            ${u.id !== currentUser.id ? 
                                `<button onclick="deleteUser(${u.id})" class="text-rose-600 hover:text-rose-800 text-xs font-bold">Ø­Ø°Ù</button>` 
                                : '<span class="text-xs text-slate-400">Ø£Ù†Øª</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function deleteUser(id) {
            if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
            window.db.users = window.db.users.filter(u => u.id !== id);
            saveToCloud();
            renderUsersTable();
        }
        
        function createYearFromSettings() {
            const year = document.getElementById('settings-new-year').value.trim();
            if(!year || window.db.years.includes(year)) {
                showToast('âš ï¸ Ø§Ù„Ø¹Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­');
                return;
            }
            window.db.years.push(year);
            window.yearData[year] = { parents: [], transactions: [], dailyNotes: {} };
            saveToCloud();
            initSettings();
            showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…');
        }
        
        function switchYearFromSettings() {
            window.db.currentYear = document.getElementById('settings-current-year').value;
            document.getElementById('dash-year-badge').textContent = window.db.currentYear;
            document.getElementById('module-year-badge').textContent = window.db.currentYear;
            saveToCloud();
            showToast('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ');
        }
        
        function promoteStudents() {
            const from = document.getElementById('promote-from-year').value;
            const to = document.getElementById('promote-to-year').value;
            
            if(from === to) {
                showToast('âš ï¸ Ø§Ø®ØªØ± Ø¹Ø§Ù…ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†');
                return;
            }
            
            const sourceData = window.yearData[from];
            if(!sourceData || sourceData.parents.length === 0) {
                showToast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…ØµØ¯Ø±');
                return;
            }
            
            if(!confirm(`Ø³ÙŠØªÙ… Ù†Ù‚Ù„ ${sourceData.parents.length} Ø¹Ø§Ø¦Ù„Ø© Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to} Ù…Ø¹ ØªØµÙÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) return;
            
            const promoted = sourceData.parents.map(p => ({
                ...p,
                id: Date.now() + Math.random(),
                paid: 0,
                promotedFrom: from,
                createdAt: new Date().toLocaleDateString('ar-LY')
            }));
            
            window.yearData[to].parents = [...window.yearData[to].parents, ...promoted];
            saveToCloud();
            showToast(`âœ… ØªÙ… ØªØ±Ù‚ÙŠØ© ${promoted.length} Ø¹Ø§Ø¦Ù„Ø©`);
        }
        
        // ==========================================
        // BACKUP & RESTORE
        // ==========================================
        
        function exportBackup() {
            const backup = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                global: window.db,
                years: window.yearData,
                exportedBy: currentUser.name
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
            const link = document.createElement('a');
            link.setAttribute("href", dataStr);
            link.setAttribute("download", `backup_${window.db.schoolName}_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(link);
            link.click();
            link.remove();
            
            showToast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
        }
        
        function importBackup(input) {
            if(!input.files[0]) return;
            document.getElementById('selected-file-name').textContent = input.files[0].name;
            document.getElementById('restore-filename').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    restoreBuffer = JSON.parse(e.target.result);
                    showToast('âœ… Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯');
                } catch(err) {
                    showToast('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');
                }
            };
            reader.readAsText(input.files[0]);
        }
        
        function confirmRestore() {
            if(!restoreBuffer) {
                showToast('âš ï¸ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if(!confirm('âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
            if(!confirm('ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            
            try {
                if(restoreBuffer.global) window.db = restoreBuffer.global;
                if(restoreBuffer.years) window.yearData = restoreBuffer.years;
                saveToCloud();
                showToast('âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                setTimeout(() => location.reload(), 1500);
            } catch(err) {
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯');
            }
        }
        
        function importExcel(input) {
            if(!input.files[0]) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    let count = 0;
                    for(let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if(!row[0]) continue;
                        
                        let parent = getCurrentData().parents.find(p => p.name === row[0]);
                        if(!parent) {
                            parent = {
                                id: Date.now() + i,
                                name: row[0],
                                phone: row[1] ? row[1].toString() : '',
                                students: [],
                                totalFees: 0,
                                paid: 0,
                                createdAt: new Date().toLocaleDateString('ar-LY')
                            };
                            getCurrentData().parents.push(parent);
                        }
                        
                        const price = parseInt(row[5]) || 0;
                        parent.students.push({
                            name: row[2] || 'Ø·Ø§Ù„Ø¨',
                            mother: row[3] || '-',
                            grade: row[4] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                            price: price
                        });
                        parent.totalFees += price;
                        count++;
                    }
                    
                    saveToCloud();
                    showToast(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ø·Ø§Ù„Ø¨`);
                } catch(err) {
                    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
                }
            };
            reader.readAsArrayBuffer(input.files[0]);
        }
        
        // ==========================================
        // CLOUD SYNC SIMULATION
        // ==========================================
        
        function saveToCloud() {
            // In a real app, this would save to Firebase/Google Drive
            // For now, we simulate cloud save with localStorage
            try {
                localStorage.setItem('school_finance_db', JSON.stringify(window.db));
                localStorage.setItem('school_finance_years', JSON.stringify(window.yearData));
                console.log('ğŸ’¾ Saved to cloud simulation');
                return true;
            } catch(e) {
                console.error('Save failed:', e);
                return false;
            }
        }
        
        function loadFromCloud() {
            try {
                const savedDb = localStorage.getItem('school_finance_db');
                const savedYears = localStorage.getItem('school_finance_years');
                
                if(savedDb) window.db = JSON.parse(savedDb);
                if(savedYears) window.yearData = JSON.parse(savedYears);
                
                console.log('â˜ï¸ Loaded from cloud simulation');
            } catch(e) {
                console.error('Load failed:', e);
            }
        }
        
        // ==========================================
        // EDIT STUDENTS MODAL FUNCTIONS
        // ==========================================
        
        let editingStudents = [];
        
        function openStudentsEditModal() {
            const p = getCurrentData().parents.find(x => x.id === currentParentId);
            if(!p) return;
            
            editingStudents = [...p.students];
            renderEditStudentsList();
            renderGradesSelect();
            document.getElementById('edit-students-modal').classList.remove('hidden');
        }
        
        function closeStudentsEditModal() {
            document.getElementById('edit-students-modal').classList.add('hidden');
            editingStudents = [];
        }
        
        function renderEditStudentsList() {
            const list = document.getElementById('edit-students-list');
            if(editingStudents.length === 0) {
                list.innerHTML = '<p class="text-center text-slate-400 py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</p>';
                return;
            }
            
            list.innerHTML = editingStudents.map((s, idx) => `
                <div class="flex gap-3 items-center bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <input type="text" value="${s.name}" onchange="updateStudentName(${idx}, this.value)" class="flex-1 p-2 rounded-lg border border-slate-200 font-bold">
                    <input type="text" value="${s.mother}" onchange="updateStudentMother(${idx}, this.value)" class="w-32 p-2 rounded-lg border border-slate-200" placeholder="Ø§Ù„Ø£Ù…">
                    <select onchange="updateStudentGrade(${idx}, this.value)" class="p-2 rounded-lg border border-slate-200 bg-white">
                        ${window.db.grades.map(g => `<option value="${g.name}" ${g.name === s.grade ? 'selected' : ''}>${g.name}</option>`).join('')}
                    </select>
                    <button onclick="removeEditingStudent(${idx})" class="w-10 h-10 bg-rose-50 text-rose-500 rounded-lg hover:bg-rose-500 hover:text-white transition">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function updateStudentName(idx, val) { editingStudents[idx].name = val; }
        function updateStudentMother(idx, val) { editingStudents[idx].mother = val; }
        function updateStudentGrade(idx, val) { 
            editingStudents[idx].grade = val; 
            const grade = window.db.grades.find(g => g.name === val);
            if(grade) editingStudents[idx].price = grade.price;
        }
        function removeEditingStudent(idx) {
            editingStudents.splice(idx, 1);
            renderEditStudentsList();
        }
        
        function addStudentToExisting() {
            const name = document.getElementById('edit-new-student-name').value.trim();
            const mother = document.getElementById('edit-new-student-mother').value.trim();
            const gradeSelect = document.getElementById('edit-new-student-grade');
            const grade = gradeSelect.value;
            const gradeObj = window.db.grades.find(g => g.name === grade);
            const price = gradeObj ? gradeObj.price : 0;
            
            if(!name) return;
            
            editingStudents.push({
                id: Date.now(),
                name,
                mother: mother || '-',
                grade,
                price
            });
            
            document.getElementById('edit-new-student-name').value = '';
            document.getElementById('edit-new-student-mother').value = '';
            renderEditStudentsList();
        }
        
        function saveStudentsEdit() {
            const p = getCurrentData().parents.find(x => x.id === currentParentId);
            if(p) {
                p.students = editingStudents;
                p.totalFees = editingStudents.reduce((sum, s) => sum + s.price, 0);
                saveToCloud();
                closeStudentsEditModal();
                openParentModal(currentParentId);
                renderParentsTable();
                showToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨');
            }
        }
        
        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        window.onload = function() {
            loadFromCloud();
            
            // Close modals on outside click
            window.onclick = function(e) {
                const modal = document.getElementById('parent-modal');
                if(e.target === modal) closeParentModal();
            };
        };
    </script>
</body>
</html>