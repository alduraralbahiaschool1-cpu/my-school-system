<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูููุธููุฉ ุงููุงููุฉ ุงููุชูุงููุฉ - ูุธุงู ุงูุฃูุงู ูุงูุตูุงุญูุงุช</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --font-main: 'Tajawal', sans-serif; 
            --primary-color: #4f46e5;
            --secondary-color: #6366f1;
        }
        
        * {
            font-family: var(--font-main);
        }
        
        body { 
            background-color: #f1f5f9; 
            overflow-x: hidden;
            direction: rtl;
        }
        
        /* Glassmorphism Effects */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        
        /* Input Styling */
        .input-std { 
            width: 100%;
            padding: 1rem;
            border-radius: 1rem;
            border: 2px solid #e2e8f0;
            background-color: #ffffff;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #1e293b;
            outline: none;
        }
        
        .input-std:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }
        
        /* Button Styles */
        .btn-action { 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            font-weight: 700;
            padding: 1rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px -5px rgba(79, 70, 229, 0.4);
        }
        
        .btn-action:active {
            transform: translateY(0);
        }
        
        .btn-emerald { 
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-rose { 
            background: linear-gradient(135deg, #e11d48 0%, #f43f5e 100%);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(225, 29, 72, 0.25);
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        /* Dashboard Cards */
        .dash-card { 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .dash-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .dash-card:hover::before {
            opacity: 1;
        }
        
        .dash-card:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 25px 40px -5px rgba(0, 0, 0, 0.2); 
        }
        
        .dash-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(0.8);
        }
        
        /* Animations */
        .fade-in { 
            animation: fadeIn 0.5s ease-out forwards; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* PIN Dots */
        .pin-dot { 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            border: 2px solid #94a3b8; 
            transition: all 0.2s; 
            background: transparent;
        }
        
        .pin-dot.active { 
            background-color: #4f46e5; 
            border-color: #4f46e5; 
            transform: scale(1.3); 
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
        }
        
        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { 
            width: 8px; 
        }
        
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .custom-scroll::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 8px;
            border: 2px solid #f1f5f9;
        }
        
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* Print Styles */
        @media print {
            body * { 
                visibility: hidden; 
            }
            #print-area, #print-area * { 
                visibility: visible; 
            }
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                height: 100%; 
            }
            @page { 
                size: A5 landscape; 
                margin: 0; 
            }
            .no-print { 
                display: none !important; 
            }
        }
        
        /* Permission Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        
        /* Student Edit List */
        .student-edit-item {
            transition: all 0.2s;
        }
        .student-edit-item:hover {
            background-color: #f8fafc;
            transform: translateX(-5px);
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col antialiased">

    <!-- ========================================== -->
    <!-- 1. GOOGLE LOGIN LAYER (ุงููุญูุฏ ุงููุชุงุญ)     -->
    <!-- ========================================== -->
    <div id="view-google-login" class="fixed inset-0 z-[70] bg-slate-900 flex flex-col items-center justify-center p-6 text-center">
        <div class="bg-white p-12 rounded-[3rem] shadow-2xl max-w-md w-full fade-in relative overflow-hidden border border-slate-200">
            <!-- Header Decoration -->
            <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
            
            <!-- Logo Icon -->
            <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center text-5xl mb-8 mx-auto text-indigo-600 shadow-inner ring-4 ring-white">
                ๐ซ
            </div>
            
            <h1 class="text-4xl font-black text-slate-800 mb-3 tracking-tight">ุงูููุธููุฉ ุงูุณุญุงุจูุฉ</h1>
            <p class="text-slate-500 mb-10 font-medium text-lg">ูุธุงู ูุงูู ูุชูุงูู ูุน ุญูุงูุฉ Google Cloud</p>
            
            <!-- Google Sign In Button -->
            <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 text-slate-700 font-bold py-5 px-6 rounded-2xl transition-all shadow-sm group mb-6">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 group-hover:scale-110 transition duration-300">
                <span class="text-lg">ุชุณุฌูู ุงูุฏุฎูู ุจุญุณุงุจ Google</span>
            </button>
            
            <div class="flex items-center gap-3 mb-6">
                <div class="h-px bg-slate-200 flex-1"></div>
                <span class="text-slate-400 text-sm font-bold">ุจูุงูุงุช ุงูุฏุฎูู ุงูุงูุชุฑุงุถูุฉ</span>
                <div class="h-px bg-slate-200 flex-1"></div>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                <p class="text-sm text-slate-600 mb-2">
                    <span class="font-bold text-indigo-600">ุงููุณุชุฎุฏู:</span> admin
                </p>
                <p class="text-sm text-slate-600">
                    <span class="font-bold text-indigo-600">ุงูุฑูุฒ:</span> 1111
                </p>
                <p class="text-xs text-slate-400 mt-3">ูุชู ุฅูุดุงุก ูุฐุง ุงููุณุชุฎุฏู ุชููุงุฆูุงู ุนูุฏ ุฃูู ุฏุฎูู</p>
            </div>
            
            <!-- Status Message -->
            <p id="login-status" class="mt-8 text-sm text-indigo-600 font-black animate-pulse hidden">
                <i class="fa-solid fa-circle-notch fa-spin ml-2"></i>
                ุฌุงุฑู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช...
            </p>
        </div>
        
        <div class="mt-8 text-slate-500 text-sm">
            <p>ยฉ 2025 ุงููุธุงู ุงููุงูู ุงููุชูุงูู - ุฌููุน ุงูุญููู ูุญููุธุฉ</p>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 2. YEAR SELECTION LAYER                    -->
    <!-- ========================================== -->
    <div id="view-year-select" class="hidden fixed inset-0 z-[60] bg-slate-900 flex flex-col items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl max-w-5xl w-full fade-in max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-black text-slate-800 mb-3">ุงุฎุชูุงุฑ ุงูุนุงู ุงูุฏุฑุงุณู</h2>
                <p class="text-slate-500">ุงุฎุชุฑ ุงูุนุงู ููุนูู ุนููู (ูุชู ูุตู ุงูุจูุงูุงุช ุจุงููุงูู ุญุณุจ ุงูุนุงู)</p>
            </div>
            
            <div id="years-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-10">
                <!-- Years will be injected here -->
            </div>
            
            <div class="border-t-2 border-slate-100 pt-8">
                <h3 class="font-bold text-slate-700 mb-4 text-center">ุฅูุดุงุก ุนุงู ุฏุฑุงุณู ุฌุฏูุฏ</h3>
                <div class="flex gap-4 justify-center max-w-md mx-auto">
                    <input type="text" id="new-year-input" placeholder="ูุซุงู: 2026-2027" class="input-std text-center flex-1">
                    <button onclick="createNewYear()" class="btn-emerald whitespace-nowrap">
                        <i class="fa-solid fa-plus ml-2"></i>ุฅูุดุงุก
                    </button>
                </div>
                <p class="text-center text-xs text-slate-400 mt-4">ุนูุฏ ุฅูุดุงุก ุนุงู ุฌุฏูุฏุ ููููู ุชุฑููุฉ ุงูุทูุงุจ ูู ุงูุนุงู ุงูุณุงุจู</p>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 3. PIN LOGIN LAYER                         -->
    <!-- ========================================== -->
    <div id="view-pin-login" class="hidden fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-6">
        <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
            <!-- Left Side: Info -->
            <div class="space-y-8 text-white">
                <div>
                    <div class="flex items-center gap-4 mb-6 opacity-90 flex-wrap">
                        <span class="w-3 h-3 bg-emerald-400 rounded-full animate-pulse"></span>
                        <span class="text-sm font-mono bg-slate-800 px-3 py-1 rounded-lg" id="cloud-email-display"> waiting...</span>
                        <span id="current-year-display" class="bg-indigo-600 px-4 py-1.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-500/30">2025-2026</span>
                        <button onclick="changeYear()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg text-indigo-200 transition border border-white/10">
                            <i class="fa-solid fa-rotate ml-1"></i>ุชุบููุฑ ุงูุนุงู
                        </button>
                    </div>
                    
                    <h1 class="text-6xl font-black mb-6 leading-tight drop-shadow-2xl">
                        ุงูููุธููุฉ<br>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">ุงููุงููุฉ ุงููุชูุงููุฉ</span>
                    </h1>
                    
                    <p class="text-slate-400 text-xl font-light">ูุธุงู ุฅุฏุงุฑุฉ ูุงูู ูุชุนุฏุฏ ุงูุฃุนูุงู ุงูุฏุฑุงุณูุฉ</p>
                </div>
                
                <!-- Users List -->
                <div class="bg-white/5 backdrop-blur-xl border border-white/10 p-6 rounded-3xl shadow-2xl">
                    <h3 class="font-bold mb-5 text-indigo-200 flex items-center gap-3 text-lg">
                        <i class="fa-solid fa-users-viewfinder bg-indigo-500/20 p-2 rounded-lg"></i>
                        ุงุฎุชุฑ ุงููุณุชุฎุฏู:
                    </h3>
                    <div id="login-users-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-72 overflow-y-auto custom-scroll pr-2">
                        <!-- Users injected here -->
                    </div>
                </div>
                
                <button onclick="fullLogout()" class="text-white/60 hover:text-white text-sm font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket rotate-180"></i>
                    ุชุณุฌูู ุฎุฑูุฌ ูุงูู ูู ุงููุธุงู
                </button>
            </div>
            
            <!-- Right Side: PIN Pad -->
            <div id="pin-pad-area" class="bg-white/10 backdrop-blur-2xl border border-white/10 p-10 rounded-[3.5rem] shadow-2xl opacity-50 pointer-events-none transition-all duration-500 max-w-md mx-auto w-full">
                <div class="text-center mb-10">
                    <p id="pin-target-name" class="text-white font-bold mb-8 text-2xl">ุงุฎุชุฑ ูุณุชุฎุฏูุงู ููุฏุฎูู</p>
                    <div class="flex justify-center gap-5 dir-ltr mb-2">
                        <div class="pin-dot" id="pd-1"></div>
                        <div class="pin-dot" id="pd-2"></div>
                        <div class="pin-dot" id="pd-3"></div>
                        <div class="pin-dot" id="pd-4"></div>
                    </div>
                    <p id="pin-error" class="text-rose-400 text-sm mt-4 h-6 opacity-0 transition-opacity font-bold">
                        <i class="fa-solid fa-circle-exclamation ml-1"></i>ุฑูุฒ ุบูุฑ ุตุญูุญ
                    </p>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <button onclick="typePin('1')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">1</button>
                    <button onclick="typePin('2')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">2</button>
                    <button onclick="typePin('3')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">3</button>
                    <button onclick="typePin('4')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">4</button>
                    <button onclick="typePin('5')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">5</button>
                    <button onclick="typePin('6')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">6</button>
                    <button onclick="typePin('7')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">7</button>
                    <button onclick="typePin('8')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">8</button>
                    <button onclick="typePin('9')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">9</button>
                    <button onclick="clearPin()" class="h-20 rounded-2xl bg-rose-500/20 hover:bg-rose-500/40 text-rose-300 text-xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">
                        <i class="fa-solid fa-delete-left"></i>
                    </button>
                    <button onclick="typePin('0')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">0</button>
                    <button onclick="submitPin()" class="h-20 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white text-xl font-bold transition-all shadow-lg shadow-indigo-900/50 active:scale-95 flex items-center justify-center">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- ========================================== -->
    <!-- 4. DASHBOARD (ูุน ูุธุงู ุงูุตูุงุญูุงุช)          -->
    <!-- ========================================== -->
    <div id="view-dashboard" class="hidden min-h-screen flex flex-col p-6 md:p-8 relative bg-slate-50">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-slate-50 rounded-2xl border-2 border-slate-100 flex items-center justify-center overflow-hidden shadow-inner relative group">
                    <img id="dash-logo" src="" alt="logo" class="w-full h-full object-contain hidden">
                    <span id="dash-logo-placeholder" class="text-3xl group-hover:scale-110 transition">๐ซ</span>
                    <div class="absolute inset-0 bg-indigo-500/10 hidden group-hover:block transition"></div>
                </div>
                <div>
                    <h1 id="dash-school-name" class="text-2xl font-black text-slate-800 tracking-tight">ูุฏุฑุณุชู</h1>
                    <div class="flex items-center gap-3 mt-1">
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold border border-indigo-200" id="dash-year-badge">2025-2026</span>
                        <span class="flex items-center gap-1.5 text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100">
                            <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                            ูุชุตู
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="toggleFullScreen()" class="w-12 h-12 rounded-2xl bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 transition shadow-sm" title="ููุก ุงูุดุงุดุฉ">
                    <i class="fa-solid fa-expand text-lg"></i>
                </button>
                
                <div class="bg-slate-50 px-5 py-3 rounded-2xl border border-slate-200 flex flex-col items-start min-w-[140px]">
                    <p id="current-user-name" class="font-bold text-sm text-slate-800">...</p>
                    <p id="current-user-role" class="text-[11px] text-indigo-600 font-black uppercase tracking-wide">...</p>
                </div>
                
                <button onclick="userLogout()" class="w-12 h-12 rounded-2xl bg-rose-50 text-rose-500 flex items-center justify-center hover:bg-rose-500 hover:text-white transition shadow-sm border border-rose-100" title="ุชุณุฌูู ุฎุฑูุฌ">
                    <i class="fa-solid fa-power-off text-lg"></i>
                </button>
            </div>
        </header>

        <!-- Dashboard Grid -->
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-10">
            
            <!-- Card: Receipts (Permission: receipts) -->
            <div id="card-receipts" onclick="checkPermissionAndNav('receipts')" class="dash-card bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-emerald-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-file-invoice-dollar"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">ุณูุฏ ูุจุถ</h2>
                    <p class="opacity-90 text-sm font-medium">ุชุญุตูู ุงูุฑุณูู ูุฅุตุฏุงุฑ ุงูุฅูุตุงูุงุช</p>
                </div>
                <div class="absolute bottom-6 left-6 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-4 group-hover:translate-y-0">
                    <i class="fa-solid fa-arrow-left text-2xl"></i>
                </div>
            </div>

            <!-- Card: Payments (Permission: payments) -->
            <div id="card-payments" onclick="checkPermissionAndNav('payments')" class="dash-card bg-gradient-to-br from-rose-500 to-pink-600 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-rose-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-money-bill-transfer"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">ุณูุฏ ุฏูุน</h2>
                    <p class="opacity-90 text-sm font-medium">ุงููุตุฑููุงุช ูุงูุฑูุงุชุจ ูุงููุซุฑูุงุช</p>
                </div>
            </div>

            <!-- Card: Parents (Permission: parents) -->
            <div id="card-parents" onclick="checkPermissionAndNav('parents')" class="dash-card bg-gradient-to-br from-indigo-600 to-blue-700 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-indigo-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-users-viewfinder"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">ุฃูููุงุก ุงูุฃููุฑ</h2>
                    <p class="opacity-90 text-sm font-medium">ุฅุฏุงุฑุฉ ุงูุนุงุฆูุงุช ูุงูุทูุงุจ</p>
                </div>
            </div>

            <!-- Card: Reports (Permission: reports) -->
            <div id="card-reports" onclick="checkPermissionAndNav('reports')" class="dash-card bg-gradient-to-br from-amber-500 to-orange-600 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-amber-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-chart-pie"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">ุงูุชูุงุฑูุฑ</h2>
                    <p class="opacity-90 text-sm font-medium">ูุดู ุญุณุงุจ ูุงูุฏููู ูุงูุฅุญุตุงุฆูุงุช</p>
                </div>
            </div>

            <!-- Card: Daily Closing (Permission: daily) -->
            <div id="card-daily" onclick="checkPermissionAndNav('daily')" class="dash-card bg-gradient-to-br from-cyan-600 to-sky-700 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-cyan-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-cash-register"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">ุงูุฅุบูุงู ุงููููู</h2>
                    <p class="opacity-90 text-sm font-medium">ุชูุฑูุฑ ููุงูุฉ ุงูููู ูุงูููุงุญุธุงุช</p>
                </div>
            </div>

            <!-- Card: Logs (Permission: logs) -->
            <div id="card-logs" onclick="checkPermissionAndNav('logs')" class="dash-card bg-gradient-to-br from-purple-600 to-violet-700 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-purple-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">ุงูุณุฌูุงุช</h2>
                    <p class="opacity-90 text-sm font-medium">ุณุฌู ุฌููุน ุงูููุงุชูุฑ ูุงูุนูููุงุช</p>
                </div>
            </div>

            <!-- Card: Settings (Admin Only) -->
            <div id="card-settings" onclick="checkPermissionAndNav('settings')" class="dash-card bg-gradient-to-br from-slate-800 to-slate-900 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-slate-300/50 lg:col-span-2 h-64 flex flex-col justify-between group border border-slate-700">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/5 rounded-full blur-3xl group-hover:bg-white/10 transition duration-700"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                        <i class="fa-solid fa-gears"></i>
                    </div>
                    <span class="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest border border-white/10">
                        Admin Only
                    </span>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ</h2>
                    <p class="opacity-90 text-sm font-medium">ุงูุฃุนูุงูุ ุงููุณุชุฎุฏูููุ ุงูุตูุงุญูุงุชุ ุงููุณุฎ ุงูุงุญุชูุงุทู</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 5. MODULES CONTAINER                       -->
    <!-- ========================================== -->
    <div id="view-modules" class="hidden min-h-screen flex flex-col bg-slate-50">
        <!-- Module Header -->
        <div class="bg-white px-8 py-5 shadow-sm border-b border-slate-200 flex justify-between items-center sticky top-0 z-40 no-print">
            <div class="flex items-center gap-4">
                <h2 id="module-title" class="text-2xl font-black text-slate-800">ุนููุงู ุงููุณู</h2>
                <span id="module-year-badge" class="bg-slate-100 text-slate-600 px-4 py-1.5 rounded-xl text-xs font-bold border border-slate-200">2025-2026</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleFullScreen()" class="w-11 h-11 bg-slate-100 rounded-xl hover:bg-slate-200 flex items-center justify-center text-slate-600 transition">
                    <i class="fa-solid fa-expand"></i>
                </button>
                <button onclick="goHome()" class="flex items-center gap-2 bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg shadow-slate-300/50">
                    <span>ุงูุฑุฆูุณูุฉ</span>
                    <i class="fa-solid fa-house"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full custom-scroll overflow-y-auto">
            
            <!-- A. PARENTS MODULE -->
            <div id="mod-parents" class="module-view hidden space-y-8 fade-in">
                <!-- Add Family Form -->
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-600 to-blue-600 p-6 text-white flex justify-between items-center">
                        <h3 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-user-plus"></i> ุชุณุฌูู ุนุงุฆูุฉ ุฌุฏูุฏุฉ</h3>
                        <span class="text-xs bg-white/20 px-3 py-1.5 rounded-lg border border-white/10">ุงูุญูุธ ุงูุชููุงุฆู ููุณุญุงุจุฉ</span>
                    </div>
                    <div class="p-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ุงุณู ููู ุงูุฃูุฑ</label>
                                <input type="text" id="parent-name" class="input-std" placeholder="ุงูุงุณู ุงูุฑุจุงุนู ูุงููุงู">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ุฑูู ุงููุงุชู</label>
                                <input type="tel" id="parent-phone" class="input-std font-mono" placeholder="09XXXXXXXX">
                            </div>
                        </div>

                        <!-- Students Section -->
                        <div class="bg-slate-50 rounded-3xl p-6 border border-slate-200 mb-8">
                            <h4 class="font-bold text-slate-700 mb-5 flex items-center gap-2 text-lg">
                                <i class="fa-solid fa-children text-indigo-500"></i> ุจูุงูุงุช ุงูุฃุจูุงุก
                            </h4>
                            <div class="flex flex-col md:flex-row gap-3 mb-4">
                                <input type="text" id="new-student-name" placeholder="ุงุณู ุงูุทุงูุจ" class="flex-[2] p-3.5 rounded-xl border-2 border-slate-200 outline-none focus:border-indigo-500 transition font-bold">
                                <input type="text" id="new-student-mother" placeholder="ุงุณู ุงูุฃู (ุงุฎุชูุงุฑู)" class="flex-[1] p-3.5 rounded-xl border-2 border-slate-200 outline-none focus:border-pink-400 transition bg-pink-50/30 font-bold">
                                <select id="new-student-grade" class="flex-1 p-3.5 rounded-xl border-2 border-slate-200 outline-none focus:border-indigo-500 transition font-bold text-sm bg-white cursor-pointer"></select>
                                <button onclick="addTempStudent()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 rounded-xl font-bold transition shadow-lg shadow-indigo-200 flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ
                                </button>
                            </div>
                            <div id="temp-students-list" class="space-y-2 max-h-48 overflow-y-auto custom-scroll"></div>
                        </div>

                        <div class="flex flex-col md:flex-row justify-between items-center gap-6 pt-6 border-t border-slate-100">
                            <div class="text-center md:text-right">
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">ุฅุฌูุงูู ุงูุฑุณูู ุงููุณุชุญูุฉ</p>
                                <p id="parent-total-calc" class="text-5xl font-black text-indigo-600 tracking-tight">
                                    0 <span class="text-lg text-slate-400 font-medium">ุฏ.ู</span>
                                </p>
                            </div>
                            <button onclick="saveFamily()" class="btn-action w-full md:w-auto text-lg">
                                <span>ุญูุธ ุงูุนุงุฆูุฉ ููุฒุงููุฉ</span>
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Parents Table -->
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 p-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <h3 class="font-bold text-slate-800 text-xl flex items-center gap-2">
                            <i class="fa-solid fa-list text-slate-400"></i> ูุงุนุฏุฉ ุจูุงูุงุช ุงูุนุงุฆูุงุช
                        </h3>
                        <div class="relative w-full md:w-80">
                            <i class="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" oninput="filterParentsTable(this.value)" placeholder="ุจุญุซ ุจุงูุงุณู ุฃู ุงููุงุชู..." class="w-full p-4 pr-12 border-2 border-slate-200 rounded-2xl outline-none focus:border-indigo-500 transition font-bold">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto custom-scroll rounded-2xl border border-slate-100">
                        <table class="w-full text-right">
                            <thead class="bg-slate-50 text-slate-500 font-bold text-sm border-b border-slate-200">
                                <tr>
                                    <th class="p-5 rounded-tr-2xl">ุงูุฑูู</th>
                                    <th class="p-5">ููู ุงูุฃูุฑ</th>
                                    <th class="p-5">ุงููุงุชู</th>
                                    <th class="p-5 text-center">ุงูุฃุจูุงุก</th>
                                    <th class="p-5">ุฅุฌูุงูู ุงูุฑุณูู</th>
                                    <th class="p-5">ุงููุฏููุน</th>
                                    <th class="p-5">ุงููุชุจูู</th>
                                    <th class="p-5 rounded-tl-2xl">ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="parents-list-body" class="divide-y divide-slate-100 text-sm font-bold text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Parent Details Modal -->
            <div id="parent-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
                <div class="bg-white rounded-[2.5rem] max-w-4xl w-full max-h-[90vh] overflow-y-auto custom-scroll shadow-2xl border border-slate-100 transform transition-all scale-100">
                    <!-- Modal Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-blue-600 p-6 text-white flex justify-between items-center sticky top-0 z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-xl backdrop-blur-sm">
                                <i class="fa-solid fa-user-group"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold" id="modal-p-name">ุชูุงุตูู ุงูุนุงุฆูุฉ</h3>
                                <p class="text-indigo-100 text-sm opacity-90">ุงูุนุงู ุงูุฏุฑุงุณู <span id="modal-p-year"></span></p>
                            </div>
                        </div>
                        <button onclick="closeParentModal()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl transition flex items-center justify-center">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <div class="p-8 space-y-8">
                        <!-- Info Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <span class="text-slate-400 text-xs font-bold uppercase block mb-2">ุฑูู ุงููุงุชู</span>
                                <span id="modal-p-phone" class="font-bold text-lg text-slate-800 font-mono">---</span>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <span class="text-slate-400 text-xs font-bold uppercase block mb-2">ุงูุฑูู ุงูุชุนุฑููู</span>
                                <span id="modal-p-id" class="font-bold text-lg text-slate-800 font-mono">#---</span>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <span class="text-slate-400 text-xs font-bold uppercase block mb-2">ุชุงุฑูุฎ ุงูุชุณุฌูู</span>
                                <span id="modal-p-date" class="font-bold text-lg text-slate-800">---</span>
                            </div>
                        </div>

                        <!-- Students List with Edit -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                <h4 class="font-bold text-slate-700 flex items-center gap-2">
                                    <i class="fa-solid fa-graduation-cap text-indigo-500"></i> ูุงุฆูุฉ ุงูุฃุจูุงุก
                                </h4>
                                <button onclick="openStudentsEditModal()" class="text-sm bg-amber-100 text-amber-700 px-3 py-1.5 rounded-lg font-bold hover:bg-amber-200 transition">
                                    <i class="fa-solid fa-pen-to-square ml-1"></i> ุชุนุฏูู ูุงุฆูุฉ ุงูุฃุจูุงุก
                                </button>
                            </div>
                            <div id="modal-students-list" class="divide-y divide-slate-100"></div>
                        </div>

                        <!-- Financial Summary -->
                        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-2xl p-6 border border-indigo-100">
                            <h4 class="font-bold text-indigo-900 mb-6 flex items-center gap-2">
                                <i class="fa-solid fa-chart-line"></i> ููุฎุต ุงูุญุณุงุจ ุงููุงูู
                            </h4>
                            <div class="grid grid-cols-3 gap-6 text-center">
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-indigo-100">
                                    <div class="text-xs text-slate-500 font-bold uppercase mb-2">ุฅุฌูุงูู ุงูุฑุณูู</div>
                                    <div id="modal-p-total" class="text-2xl font-black text-slate-800">0</div>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100">
                                    <div class="text-xs text-emerald-600 font-bold uppercase mb-2">ุงููุฏููุน</div>
                                    <div id="modal-p-paid" class="text-2xl font-black text-emerald-600">0</div>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-rose-100">
                                    <div class="text-xs text-rose-600 font-bold uppercase mb-2">ุงููุชุจูู</div>
                                    <div id="modal-p-remaining" class="text-2xl font-black text-rose-600">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-4 pt-4">
                            <button onclick="openEditModal(currentParentId)" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-4 rounded-2xl font-bold text-lg transition shadow-lg shadow-amber-200 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-pen"></i> ุชุนุฏูู ุจูุงูุงุช ููู ุงูุฃูุฑ
                            </button>
                            <button onclick="deleteCurrentParent()" class="flex-1 bg-rose-500 hover:bg-rose-600 text-white py-4 rounded-2xl font-bold text-lg transition shadow-lg shadow-rose-200 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-trash"></i> ุญุฐู ุงูุนุงุฆูุฉ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Students Modal (NEW) -->
            <div id="edit-students-modal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
                <div class="bg-white rounded-[2.5rem] max-w-3xl w-full max-h-[85vh] overflow-y-auto custom-scroll shadow-2xl border border-slate-100">
                    <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-6 text-white flex justify-between items-center sticky top-0 z-10">
                        <h3 class="text-xl font-bold"><i class="fa-solid fa-user-pen ml-2"></i> ุชุนุฏูู ุจูุงูุงุช ุงูุฃุจูุงุก</h3>
                        <button onclick="closeStudentsEditModal()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl transition">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="p-8 space-y-6">
                        <div id="edit-students-list" class="space-y-3">
                            <!-- Students edit forms injected here -->
                        </div>
                        
                        <div class="border-t-2 border-dashed border-slate-200 pt-6 mt-6">
                            <h4 class="font-bold text-slate-700 mb-4">ุฅุถุงูุฉ ุทุงูุจ ุฌุฏูุฏ ููุนุงุฆูุฉ</h4>
                            <div class="flex gap-3">
                                <input type="text" id="edit-new-student-name" placeholder="ุงุณู ุงูุทุงูุจ" class="input-std flex-1">
                                <input type="text" id="edit-new-student-mother" placeholder="ุงุณู ุงูุฃู" class="input-std w-48">
                                <select id="edit-new-student-grade" class="input-std w-48 bg-white cursor-pointer"></select>
                                <button onclick="addStudentToExisting()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 rounded-xl font-bold shadow-lg shadow-emerald-200">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button onclick="saveStudentsEdit()" class="flex-1 btn-emerald py-3 text-lg">ุญูุธ ุงูุชุบููุฑุงุช</button>
                            <button onclick="closeStudentsEditModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold text-lg transition">ุฅูุบุงุก</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Parent Modal -->
            <div id="edit-parent-modal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
                <div class="bg-white rounded-[2.5rem] max-w-lg w-full p-8 shadow-2xl border border-slate-100 transform scale-100 transition-transform">
                    <h3 class="text-2xl font-black mb-8 text-slate-800 text-center">ุชุนุฏูู ุจูุงูุงุช ุงูุนุงุฆูุฉ</h3>
                    <input type="hidden" id="edit-p-id">
                    
                    <div class="space-y-6 mb-8">
                        <div>
                            <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">ุงุณู ููู ุงูุฃูุฑ</label>
                            <input type="text" id="edit-p-name" class="input-std text-lg">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">ุฑูู ุงููุงุชู</label>
                            <input type="tel" id="edit-p-phone" class="input-std font-mono text-lg">
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="saveParentEdit()" class="flex-1 btn-emerald py-3 text-lg shadow-lg shadow-emerald-200">ุญูุธ ุงูุชุนุฏููุงุช</button>
                        <button onclick="document.getElementById('edit-parent-modal').classList.add('hidden')" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold text-lg transition">ุฅูุบุงุก</button>
                    </div>
                </div>
            </div>

            <!-- B. RECEIPTS MODULE -->
            <div id="mod-receipts" class="module-view hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Receipt Form -->
                    <div class="lg:col-span-2 bg-white rounded-[2.5rem] shadow-xl border border-emerald-100 p-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-50 rounded-full -translate-y-1/2 translate-x-1/3 blur-3xl opacity-50"></div>
                        
                        <h3 class="text-2xl font-black text-emerald-700 mb-8 flex items-center gap-3 relative z-10">
                            <i class="fa-solid fa-file-invoice"></i> ุฅุตุฏุงุฑ ุณูุฏ ูุจุถ ุฌุฏูุฏ
                        </h3>
                        
                        <!-- Search Parent -->
                        <div class="relative mb-8 z-10">
                            <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ุงูุจุญุซ ุนู ููู ุงูุฃูุฑ</label>
                            <div class="relative">
                                <i class="fa-solid fa-magnifying-glass absolute right-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="rec-search" oninput="searchParent(this.value)" class="w-full p-5 pr-12 bg-slate-50 border-2 border-transparent focus:border-emerald-500 rounded-2xl outline-none font-bold text-lg transition-all shadow-inner" placeholder="ุงูุชุจ ุงุณู ููู ุงูุฃูุฑ...">
                            </div>
                            <div id="rec-results" class="absolute w-full bg-white shadow-2xl rounded-2xl mt-3 max-h-60 overflow-y-auto z-30 hidden border border-slate-100 custom-scroll"></div>
                        </div>

                        <!-- Parent Info Card -->
                        <div id="rec-info-card" class="hidden bg-emerald-50 rounded-2xl p-6 border-2 border-emerald-100 mb-8 relative z-10 shadow-sm">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h4 id="rec-p-name" class="font-black text-xl text-emerald-900 mb-1">---</h4>
                                    <p class="text-sm text-emerald-600 font-bold">ุฑูู ุงูููู: <span id="rec-p-id" class="font-mono">---</span></p>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100 text-center min-w-[120px]">
                                    <p class="text-[11px] text-slate-400 font-bold uppercase mb-1">ุงููุจูุบ ุงููุณุชุญู</p>
                                    <p id="rec-p-debt" class="text-3xl font-black text-rose-600">0</p>
                                </div>
                            </div>
                            <div class="bg-white/70 p-4 rounded-xl border border-emerald-100/50">
                                <p class="text-xs text-slate-500 mb-2 font-bold uppercase">ุงูุทูุงุจ:</p>
                                <p id="rec-students-preview" class="text-sm font-bold text-slate-700"></p>
                            </div>
                        </div>

                        <!-- Amount & Method -->
                        <div class="space-y-6 relative z-10">
                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ุงููุจูุบ ุงููุฑุงุฏ ุชุญุตููู (ุฏ.ู)</label>
                                <input type="number" id="rec-amount" class="input-std text-4xl font-black text-emerald-600 h-20 text-center shadow-inner" placeholder="0.00">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ุทุฑููุฉ ุงูุฏูุน</label>
                                    <select id="rec-method" onchange="toggleBankInfo()" class="input-std h-16 bg-white cursor-pointer text-lg">
                                        <option value="ููุฏุงู">ููุฏุงู ๐ต</option>
                                        <option value="ุตู">ุตู ุจููู ๐</option>
                                        <option value="ุชุญููู">ุชุญููู ุจููู ๐ฒ</option>
                                    </select>
                                </div>
                                <div id="bank-field" class="hidden">
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ุฑูู ุงููุฑุฌุน / ุงููุตุฑู</label>
                                    <input type="text" id="rec-ref" class="input-std h-16 text-lg" placeholder="ูุซุงู: ุจูู ุงูุฃูุฉ - ุฑูู 12345">
                                </div>
                            </div>

                            <button onclick="printReceipt()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-5 rounded-2xl font-black text-xl transition shadow-xl shadow-emerald-200 flex items-center justify-center gap-3 mt-4">
                                <i class="fa-solid fa-print"></i> ุฅุตุฏุงุฑ ูุทุจุงุนุฉ ุงูุณูุฏ
                            </button>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 p-8 h-fit">
                        <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2 text-lg">
                            <i class="fa-solid fa-clock-rotate-left text-slate-400"></i> ุขุฎุฑ ุนูููุงุช ุงููุจุถ
                        </h3>
                        <ul id="recent-receipts-list" class="space-y-4 max-h-[600px] overflow-y-auto custom-scroll"></ul>
                    </div>
                </div>
            </div>

            <!-- C. PAYMENTS MODULE -->
            <div id="mod-payments" class="module-view hidden fade-in">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-[2.5rem] shadow-xl border border-rose-100 p-10 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-rose-500 to-pink-600"></div>
                        <div class="absolute -top-20 -right-20 w-64 h-64 bg-rose-50 rounded-full blur-3xl opacity-50"></div>
                        
                        <h3 class="text-3xl font-black text-rose-700 mb-10 flex items-center gap-3 relative z-10">
                            <i class="fa-solid fa-money-bill-wave"></i> ุณูุฏ ุตุฑู (ูุตุฑููุงุช)
                        </h3>
                        
                        <div class="space-y-8 relative z-10">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ูุตุฑู ูุฃูุฑ (ุงูุฌูุฉ/ุงูุดุฎุต)</label>
                                    <input type="text" id="pay-to" placeholder="ุงุณู ุงูุฌูุฉ ุงููุณุชููุฏุฉ" class="input-std text-xl font-bold h-16">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ุชุตููู ุงููุตุฑูู</label>
                                    <select id="pay-cat" class="input-std bg-slate-50 cursor-pointer text-lg h-16">
                                        <option>ุฑูุงุชุจ ููุธููู</option>
                                        <option>ุตูุงูุฉ ูุชุฌููุฒุงุช</option>
                                        <option>ูุซุฑูุงุช ููุตุงุฑูู ุชุดุบูู</option>
                                        <option>ูุดุชุฑูุงุช ูุนุฏุงุช</option>
                                        <option>ููุงุชูุฑ ูุฑุงูู (ููุฑุจุงุก/ูุงุก)</option>
                                        <option>ูุตุงุฑูู ุชุณููู</option>
                                        <option>ุฃุฎุฑู</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ูุจูุบ ุงูุตุฑู (ุฏ.ู)</label>
                                <input type="number" id="pay-amount" class="input-std text-5xl font-black text-rose-600 h-24 text-center shadow-inner" placeholder="0.00">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ุงูุจูุงู / ุงูุชูุงุตูู</label>
                                <input type="text" id="pay-reason" placeholder="ููุถูุน ุงูุตุฑู ู ุงูุชูุงุตูู..." class="input-std h-16 text-lg">
                            </div>

                            <button onclick="printPayment()" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-5 rounded-2xl font-black text-xl transition shadow-xl shadow-rose-200 flex items-center justify-center gap-3 mt-4">
                                <i class="fa-solid fa-print"></i> ุตุฑู ูุจูุบ ูุทุจุงุนุฉ ุงูุณูุฏ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- D. REPORTS MODULE -->
            <div id="mod-reports" class="module-view hidden fade-in">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 no-print">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">ุฅุฌูุงูู ุงูููุจูุถุงุช</p>
                            <h2 id="rep-total-in" class="text-3xl font-black text-emerald-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-600 text-2xl">
                            <i class="fa-solid fa-arrow-down"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">ุฅุฌูุงูู ุงููุตุฑููุงุช</p>
                            <h2 id="rep-total-out" class="text-3xl font-black text-rose-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-rose-100 rounded-2xl flex items-center justify-center text-rose-600 text-2xl">
                            <i class="fa-solid fa-arrow-up"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">ุฑุตูุฏ ุงูุตูุฏูู</p>
                            <h2 id="rep-balance" class="text-3xl font-black text-indigo-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 text-2xl">
                            <i class="fa-solid fa-scale-balanced"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">ุฅุฌูุงูู ุงูุฏููู</p>
                            <h2 id="rep-total-debt" class="text-3xl font-black text-amber-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 text-2xl">
                            <i class="fa-solid fa-circle-exclamation"></i>
                        </div>
                    </div>
                </div>

                <!-- Debt Report -->
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8 mb-8">
                    <div class="flex justify-between items-center mb-8 no-print">
                        <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-file-contract text-slate-400"></i> ุชูุฑูุฑ ุงูุฏููู ุงููุณุชุญูุฉ
                        </h3>
                        <button onclick="printReport()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center gap-2 transition shadow-lg">
                            <i class="fa-solid fa-print"></i> ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                        </button>
                    </div>
                    <div id="report-print-area">
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200">
                                    <tr>
                                        <th class="p-4 rounded-tr-2xl">ู</th>
                                        <th class="p-4">ุงุณู ููู ุงูุฃูุฑ</th>
                                        <th class="p-4">ุงููุงุชู</th>
                                        <th class="p-4">ุนุฏุฏ ุงูุทูุงุจ</th>
                                        <th class="p-4">ุงูุฑุณูู ุงููููุฉ</th>
                                        <th class="p-4">ุงููุฏููุน</th>
                                        <th class="p-4 text-rose-600 rounded-tl-2xl">ุงููุชุจูู (ุงูุฏูู)</th>
                                    </tr>
                                </thead>
                                <tbody id="report-debt-body" class="divide-y divide-slate-100 font-bold"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- E. DAILY CLOSING MODULE -->
            <div id="mod-daily" class="module-view hidden fade-in">
                <div class="max-w-5xl mx-auto">
                    <div class="bg-white rounded-[2.5rem] shadow-xl border border-cyan-100 p-8 mb-6 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-cyan-500 to-blue-600"></div>
                        
                        <div class="flex justify-between items-center mb-10 flex-wrap gap-4">
                            <div>
                                <h3 class="text-3xl font-black text-cyan-800 mb-2 flex items-center gap-3">
                                    <i class="fa-solid fa-cash-register text-cyan-600"></i> ุชูุฑูุฑ ุงูุฅุบูุงู ุงููููู
                                </h3>
                                <p class="text-slate-500" id="daily-date-display"></p>
                            </div>
                            <div class="flex gap-3 no-print">
                                <input type="date" id="daily-date-picker" onchange="loadDailyClosing()" class="input-std py-3 px-4 text-sm w-44">
                                <button onclick="printDailyClosing()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg shadow-cyan-200 flex items-center gap-2">
                                    <i class="fa-solid fa-print"></i> ุทุจุงุนุฉ ุงูุชูุฑูุฑ
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                            <!-- Income Column -->
                            <div class="bg-emerald-50 rounded-3xl p-6 border border-emerald-100">
                                <h4 class="font-bold text-emerald-800 mb-6 flex items-center gap-2 text-lg pb-4 border-b border-emerald-200">
                                    <i class="fa-solid fa-arrow-down text-emerald-600"></i> ุงููุงุฑุฏุงุช (ุงูููุจูุถุงุช)
                                </h4>
                                <div class="space-y-3 max-h-80 overflow-y-auto custom-scroll" id="daily-in-list"></div>
                                <div class="mt-6 pt-6 border-t-2 border-emerald-200 flex justify-between items-center">
                                    <span class="font-bold text-emerald-800 text-lg">ุฅุฌูุงูู ุงููุงุฑุฏ</span>
                                    <span id="daily-in-total" class="text-2xl font-black text-emerald-700">0 ุฏ.ู</span>
                                </div>
                            </div>

                            <!-- Expenses Column -->
                            <div class="bg-rose-50 rounded-3xl p-6 border border-rose-100">
                                <h4 class="font-bold text-rose-800 mb-6 flex items-center gap-2 text-lg pb-4 border-b border-rose-200">
                                    <i class="fa-solid fa-arrow-up text-rose-600"></i> ุงููุตุฑููุงุช (ุงูุตุงุฏุฑ)
                                </h4>
                                <div class="space-y-3 max-h-80 overflow-y-auto custom-scroll" id="daily-out-list"></div>
                                <div class="mt-6 pt-6 border-t-2 border-rose-200 flex justify-between items-center">
                                    <span class="font-bold text-rose-800 text-lg">ุฅุฌูุงูู ุงูุตุงุฏุฑ</span>
                                    <span id="daily-out-total" class="text-2xl font-black text-rose-700">0 ุฏ.ู</span>
                                </div>
                            </div>
                        </div>

                        <!-- Net Total -->
                        <div class="bg-gradient-to-r from-cyan-50 to-blue-50 rounded-3xl p-8 border border-cyan-200 flex justify-between items-center shadow-inner">
                            <div>
                                <p class="text-lg text-cyan-800 font-bold mb-1">ุตุงูู ุญุฑูุฉ ุงูููู</p>
                                <p class="text-sm text-cyan-600">ุงููุงุฑุฏ - ุงููุตุฑููุงุช</p>
                            </div>
                            <div id="daily-net" class="text-5xl font-black text-cyan-700 tracking-tight">0 ุฏ.ู</div>
                        </div>
                    </div>

                    <!-- Daily Notes -->
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
                        <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-note-sticky text-amber-500"></i> ููุงุญุธุงุช ุงูููู (ุฎุงุตุฉ ุจุงูุฅุฏุงุฑุฉ)
                        </h4>
                        <textarea id="daily-notes" class="w-full p-5 rounded-2xl border-2 border-slate-200 outline-none focus:border-cyan-500 transition resize-none h-40 text-lg font-medium" placeholder="ุงูุชุจ ููุงุญุธุงุชู ุนู ููู ุงูุนูู ููุง..."></textarea>
                        <div class="flex justify-end mt-4">
                            <button onclick="saveDailyNotes()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-cyan-200">
                                <i class="fa-solid fa-floppy-disk ml-2"></i>ุญูุธ ุงูููุงุญุธุงุช
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- F. LOGS MODULE -->
            <div id="mod-logs" class="module-view hidden fade-in">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <h3 class="font-bold text-2xl text-slate-800 flex items-center gap-3">
                            <i class="fa-solid fa-clock-rotate-left text-purple-600 text-3xl"></i> ุณุฌู ุฌููุน ุงูููุงุชูุฑ ูุงูุนูููุงุช ุงููุงููุฉ
                        </h3>
                        <div class="flex gap-3 w-full md:w-auto">
                            <div class="relative flex-1 md:w-64">
                                <i class="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="logs-search" oninput="filterLogs()" placeholder="ุจุญุซ ุจุงุณู ุงูุฌูุฉ..." class="w-full p-3 pr-12 border-2 border-slate-200 rounded-xl outline-none focus:border-purple-500 transition font-bold">
                            </div>
                            <select id="logs-filter" onchange="filterLogs()" class="input-std py-3 px-4 w-36 bg-white cursor-pointer">
                                <option value="all">ุฌููุน ุงูุนูููุงุช</option>
                                <option value="in">ูุจุถ ููุท</option>
                                <option value="out">ุตุฑู ููุท</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto custom-scroll max-h-[70vh] rounded-2xl border border-slate-100">
                        <table class="w-full text-right text-sm">
                            <thead class="bg-slate-50 text-slate-600 font-bold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-4">ุฑูู ุงูุนูููุฉ</th>
                                    <th class="p-4">ุงูุชุงุฑูุฎ ูุงูููุช</th>
                                    <th class="p-4">ุงูููุน</th>
                                    <th class="p-4">ุงูุฌูุฉ/ุงูุงุณู</th>
                                    <th class="p-4">ุงููุจูุบ</th>
                                    <th class="p-4">ุงูุทุฑููุฉ/ุงูุชุตููู</th>
                                    <th class="p-4">ุงููุณุชุฎุฏู</th>
                                    <th class="p-4 text-center">ุฅุนุงุฏุฉ ุทุจุงุนุฉ</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-slate-100 font-bold text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- G. SETTINGS MODULE (Permissions & Backup) -->
            <div id="mod-settings" class="module-view hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- School Identity -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                        <h3 class="font-bold text-xl mb-8 text-indigo-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-school text-indigo-500"></i> ูููุฉ ุงููุฏุฑุณุฉ
                        </h3>
                        <div class="space-y-6">
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">ุงุณู ุงููุฏุฑุณุฉ ุงูุฑุณูู</label>
                                <input type="text" id="set-school-name" class="input-std text-lg" placeholder="ูุซุงู: ูุฏุฑุณุฉ ุงูููุฑ ุงูุฃูููุฉ">
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">ุดุนุงุฑ ุงููุฏุฑุณุฉ (Logo)</label>
                                <div class="flex items-center gap-4">
                                    <div id="logo-preview" class="w-24 h-24 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden">
                                        <span class="text-xs text-slate-400 text-center px-2">ูุง ููุฌุฏ ุดุนุงุฑ</span>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" id="set-logo-file" accept="image/*" onchange="handleLogoUpload(this)" class="block w-full text-sm text-slate-600 file:mr-4 file:py-3 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer border-2 border-slate-200 rounded-xl p-2">
                                        <p class="text-xs text-slate-400 mt-2">ููุถู ุตูุฑุฉ ูุฑุจุนุฉ ุจุฎูููุฉ ุดูุงูุฉ (PNG)</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="saveIdentity()" class="btn-action w-full py-4 text-lg shadow-lg shadow-indigo-200">
                                <i class="fa-solid fa-floppy-disk"></i> ุญูุธ ุงููููุฉ ููุฒุงููุชูุง
                            </button>
                        </div>
                    </div>

                    <!-- Backup & Restore System -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                        <h3 class="font-bold text-xl mb-8 text-emerald-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-cloud-arrow-up text-emerald-500"></i> ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุฑุฏุงุฏ
                        </h3>
                        <div class="space-y-6">
                            
                            <!-- Export -->
                            <div class="p-6 bg-blue-50 rounded-2xl border border-blue-100">
                                <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-download"></i> ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
                                </h4>
                                <p class="text-sm text-blue-700 mb-4">ูู ุจุชูุฒูู ุฌููุน ุจูุงูุงุช ุงููุธุงู ูููู JSON ูุญููุธ ุนูู ุฌูุงุฒู</p>
                                <button onclick="exportBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-blue-200 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-file-export"></i> ุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
                                </button>
                            </div>

                            <!-- Import -->
                            <div class="p-6 bg-amber-50 rounded-2xl border border-amber-100">
                                <h4 class="font-bold text-amber-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-upload"></i> ุงุณุชุฑุฏุงุฏ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
                                </h4>
                                <p class="text-sm text-amber-700 mb-4">ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู ููู JSON (ูุณุชุจุฏู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ)</p>
                                
                                <div class="space-y-3">
                                    <label class="flex items-center gap-2 p-3 bg-white rounded-xl border border-amber-200 cursor-pointer hover:bg-amber-50 transition">
                                        <i class="fa-solid fa-file-import text-amber-500 text-xl"></i>
                                        <span class="flex-1 text-sm font-bold text-amber-900">ุงุฎุชุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</span>
                                        <input type="file" id="restore-file" accept=".json" onchange="importBackup(this)" class="hidden">
                                    </label>
                                    
                                    <div id="restore-filename" class="text-sm text-slate-600 font-bold hidden">
                                        <i class="fa-solid fa-check-circle text-emerald-500 ml-1"></i> ุชู ุงุฎุชูุงุฑ: <span id="selected-file-name"></span>
                                    </div>

                                    <button onclick="confirmRestore()" class="w-full bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-amber-200 flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-rotate"></i> ุจุฏุก ุงุณุชุฑุฏุงุฏ ุงูุจูุงูุงุช
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Years Management -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-8 text-indigo-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-calendar-days text-indigo-500"></i> ุฅุฏุงุฑุฉ ุงูุฃุนูุงู ุงูุฏุฑุงุณูุฉ ูุงูุชุฑููุฉ
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                <h4 class="font-bold text-slate-700 mb-4">ุฅูุดุงุก ุนุงู ุฌุฏูุฏ</h4>
                                <div class="flex gap-3">
                                    <input type="text" id="settings-new-year" placeholder="ูุซุงู: 2026-2027" class="input-std text-sm flex-1">
                                    <button onclick="createYearFromSettings()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 rounded-xl font-bold shadow-lg shadow-indigo-200 transition">
                                        <i class="fa-solid fa-plus"></i> ุฅูุดุงุก
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                <h4 class="font-bold text-slate-700 mb-4">ุงูุนุงู ุงูุฏุฑุงุณู ุงูุญุงูู ููุนูู</h4>
                                <select id="settings-current-year" onchange="switchYearFromSettings()" class="input-std text-sm bg-white cursor-pointer w-full"></select>
                            </div>
                        </div>

                        <!-- Student Promotion -->
                        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 p-8 rounded-3xl border border-emerald-100">
                            <h4 class="font-bold text-emerald-900 mb-6 text-lg flex items-center gap-2">
                                <i class="fa-solid fa-graduation-cap"></i> ุชุฑููุฉ ุงูุทูุงุจ ููุนุงู ุงูุฏุฑุงุณู ุงูุชุงูู
                            </h4>
                            <div class="flex items-center gap-4 flex-wrap">
                                <div class="flex-1 min-w-[200px]">
                                    <label class="text-xs font-bold text-slate-500 block mb-2">ูู ุงูุนุงู (ุงููุตุฏุฑ)</label>
                                    <select id="promote-from-year" class="input-std text-sm bg-white cursor-pointer w-full"></select>
                                </div>
                                
                                <div class="text-2xl text-slate-400 pt-6">
                                    <i class="fa-solid fa-arrow-left"></i>
                                </div>
                                
                                <div class="flex-1 min-w-[200px]">
                                    <label class="text-xs font-bold text-slate-500 block mb-2">ุฅูู ุงูุนุงู (ุงููุฌูุฉ)</label>
                                    <select id="promote-to-year" class="input-std text-sm bg-white cursor-pointer w-full"></select>
                                </div>
                                
                                <button onclick="promoteStudents()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-emerald-200 transition flex items-center gap-2 mt-6 md:mt-0">
                                    <i class="fa-solid fa-user-graduate"></i> ุชุฑููุฉ ุงูุทูุงุจ
                                </button>
                            </div>
                            <p class="text-sm text-emerald-700 mt-4 bg-white/50 p-3 rounded-xl">
                                <i class="fa-solid fa-circle-info ml-2"></i>
                                ุณูุชู ููู ุฌููุน ุจูุงูุงุช ุงูุนุงุฆูุงุช ูุน ุฅุนุงุฏุฉ ุชุนููู ุงููุฏููุนุงุช ุฅูู ุตูุฑ ููุนุงู ุงูุฌุฏูุฏ
                            </p>
                        </div>
                    </div>

                    <!-- Grades Management -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-8 text-amber-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-tags text-amber-500"></i> ุฅุฏุงุฑุฉ ุงูุตููู ุงูุฏุฑุงุณูุฉ ูุงูุฑุณูู
                        </h3>
                        <div class="flex gap-3 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <input type="text" id="new-grade-name" placeholder="ุงุณู ุงูุตู (ูุซุงู: ุงูุตู ุงูุฃูู)" class="input-std text-sm flex-1 h-12">
                            <input type="number" id="new-grade-price" placeholder="ุงูุฑุณูู" class="input-std text-sm w-40 h-12">
                            <input type="number" id="new-grade-order" placeholder="ุงูุชุฑุชูุจ" class="input-std text-sm w-32 h-12" value="0">
                            <button onclick="addGrade()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 rounded-xl font-bold shadow-lg shadow-emerald-200 transition h-12 flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ
                            </button>
                        </div>
                        <div id="grades-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                    </div>

                    <!-- Users & Permissions Management -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-8 text-rose-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-users-gear text-rose-500"></i> ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู ูุงูุตูุงุญูุงุช
                        </h3>
                        
                        <!-- Add User Form -->
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8">
                            <h4 class="font-bold text-slate-700 mb-4">ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="text" id="new-u-name" placeholder="ุงุณู ุงููุณุชุฎุฏู" class="input-std text-sm h-12">
                                <input type="password" id="new-u-pin" placeholder="ุงูุฑูุฒ (4 ุฃุฑูุงู)" class="input-std text-sm h-12 font-mono" maxlength="4">
                                <select id="new-u-role" class="input-std text-sm bg-white cursor-pointer h-12" onchange="togglePermissionsEditor()">
                                    <option value="staff">ููุธู (ูุญุฏูุฏ)</option>
                                    <option value="admin">ูุฏูุฑ ูุธุงู (ูุงูู)</option>
                                </select>
                                <button onclick="addNewUser()" class="bg-slate-800 hover:bg-slate-900 text-white rounded-xl font-bold shadow-lg transition h-12 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-user-plus"></i> ุฅุถุงูุฉ
                                </button>
                            </div>
                        </div>

                        <!-- Permissions Editor (for new staff) -->
                        <div id="permissions-editor" class="hidden mb-8 p-6 bg-indigo-50 rounded-2xl border border-indigo-100">
                            <h4 class="font-bold text-indigo-900 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-shield-halved"></i> ุชุญุฏูุฏ ุตูุงุญูุงุช ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-indigo-600 rounded" value="receipts" checked>
                                    <span class="font-bold text-slate-700">ุณูุฏุงุช ุงููุจุถ</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-rose-600 rounded" value="payments" checked>
                                    <span class="font-bold text-slate-700">ุณูุฏุงุช ุงูุตุฑู</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-indigo-600 rounded" value="parents" checked>
                                    <span class="font-bold text-slate-700">ุฃูููุงุก ุงูุฃููุฑ</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-amber-600 rounded" value="reports" checked>
                                    <span class="font-bold text-slate-700">ุงูุชูุงุฑูุฑ</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-cyan-600 rounded" value="daily" checked>
                                    <span class="font-bold text-slate-700">ุงูุฅุบูุงู ุงููููู</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-purple-600 rounded" value="logs" checked>
                                    <span class="font-bold text-slate-700">ุงูุณุฌูุงุช</span>
                                </label>
                            </div>
                        </div>

                        <!-- Users Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-100 text-slate-600 font-bold border-b border-slate-200">
                                    <tr>
                                        <th class="p-4">ุงูุงุณู</th>
                                        <th class="p-4">ุงูุตูุงุญูุฉ</th>
                                        <th class="p-4">ุงููุตูู ุงููุณููุญ</th>
                                        <th class="p-4">ุขุฎุฑ ุฏุฎูู</th>
                                        <th class="p-4">ุฅุฏุงุฑุฉ</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="font-bold divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Excel Import -->
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-4 text-green-700 flex items-center gap-2">
                            <i class="fa-solid fa-file-excel text-green-600"></i> ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ูู Excel
                        </h3>
                        <div class="p-6 bg-green-50 rounded-2xl border border-green-100">
                            <div class="flex items-center gap-4 mb-4">
                                <input type="file" accept=".xlsx,.xls" onchange="importExcel(this)" class="block w-full text-sm text-green-800 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 cursor-pointer">
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-green-200">
                                <p class="text-sm text-green-800 font-bold mb-2">ุชูุณูู ุงูุฃุนูุฏุฉ ุงููุทููุจ ูู ููู Excel:</p>
                                <div class="flex flex-wrap gap-2 text-xs font-mono">
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">A: ุงุณู ููู ุงูุฃูุฑ</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">B: ุงููุงุชู</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">C: ุงุณู ุงูุทุงูุจ</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">D: ุงุณู ุงูุฃู</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">E: ุงูุตู</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">F: ุงูุฑุณูู</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Area -->
    <div id="print-area" class="hidden"></div>

    <!-- Firebase & Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBPdIGZ-V1efsO4Ohzq6ioRoBR4YyDzQb0",
            authDomain: "schoolsystem-7be7a.firebaseapp.com",
            projectId: "schoolsystem-7be7a",
            storageBucket: "schoolsystem-7be7a.firebasestorage.app",
            messagingSenderId: "191775387521",
            appId: "1:191775387521:web:9009678837327f697d8280"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbCloud = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // State Management
        window.db = { 
            schoolName: 'ูุฏุฑุณุชู', 
            logo: '', 
            users: [
                {
                    id: 1, 
                    name: 'admin', 
                    pin: '1111', 
                    role: 'admin', 
                    lastLogin: '-',
                    permissions: ['all'] // Admin has all permissions
                },
                {
                    id: 2, 
                    name: 'ุฃุญูุฏ', 
                    pin: '2222', 
                    role: 'staff', 
                    lastLogin: '-',
                    permissions: ['receipts', 'parents', 'reports'] // Limited permissions
                }
            ], 
            grades: [
                {id: 1, name: 'ุงูุตู ุงูุฃูู', price: 1000, order: 1},
                {id: 2, name: 'ุงูุตู ุงูุซุงูู', price: 1200, order: 2}
            ], 
            years: ['2025-2026'], 
            currentYear: '2025-2026' 
        };
        
        window.yearData = { '2025-2026': { parents: [], transactions: [], dailyNotes: {} } };
        
        let currentUser = null;
        let pinBuffer = "";
        let selectedLoginId = null;
        let tempStudentsBuffer = [];
        let activeParentReceipt = null;
        let currentParentId = null;
        let editingStudentsParentId = null;

        // Auth Functions
        window.signInWithGoogle = async () => {
            try {
                document.getElementById('login-status').classList.remove('hidden');
                await signInWithPopup(auth, provider);
            } catch(err) {
                alert("ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู: " + err.message);
                document.getElementById('login-status').classList.add('hidden');
            }
        };

        window.fullLogout = async () => {
            if(confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฎุฑูุฌ ุงููุงููุ")) {
                await signOut(auth);
                location.reload();
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('view-google-login').classList.add('hidden');
                document.getElementById('cloud-email-display').innerText = user.email;
                await loadData(user.email);
                showYearSelection();
            }
        });

        async function loadData(email) {
            try {
                const snap = await getDoc(doc(dbCloud, "schools", email));
                if (snap.exists()) {
                    const data = snap.data();
                    window.db = data.global || window.db;
                    window.yearData = data.years || window.yearData;
                } else {
                    await window.saveToCloud();
                }
            } catch (e) {
                console.error("Error loading data:", e);
                alert("ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช ูู ุงูุณุญุงุจุฉ");
            }
        }

        window.saveToCloud = async () => {
            if(auth.currentUser) {
                await setDoc(doc(dbCloud, "schools", auth.currentUser.email), {
                    global: window.db,
                    years: window.yearData
                });
            }
        };

        // Year Selection
        function showYearSelection() {
            const container = document.getElementById('years-grid');
            container.innerHTML = window.db.years.map(year => `
                <button onclick="selectYear('${year}')" class="p-8 rounded-3xl border-2 ${year === window.db.currentYear ? 'border-indigo-500 bg-indigo-50 text-indigo-700 shadow-lg shadow-indigo-200' : 'border-slate-200 bg-white text-slate-700 hover:border-indigo-300'} transition-all font-bold text-xl flex flex-col items-center gap-4 group">
                    <div class="w-16 h-16 ${year === window.db.currentYear ? 'bg-indigo-500 text-white' : 'bg-slate-100 text-slate-400 group-hover:bg-indigo-100 group-hover:text-indigo-600'} rounded-2xl flex items-center justify-center text-3xl transition-all">
                        <i class="fa-solid fa-calendar-check"></i>
                    </div>
                    <span>${year}</span>
                    ${year === window.db.currentYear ? '<span class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-lg shadow-md">ุงูุนุงู ุงูุญุงูู</span>' : ''}
                </button>
            `).join('');
            document.getElementById('view-year-select').classList.remove('hidden');
        }

        window.selectYear = (year) => {
            window.db.currentYear = year;
            if (!window.yearData[year]) {
                window.yearData[year] = { parents: [], transactions: [], dailyNotes: {} };
            }
            document.getElementById('view-year-select').classList.add('hidden');
            document.getElementById('view-pin-login').classList.remove('hidden');
            document.getElementById('current-year-display').innerText = year;
            document.getElementById('dash-year-badge').innerText = year;
            document.getElementById('module-year-badge').innerText = year;
            renderPinUsers();
        };

        window.createNewYear = () => {
            const input = document.getElementById('new-year-input');
            const year = input.value.trim();
            if (!year || window.db.years.includes(year)) {
                alert("ุงูุนุงู ุงูุฏุฑุงุณู ููุฌูุฏ ุจุงููุนู ุฃู ุบูุฑ ุตุงูุญ!");
                return;
            }
            window.db.years.push(year);
            window.db.years.sort();
            window.yearData[year] = { parents: [], transactions: [], dailyNotes: {} };
            window.saveToCloud();
            input.value = '';
            showYearSelection();
            alert(`ุชู ุฅูุดุงุก ุงูุนุงู ุงูุฏุฑุงุณู ${year} ุจูุฌุงุญ`);
        };

        window.changeYear = () => {
            document.getElementById('view-pin-login').classList.add('hidden');
            showYearSelection();
        };

        // PIN System
        function renderPinUsers() {
            document.getElementById('login-users-container').innerHTML = window.db.users.map(u => `
                <div onclick="selUser(${u.id}, '${u.name}')" class="bg-white/10 hover:bg-white/20 p-5 rounded-2xl cursor-pointer flex items-center gap-4 transition border border-white/5 hover:border-white/20 group">
                    <div class="w-14 h-14 bg-indigo-500 group-hover:bg-white group-hover:text-indigo-600 text-white rounded-xl flex items-center justify-center font-bold text-2xl transition-all shadow-lg">
                        ${u.name[0]}
                    </div>
                    <div class="text-white">
                        <p class="font-bold text-lg">${u.name}</p>
                        <p class="text-xs opacity-70 uppercase tracking-wider">${u.role === 'admin' ? 'ูุฏูุฑ ูุธุงู' : 'ููุธู'}</p>
                    </div>
                    <div class="mr-auto">
                        <i class="fa-solid fa-chevron-left text-white/30 group-hover:text-white/80 transition"></i>
                    </div>
                </div>
            `).join('');
        }

        window.selUser = (id, name) => {
            selectedLoginId = id;
            document.getElementById('pin-target-name').innerText = name;
            document.getElementById('pin-pad-area').classList.remove('opacity-50', 'pointer-events-none');
            window.clearPin();
        };

        window.typePin = (n) => { 
            if(pinBuffer.length < 4) { 
                pinBuffer += n; 
                updDots(); 
            } 
        };
        
        window.clearPin = () => { 
            pinBuffer = ""; 
            updDots(); 
            document.getElementById('pin-error').style.opacity = '0';
        };
        
        function updDots() { 
            for(let i=1; i<=4; i++) 
                document.getElementById(`pd-${i}`).classList.toggle('active', i <= pinBuffer.length); 
        }

        window.submitPin = async () => {
            const u = window.db.users.find(x => x.id === selectedLoginId);
            if(u && u.pin === pinBuffer) {
                currentUser = u;
                u.lastLogin = new Date().toLocaleString('ar-LY');
                await window.saveToCloud();
                document.getElementById('view-pin-login').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                initDashboard();
            } else { 
                document.getElementById('pin-error').style.opacity = '1';
                setTimeout(() => {
                    window.clearPin();
                }, 1500);
            }
        };

        window.userLogout = () => { 
            currentUser = null; 
            document.getElementById('view-dashboard').classList.add('hidden'); 
            document.getElementById('view-pin-login').classList.remove('hidden');
            window.clearPin();
        };

        function initDashboard() {
            document.getElementById('dash-school-name').innerText = window.db.schoolName;
            document.getElementById('current-user-name').innerText = currentUser.name;
            document.getElementById('current-user-role').innerText = currentUser.role === 'admin' ? 'ูุฏูุฑ ูุธุงู' : 'ููุธู';
            
            if(window.db.logo) {
                const img = document.getElementById('dash-logo');
                img.src = window.db.logo;
                img.classList.remove('hidden');
                document.getElementById('dash-logo-placeholder').classList.add('hidden');
            }

            // Apply permissions - disable cards if no permission
            const cards = ['receipts', 'payments', 'parents', 'reports', 'daily', 'logs', 'settings'];
            cards.forEach(card => {
                const element = document.getElementById(`card-${card}`);
                if(element && !hasPermission(card)) {
                    element.classList.add('disabled');
                    element.style.opacity = '0.4';
                    element.style.pointerEvents = 'none';
                    element.style.filter = 'grayscale(1)';
                }
            });
        }

        function hasPermission(module) {
            if(!currentUser) return false;
            if(currentUser.role === 'admin') return true;
            return currentUser.permissions && currentUser.permissions.includes(module);
        }

        window.checkPermissionAndNav = (mod) => {
            if(!hasPermission(mod)) {
                alert("ููุณ ูุฏูู ุตูุงุญูุฉ ุงููุตูู ููุฐุง ุงููุณู");
                return;
            }
            nav(mod);
        };

        window.toggleFullScreen = () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        };

        window.nav = (mod) => {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-modules').classList.remove('hidden');
            document.querySelectorAll('.module-view').forEach(e => e.classList.add('hidden'));
            document.getElementById('mod-'+mod).classList.remove('hidden');
            
            const titles = {
                'parents': 'ุฅุฏุงุฑุฉ ุงูุนุงุฆูุงุช', 
                'receipts': 'ุณูุฏุงุช ุงููุจุถ', 
                'payments': 'ุณูุฏุงุช ุงูุตุฑู', 
                'reports': 'ุงูุชูุงุฑูุฑ ุงููุงููุฉ', 
                'daily': 'ุงูุฅุบูุงู ุงููููู', 
                'logs': 'ุณุฌู ุงูุนูููุงุช', 
                'settings': 'ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ'
            };
            document.getElementById('module-title').innerText = titles[mod];
            
            if(mod === 'parents') initParents();
            if(mod === 'receipts') initReceipts();
            if(mod === 'reports') initReports();
            if(mod === 'daily') initDaily();
            if(mod === 'logs') initLogs();
            if(mod === 'settings') initSettings();
        };

        window.goHome = () => {
            document.getElementById('view-modules').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
        };

        function getCurrentData() {
            return window.yearData[window.db.currentYear];
        }

        // Parents Module Functions
        function initParents() {
            const grades = window.db.grades.sort((a,b) => a.order - b.order);
            document.getElementById('new-student-grade').innerHTML = grades.map(g => 
                `<option value="${g.price}" data-grade="${g.name}">${g.name} (${g.price.toLocaleString()} ุฏ.ู)</option>`
            ).join('');
            renderParentsTable();
            tempStudentsBuffer = [];
            renderTempList();
            document.getElementById('parent-name').value = '';
            document.getElementById('parent-phone').value = '';
        }

        window.addTempStudent = () => {
            const name = document.getElementById('new-student-name').value.trim();
            const mother = document.getElementById('new-student-mother').value.trim() || "-";
            const sel = document.getElementById('new-student-grade');
            if(name) {
                tempStudentsBuffer.push({
                    name, 
                    mother, 
                    price: parseInt(sel.value), 
                    grade: sel.options[sel.selectedIndex].dataset.grade
                });
                renderTempList();
                document.getElementById('new-student-name').value = "";
                document.getElementById('new-student-mother').value = "";
            }
        };

        function renderTempList() {
            let total = 0;
            document.getElementById('temp-students-list').innerHTML = tempStudentsBuffer.map((s, i) => {
                total += s.price;
                return `
                    <div class="flex justify-between items-center bg-white p-4 rounded-xl border-2 border-slate-100 hover:border-indigo-200 transition group">
                        <div>
                            <span class="font-bold text-slate-700 block">${s.name}</span>
                            <span class="text-slate-400 text-xs">${s.grade} - ุงูุฃู: ${s.mother}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg">${s.price.toLocaleString()} ุฏ.ู</span>
                            <button onclick="tempStudentsBuffer.splice(${i},1); renderTempList();" class="w-8 h-8 bg-rose-50 text-rose-400 hover:bg-rose-500 hover:text-white rounded-lg transition flex items-center justify-center">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('parent-total-calc').innerHTML = total.toLocaleString() + ' <span class="text-lg text-slate-400 font-medium">ุฏ.ู</span>';
        }

        window.saveFamily = async () => {
            const name = document.getElementById('parent-name').value.trim();
            const phone = document.getElementById('parent-phone').value.trim();
            if(!name || tempStudentsBuffer.length === 0) {
                alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ููู ุงูุฃูุฑ ูุฅุถุงูุฉ ุทุงูุจ ูุงุญุฏ ุนูู ุงูุฃูู");
                return;
            }
            const total = tempStudentsBuffer.reduce((a,b) => a + b.price, 0);
            const newParent = {
                id: Date.now(),
                name, 
                phone, 
                students: [...tempStudentsBuffer], 
                totalFees: total, 
                paid: 0,
                createdAt: new Date().toLocaleDateString('ar-LY')
            };
            getCurrentData().parents.push(newParent);
            await window.saveToCloud();
            alert("ุชู ุญูุธ ุงูุนุงุฆูุฉ ุจูุฌุงุญ โ");
            initParents();
        };

        function renderParentsTable(query="") {
            let parents = getCurrentData().parents.slice().reverse();
            if(query) parents = parents.filter(p => p.name.includes(query) || p.phone.includes(query));
            
            document.getElementById('parents-list-body').innerHTML = parents.map(p => {
                const remaining = p.totalFees - p.paid;
                return `
                    <tr class="border-b border-slate-50 hover:bg-slate-50/80 transition group">
                        <td class="p-5 text-slate-400 font-mono text-xs">#${p.id.toString().slice(-4)}</td>
                        <td class="p-5 font-bold text-slate-800">${p.name}</td>
                        <td class="p-5 font-mono text-slate-500 text-xs">${p.phone}</td>
                        <td class="p-5 text-center">
                            <span class="bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-xs font-bold">${p.students.length}</span>
                        </td>
                        <td class="p-5 font-bold text-slate-700">${p.totalFees.toLocaleString()}</td>
                        <td class="p-5 font-bold text-emerald-600">${p.paid.toLocaleString()}</td>
                        <td class="p-5 font-bold ${remaining > 0 ? 'text-rose-600' : 'text-emerald-600'}">${remaining.toLocaleString()}</td>
                        <td class="p-5">
                            <button onclick="openParentModal(${p.id})" class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white px-3 py-2 rounded-lg font-bold transition ml-1">
                                ุนุฑุถ
                            </button>
                            <button onclick="openEditModal(${p.id})" class="text-xs bg-amber-50 text-amber-600 hover:bg-amber-600 hover:text-white px-3 py-2 rounded-lg font-bold transition">
                                ุชุนุฏูู
                            </button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="8" class="p-12 text-center text-slate-400 text-lg">ูุง ุชูุฌุฏ ุนุงุฆูุงุช ูุณุฌูุฉ</td></tr>';
        }

        window.filterParentsTable = renderParentsTable;

        // Modal Functions
        window.openParentModal = (id) => {
            const p = getCurrentData().parents.find(x => x.id === id);
            if(!p) return;
            currentParentId = id;
            
            document.getElementById('modal-p-name').innerText = p.name;
            document.getElementById('modal-p-phone').innerText = p.phone || 'ุบูุฑ ูุชููุฑ';
            document.getElementById('modal-p-id').innerText = '#' + p.id.toString().slice(-4);
            document.getElementById('modal-p-date').innerText = p.createdAt || '-';
            document.getElementById('modal-p-year').innerText = window.db.currentYear;
            
            document.getElementById('modal-students-list').innerHTML = p.students.map(s => `
                <div class="flex justify-between items-center p-4 hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                    <div>
                        <span class="font-bold text-slate-700 block text-base">${s.name}</span>
                        <span class="text-slate-400 text-xs">ุงูุตู: ${s.grade} | ุงูุฃู: ${s.mother}</span>
                    </div>
                    <span class="font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-xl">${s.price.toLocaleString()} ุฏ.ู</span>
                </div>
            `).join('');
            
            document.getElementById('modal-p-total').innerText = p.totalFees.toLocaleString() + ' ุฏ.ู';
            document.getElementById('modal-p-paid').innerText = p.paid.toLocaleString() + ' ุฏ.ู';
            document.getElementById('modal-p-remaining').innerText = (p.totalFees - p.paid).toLocaleString() + ' ุฏ.ู';
            
            document.getElementById('parent-modal').classList.remove('hidden');
        };

        window.closeParentModal = () => {
            document.getElementById('parent-modal').classList.add('hidden');
        };

        // Edit Students Modal Functions (NEW)
        window.openStudentsEditModal = () => {
            const p = getCurrentData().parents.find(x => x.id === currentParentId);
            if(!p) return;
            editingStudentsParentId = currentParentId;
            
            // Populate grades select
            const grades = window.db.grades.sort((a,b) => a.order - b.order);
            document.getElementById('edit-new-student-grade').innerHTML = grades.map(g => 
                `<option value="${g.price}" data-grade="${g.name}">${g.name} (${g.price} ุฏ.ู)</option>`
            ).join('');
            
            // Populate existing students
            document.getElementById('edit-students-list').innerHTML = p.students.map((s, idx) => `
                <div class="student-edit-item bg-slate-50 p-4 rounded-2xl border border-slate-200">
                    <div class="grid grid-cols-12 gap-3 items-center">
                        <div class="col-span-4">
                            <label class="text-xs text-slate-500 block mb-1">ุงุณู ุงูุทุงูุจ</label>
                            <input type="text" class="student-edit-name-${idx} input-std text-sm w-full h-10 p-2" value="${s.name}">
                        </div>
                        <div class="col-span-3">
                            <label class="text-xs text-slate-500 block mb-1">ุงูุฃู</label>
                            <input type="text" class="student-edit-mother-${idx} input-std text-sm w-full h-10 p-2" value="${s.mother}">
                        </div>
                        <div class="col-span-3">
                            <label class="text-xs text-slate-500 block mb-1">ุงูุตู</label>
                            <select class="student-edit-grade-${idx} input-std text-sm w-full h-10 p-2 bg-white">
                                ${grades.map(g => `<option value="${g.price}" ${g.name === s.grade ? 'selected' : ''} data-grade="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-span-2 flex items-end">
                            <button onclick="removeStudentFromEdit(${idx})" class="w-full h-10 bg-rose-100 text-rose-600 rounded-xl hover:bg-rose-600 hover:text-white transition font-bold text-xs">
                                <i class="fa-solid fa-trash"></i> ุญุฐู
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('edit-students-modal').classList.remove('hidden');
        };

        window.closeStudentsEditModal = () => {
            document.getElementById('edit-students-modal').classList.add('hidden');
            editingStudentsParentId = null;
        };

        window.removeStudentFromEdit = (idx) => {
            if(confirm("ุญุฐู ูุฐุง ุงูุทุงูุจ ูู ุงููุงุฆูุฉุ")) {
                const p = getCurrentData().parents.find(x => x.id === editingStudentsParentId);
                if(p && p.students[idx]) {
                    p.students.splice(idx, 1);
                    openStudentsEditModal(); // Refresh
                }
            }
        };

        window.addStudentToExisting = () => {
            const name = document.getElementById('edit-new-student-name').value.trim();
            const mother = document.getElementById('edit-new-student-mother').value.trim() || "-";
            const sel = document.getElementById('edit-new-student-grade');
            
            if(!name) {
                alert("ุฃุฏุฎู ุงุณู ุงูุทุงูุจ");
                return;
            }
            
            const p = getCurrentData().parents.find(x => x.id === editingStudentsParentId);
            if(p) {
                const price = parseInt(sel.value);
                const grade = sel.options[sel.selectedIndex].dataset.grade;
                p.students.push({name, mother, price, grade});
                document.getElementById('edit-new-student-name').value = '';
                document.getElementById('edit-new-student-mother').value = '';
                openStudentsEditModal(); // Refresh list
            }
        };

        window.saveStudentsEdit = async () => {
            const p = getCurrentData().parents.find(x => x.id === editingStudentsParentId);
            if(!p) return;
            
            // Recalculate totals based on current students and their prices
            let newTotal = 0;
            p.students.forEach(s => {
                newTotal += s.price;
            });
            
            // Update total fees (keep paid as is, but warn if paid > new total)
            p.totalFees = newTotal;
            if(p.paid > newTotal) {
                alert("ุชูุจูู: ุงููุจูุบ ุงููุฏููุน ุฃูุจุฑ ูู ุงูุฑุณูู ุงูุฌุฏูุฏุฉ!");
            }
            
            await window.saveToCloud();
            closeStudentsEditModal();
            closeParentModal();
            renderParentsTable();
            alert("ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุฃุจูุงุก ุจูุฌุงุญ");
        };

        window.openEditModal = (id) => {
            const p = getCurrentData().parents.find(x => x.id === id);
            if(!p) return;
            currentParentId = id;
            document.getElementById('edit-p-id').value = id;
            document.getElementById('edit-p-name').value = p.name;
            document.getElementById('edit-p-phone').value = p.phone;
            document.getElementById('edit-parent-modal').classList.remove('hidden');
        };

        window.saveParentEdit = async () => {
            const p = getCurrentData().parents.find(x => x.id == currentParentId);
            if(p) {
                p.name = document.getElementById('edit-p-name').value;
                p.phone = document.getElementById('edit-p-phone').value;
                await window.saveToCloud();
                document.getElementById('edit-parent-modal').classList.add('hidden');
                renderParentsTable();
                alert("ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจูุฌุงุญ");
            }
        };

        window.deleteCurrentParent = async () => {
            if(!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุนุงุฆูุฉ ููุงุฆูุงูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก!")) return;
            getCurrentData().parents = getCurrentData().parents.filter(p => p.id !== currentParentId);
            await window.saveToCloud();
            closeParentModal();
            renderParentsTable();
            alert("ุชู ุญุฐู ุงูุนุงุฆูุฉ ุจูุฌุงุญ");
        };

        // Receipts Module
        function initReceipts() {
            activeParentReceipt = null;
            document.getElementById('rec-search').value = '';
            document.getElementById('rec-info-card').classList.add('hidden');
            document.getElementById('rec-amount').value = '';
            renderRecentReceipts();
        }

        window.searchParent = (q) => {
            const res = document.getElementById('rec-results');
            if(q.length < 2) { res.classList.add('hidden'); return; }
            const matches = getCurrentData().parents.filter(p => p.name.includes(q));
            res.innerHTML = matches.map(p => `
                <div onclick="selParentReceipt(${p.id})" class="p-4 hover:bg-slate-50 border-b border-slate-100 cursor-pointer flex justify-between items-center transition">
                    <span class="font-bold text-slate-700">${p.name}</span>
                    <span class="text-xs font-bold ${(p.totalFees - p.paid) > 0 ? 'text-rose-500' : 'text-emerald-500'}">
                        ${(p.totalFees - p.paid).toLocaleString()} ุฏ.ู
                    </span>
                </div>
            `).join('');
            res.classList.remove('hidden');
        };

        window.selParentReceipt = (id) => {
            activeParentReceipt = getCurrentData().parents.find(x => x.id === id);
            document.getElementById('rec-results').classList.add('hidden');
            document.getElementById('rec-search').value = activeParentReceipt.name;
            document.getElementById('rec-info-card').classList.remove('hidden');
            document.getElementById('rec-p-name').innerText = activeParentReceipt.name;
            document.getElementById('rec-p-id').innerText = "#" + activeParentReceipt.id.toString().slice(-4);
            document.getElementById('rec-p-debt').innerText = (activeParentReceipt.totalFees - activeParentReceipt.paid).toLocaleString();
            document.getElementById('rec-students-preview').innerText = activeParentReceipt.students.map(s => s.name).join('ุ ');
        };

        window.toggleBankInfo = () => {
            document.getElementById('bank-field').classList.toggle('hidden', document.getElementById('rec-method').value === 'ููุฏุงู');
        };

        window.printReceipt = async () => {
            if(!activeParentReceipt) return alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู ุฃูุฑ ุฃููุงู");
            const amt = parseFloat(document.getElementById('rec-amount').value);
            if(!amt || amt <= 0) return alert("ุฃุฏุฎู ูุจูุบ ุตุญูุญ ุฃูุจุฑ ูู ุตูุฑ");
            
            const oldDebt = activeParentReceipt.totalFees - activeParentReceipt.paid;
            if(amt > oldDebt) return alert("ุงููุจูุบ ุงููุฏุฎู ุฃูุจุฑ ูู ุงูุฏูู ุงููุณุชุญู!");
            
            activeParentReceipt.paid += amt;
            
            const txn = {
                id: Date.now(),
                type: 'in',
                parentId: activeParentReceipt.id,
                pName: activeParentReceipt.name,
                amount: amt,
                method: document.getElementById('rec-method').value,
                ref: document.getElementById('rec-ref').value || '-',
                date: new Date().toLocaleDateString('ar-LY'),
                time: new Date().toLocaleTimeString('ar-LY'),
                by: currentUser.name,
                year: window.db.currentYear
            };
            
            getCurrentData().transactions.push(txn);
            await window.saveToCloud();
            
            // Print Template
            const logoHTML = window.db.logo ? `<img src="${window.db.logo}" style="height:70px; float:right; margin-left:15px;">` : '';
            document.getElementById('print-area').innerHTML = `
                <div style="padding:20mm; font-family:Tajawal, Arial; direction:rtl; border:3px double #333; min-height:140mm; position:relative; background:#fff;">
                    <div style="text-align:center; border-bottom:3px double #000; padding-bottom:15px; margin-bottom:25px; overflow:hidden;">
                        ${logoHTML}
                        <h1 style="font-size:28px; font-weight:900; margin:0; color:#000;">${window.db.schoolName}</h1>
                        <p style="margin:8px 0; font-size:16px; color:#333;">ุณูุฏ ูุจุถ ุฑุณูู - ุงูุนุงู ุงูุฏุฑุงุณู ${window.db.currentYear}</p>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom:25px; font-size:14px; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <span><b>ุฑูู ุงูุณูุฏ:</b> #${txn.id.toString().slice(-6)}</span>
                        <span><b>ุงูุชุงุฑูุฎ:</b> ${txn.date}</span>
                        <span><b>ุงูููุช:</b> ${txn.time}</span>
                    </div>
                    
                    <div style="line-height:2.2; font-size:16px; margin-bottom:30px;">
                        <p style="font-size:18px; margin-bottom:15px;"><b>ุงุณุชูููุง ูู ุงูุณูุฏ/ุฉ:</b> <span style="border-bottom:2px dotted #999; padding:0 20px; font-weight:bold; font-size:20px;">${txn.pName}</span></p>
                        <p style="font-size:18px; margin-bottom:15px;"><b>ูุจูุบ ููุฏุฑู:</b> <span style="background:#f0fdf4; border:2px solid #86efac; padding:5px 20px; font-weight:bold; font-size:24px; color:#059669; border-radius:8px;">${amt.toLocaleString()} ุฏ.ู</span> <span style="font-size:14px; color:#666;">ููุท ูุง ุบูุฑ</span></p>
                        <p style="font-size:16px;"><b>ุทุฑููุฉ ุงูุฏูุน:</b> ${txn.method} ${txn.ref !== '-' ? '<br><span style="color:#666; font-size:14px;">(' + txn.ref + ')</span>' : ''}</p>
                        <p style="font-size:16px; margin-top:10px;"><b>ูุฐูู ุนู:</b> ุฑุณูู ุฏุฑุงุณูุฉ (${activeParentReceipt.students.length} ุทุงูุจ)</p>
                    </div>
                    
                    <table style="width:100%; border-collapse:collapse; text-align:center; font-size:14px; margin:30px 0; border:2px solid #333;">
                        <tr style="background:#f8fafc;">
                            <td style="border:2px solid #333; padding:12px; font-weight:bold; width:33%;">ุงูุฏูู ุงูุณุงุจู</td>
                            <td style="border:2px solid #333; padding:12px; font-weight:bold; width:33%;">ุงููุจูุบ ุงููุฏููุน</td>
                            <td style="border:2px solid #333; padding:12px; font-weight:bold; width:33%;">ุงููุชุจูู</td>
                        </tr>
                        <tr>
                            <td style="border:2px solid #333; padding:15px; font-size:18px;">${oldDebt.toLocaleString()}</td>
                            <td style="border:2px solid #333; padding:15px; font-size:20px; color:#059669; font-weight:bold; background:#f0fdf4;">${amt.toLocaleString()}</td>
                            <td style="border:2px solid #333; padding:15px; font-size:18px; color:#dc2626; font-weight:bold; ${(oldDebt-amt) <= 0 ? 'color:#059669;' : ''}">${(oldDebt - amt).toLocaleString()}</td>
                        </tr>
                    </table>
                    
                    <div style="display:flex; justify-content:space-between; margin-top:60px; font-size:14px;">
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; margin-bottom:5px; font-weight:bold;">ุงููุญุงุณุจ</div>
                            <div style="color:#666; font-size:12px;">${txn.by}</div>
                        </div>
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; margin-bottom:5px; font-weight:bold;">ุชูููุน ุงููุณุชูู</div>
                            <div style="color:#666; font-size:12px;">${txn.pName}</div>
                        </div>
                    </div>
                    
                    <div style="position:absolute; bottom:10px; left:0; right:0; text-align:center; font-size:11px; color:#999; border-top:1px solid #eee; padding-top:10px;">
                        ุชู ุฅุตุฏุงุฑ ูุฐุง ุงูุณูุฏ ุจูุงุณุทุฉ ุงููุธุงู ุงููุงูู ุงููุชูุงูู | ${window.db.schoolName}
                    </div>
                </div>
            `;
            document.getElementById('print-area').classList.remove('hidden');
            window.print();
            setTimeout(() => {
                document.getElementById('print-area').classList.add('hidden');
                window.goHome();
            }, 1000);
        };

        function renderRecentReceipts() {
            const txns = getCurrentData().transactions.filter(t => t.type === 'in').slice(-15).reverse();
            document.getElementById('recent-receipts-list').innerHTML = txns.map(t => `
                <li class="flex justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-white hover:shadow-md transition cursor-pointer group" onclick="document.getElementById('rec-search').value='${t.pName}'; selParentReceipt(${t.parentId}); document.getElementById('rec-amount').value=${t.amount};">
                    <div>
                        <span class="block font-bold text-slate-700 group-hover:text-indigo-600 transition">${t.pName}</span>
                        <span class="text-[11px] text-slate-400 font-mono">${t.date} | ${t.by}</span>
                    </div>
                    <span class="font-black text-emerald-600 text-lg">${t.amount.toLocaleString()}</span>
                </li>
            `).join('');
        }

        window.printPayment = async () => {
            const to = document.getElementById('pay-to').value.trim();
            const amt = parseFloat(document.getElementById('pay-amount').value);
            const reason = document.getElementById('pay-reason').value.trim();
            
            if(!to || !amt) return alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงูุฌูุฉ ูุงููุจูุบ");
            
            const txn = {
                id: Date.now(),
                type: 'out',
                pName: to,
                amount: amt,
                category: document.getElementById('pay-cat').value,
                reason: reason,
                date: new Date().toLocaleDateString('ar-LY'),
                time: new Date().toLocaleTimeString('ar-LY'),
                by: currentUser.name,
                year: window.db.currentYear
            };
            
            getCurrentData().transactions.push(txn);
            await window.saveToCloud();
            
            document.getElementById('print-area').innerHTML = `
                <div style="padding:20mm; font-family:Tajawal, Arial; direction:rtl; border:3px double #333; min-height:140mm; background:#fff;">
                    <div style="text-align:center; border-bottom:3px double #000; padding-bottom:15px; margin-bottom:25px;">
                        <h1 style="font-size:28px; font-weight:900; margin:0;">ุณูุฏ ุตุฑู ููุฏู</h1>
                        <p style="margin:8px 0; font-size:16px; color:#666;">${window.db.schoolName} - ${window.db.currentYear}</p>
                    </div>
                    
                    <div style="line-height:2.5; font-size:18px;">
                        <p><b>ุตุฑููุง ููุณูุฏ/ุฉ:</b> <span style="border-bottom:2px dotted #999; padding:0 20px; font-weight:bold; font-size:22px;">${to}</span></p>
                        <p><b>ูุจูุบ ููุฏุฑู:</b> <span style="background:#fff1f2; border:2px solid #fda4af; padding:5px 20px; font-weight:bold; font-size:26px; color:#e11d48; border-radius:8px;">${amt.toLocaleString()} ุฏ.ู</span></p>
                        <p><b>ุงูุชุตููู:</b> ${txn.category}</p>
                        <p><b>ุงูุจูุงู:</b> ${reason || '---'}</p>
                        <p><b>ุงูุชุงุฑูุฎ:</b> ${txn.date}</p>
                    </div>
                    
                    <div style="margin-top:80px; display:flex; justify-content:space-between; font-size:14px;">
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; font-weight:bold;">ุงููุญุงุณุจ</div>
                            <div style="color:#666; font-size:12px;">${currentUser.name}</div>
                        </div>
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; font-weight:bold;">ุงููุณุชูู</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('print-area').classList.remove('hidden');
            window.print();
            setTimeout(() => {
                document.getElementById('print-area').classList.add('hidden');
                window.goHome();
            }, 1000);
        };

        function initReports() {
            const data = getCurrentData();
            const totalIn = data.transactions.filter(t => t.type === 'in').reduce((a,b) => a + b.amount, 0);
            const totalOut = data.transactions.filter(t => t.type === 'out').reduce((a,b) => a + b.amount, 0);
            const totalDebt = data.parents.reduce((a,b) => a + (b.totalFees - b.paid), 0);
            
            document.getElementById('rep-total-in').innerText = totalIn.toLocaleString();
            document.getElementById('rep-total-out').innerText = totalOut.toLocaleString();
            document.getElementById('rep-balance').innerText = (totalIn - totalOut).toLocaleString();
            document.getElementById('rep-total-debt').innerText = totalDebt.toLocaleString();
            
            const debtors = data.parents.filter(p => (p.totalFees - p.paid) > 0).sort((a,b) => (b.totalFees - b.paid) - (a.totalFees - a.paid));
            document.getElementById('report-debt-body').innerHTML = debtors.map((p, idx) => `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                    <td class="p-4 text-slate-400">${idx + 1}</td>
                    <td class="p-4 font-bold text-slate-800">${p.name}</td>
                    <td class="p-4 font-mono text-xs text-slate-500">${p.phone}</td>
                    <td class="p-4 text-center">${p.students.length}</td>
                    <td class="p-4 font-bold">${p.totalFees.toLocaleString()}</td>
                    <td class="p-4 text-emerald-600 font-bold">${p.paid.toLocaleString()}</td>
                    <td class="p-4 text-rose-600 font-black text-lg">${(p.totalFees - p.paid).toLocaleString()}</td>
                </tr>
            `).join('') || '<tr><td colspan="7" class="p-12 text-center text-slate-400 text-lg">ูุง ุชูุฌุฏ ุฏููู ูุณุชุญูุฉ ๐</td></tr>';
        }

        window.printReport = () => {
            const content = document.getElementById('report-print-area').innerHTML;
            document.getElementById('print-area').innerHTML = `
                <div style="padding:15mm; font-family:Tajawal; direction:rtl;">
                    <h1 style="text-align:center; margin-bottom:10px; font-size:24px; font-weight:900;">ูุดู ุงูุฏููู ุงููุณุชุญูุฉ</h1>
                    <h2 style="text-align:center; margin-bottom:30px; color:#666; font-size:16px;">${window.db.schoolName} - ุงูุนุงู ุงูุฏุฑุงุณู ${window.db.currentYear}</h2>
                    ${content}
                    <div style="margin-top:50px; text-align:center; font-size:12px; color:#999; border-top:1px solid #eee; padding-top:10px;">
                        ุชู ุทุจุงุนุฉ ูุฐุง ุงูุชูุฑูุฑ ุจุชุงุฑูุฎ ${new Date().toLocaleDateString('ar-LY')} ุจูุงุณุทุฉ ${currentUser.name}
                    </div>
                </div>
            `;
            document.getElementById('print-area').classList.remove('hidden');
            window.print();
            document.getElementById('print-area').classList.add('hidden');
        };

        function initDaily() {
            document.getElementById('daily-date-picker').valueAsDate = new Date();
            loadDailyClosing();
        }

        window.loadDailyClosing = () => {
            const date = new Date(document.getElementById('daily-date-picker').value);
            document.getElementById('daily-date-display').innerText = date.toLocaleDateString('ar-LY', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            
            const data = getCurrentData();
            const dateStr = date.toLocaleDateString('ar-LY');
            const dayTxns = data.transactions.filter(t => t.date === dateStr);
            
            const inTxns = dayTxns.filter(t => t.type === 'in');
            const outTxns = dayTxns.filter(t => t.type === 'out');
            
            document.getElementById('daily-in-list').innerHTML = inTxns.map(t => `
                <div class="flex justify-between text-sm border-b border-emerald-100 py-3 hover:bg-emerald-50/50 px-2 transition rounded-lg">
                    <div>
                        <span class="font-bold text-slate-700 block">${t.pName}</span>
                        <span class="text-xs text-slate-400">${t.by}</span>
                    </div>
                    <span class="font-bold text-emerald-600">${t.amount.toLocaleString()} ุฏ.ู</span>
                </div>
            `).join('') || '<div class="text-center text-emerald-400 py-8 text-sm font-bold">ูุง ุชูุฌุฏ ุฅูุฑุงุฏุงุช ูุฐุง ุงูููู</div>';
            
            document.getElementById('daily-out-list').innerHTML = outTxns.map(t => `
                <div class="flex justify-between text-sm border-b border-rose-100 py-3 hover:bg-rose-50/50 px-2 transition rounded-lg">
                    <div>
                        <span class="font-bold text-slate-700 block">${t.pName}</span>
                        <span class="text-xs text-slate-400">${t.category}</span>
                    </div>
                    <span class="font-bold text-rose-600">${t.amount.toLocaleString()} ุฏ.ู</span>
                </div>
            `).join('') || '<div class="text-center text-rose-400 py-8 text-sm font-bold">ูุง ุชูุฌุฏ ูุตุฑููุงุช ูุฐุง ุงูููู</div>';
            
            const inTotal = inTxns.reduce((a,b) => a+b.amount, 0);
            const outTotal = outTxns.reduce((a,b) => a+b.amount, 0);
            
            document.getElementById('daily-in-total').innerText = inTotal.toLocaleString() + ' ุฏ.ู';
            document.getElementById('daily-out-total').innerText = outTotal.toLocaleString() + ' ุฏ.ู';
            document.getElementById('daily-net').innerText = (inTotal - outTotal).toLocaleString() + ' ุฏ.ู';
            
            const dateKey = document.getElementById('daily-date-picker').value;
            document.getElementById('daily-notes').value = data.dailyNotes?.[dateKey] || '';
        };

        window.saveDailyNotes = async () => {
            const date = document.getElementById('daily-date-picker').value;
            if(!getCurrentData().dailyNotes) getCurrentData().dailyNotes = {};
            getCurrentData().dailyNotes[date] = document.getElementById('daily-notes').value;
            await window.saveToCloud();
            alert("โ ุชู ุญูุธ ุงูููุงุญุธุงุช ุจูุฌุงุญ");
        };

        window.printDailyClosing = () => {
            const content = `
                <div style="padding:15mm; font-family:Tajawal; direction:rtl;">
                    <h1 style="text-align:center; margin-bottom:5px; font-size:24px; font-weight:900;">ุชูุฑูุฑ ุงูุฅุบูุงู ุงููููู</h1>
                    <h2 style="text-align:center; margin-bottom:30px; color:#0891b2; font-size:18px;">${window.db.schoolName}</h2>
                    <p style="text-align:center; margin-bottom:30px; font-weight:bold;">${document.getElementById('daily-date-display').innerText}</p>
                    
                    <div style="margin-bottom:30px; border:2px solid #ddd; padding:15px; border-radius:10px; background:#f0fdf4;">
                        <h3 style="color:#059669; margin-bottom:10px;">ุงููุงุฑุฏุงุช</h3>
                        ${document.getElementById('daily-in-list').innerHTML}
                        <div style="margin-top:10px; font-weight:bold; text-align:left; border-top:1px dashed #059669; padding-top:5px;">
                            ุงูุฅุฌูุงูู: ${document.getElementById('daily-in-total').innerText}
                        </div>
                    </div>
                    
                    <div style="margin-bottom:30px; border:2px solid #ddd; padding:15px; border-radius:10px; background:#fff1f2;">
                        <h3 style="color:#dc2626; margin-bottom:10px;">ุงููุตุฑููุงุช</h3>
                        ${document.getElementById('daily-out-list').innerHTML}
                        <div style="margin-top:10px; font-weight:bold; text-align:left; border-top:1px dashed #dc2626; padding-top:5px;">
                            ุงูุฅุฌูุงูู: ${document.getElementById('daily-out-total').innerText}
                        </div>
                    </div>
                    
                    <div style="background:#ecfeff; border:3px solid #06b6d4; padding:20px; margin-top:30px; border-radius:10px;">
                        <h2 style="text-align:center; margin:0; color:#0891b2; font-size:24px;">ุงูุตุงูู: ${document.getElementById('daily-net').innerText}</h2>
                    </div>
                    
                    <div style="margin-top:50px; display:flex; justify-content:space-between;">
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; font-weight:bold;">ุงููุญุงุณุจ</div>
                            <div style="color:#666; font-size:12px;">${currentUser.name}</div>
                        </div>
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; font-weight:bold;">ุงููุฏูุฑ</div>
                            <div style="color:#666; font-size:12px;">ุงูุชูููุน</div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('print-area').innerHTML = content;
            document.getElementById('print-area').classList.remove('hidden');
            window.print();
            document.getElementById('print-area').classList.add('hidden');
        };

        function initLogs() {
            filterLogs();
        }

        window.filterLogs = () => {
            const search = document.getElementById('logs-search').value.toLowerCase();
            const filter = document.getElementById('logs-filter').value;
            let txns = getCurrentData().transactions.slice().reverse();
            
            if(filter !== 'all') txns = txns.filter(t => t.type === filter);
            if(search) txns = txns.filter(t => t.pName.toLowerCase().includes(search));
            
            document.getElementById('logs-table-body').innerHTML = txns.map(t => `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                    <td class="p-4 text-xs font-mono text-slate-400">#${t.id.toString().slice(-6)}</td>
                    <td class="p-4 text-xs">
                        <span class="block font-bold">${t.date}</span>
                        <span class="text-slate-400">${t.time}</span>
                    </td>
                    <td class="p-4">
                        <span class="px-3 py-1.5 rounded-lg text-xs font-bold ${t.type === 'in' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}">
                            ${t.type === 'in' ? 'ูุจุถ' : 'ุตุฑู'}
                        </span>
                    </td>
                    <td class="p-4 font-bold text-slate-800">${t.pName}</td>
                    <td class="p-4 font-bold text-lg ${t.type === 'in' ? 'text-emerald-600' : 'text-rose-600'}">${t.amount.toLocaleString()}</td>
                    <td class="p-4 text-xs font-mono text-slate-500">${t.method || t.category || '-'}</td>
                    <td class="p-4 text-xs text-slate-500">${t.by}</td>
                    <td class="p-4 text-center">
                        <button onclick="alert('ุทุจุงุนุฉ ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ')" class="w-8 h-8 bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white rounded-lg transition flex items-center justify-center mx-auto">
                            <i class="fa-solid fa-print text-xs"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        };

        // Settings Functions
        function initSettings() {
            document.getElementById('set-school-name').value = window.db.schoolName;
            if(window.db.logo) {
                document.getElementById('logo-preview').innerHTML = `<img src="${window.db.logo}" class="w-full h-full object-contain">`;
            }
            renderGrades();
            renderUsersTable();
            
            const yearOpts = window.db.years.map(y => `<option value="${y}">${y}</option>`).join('');
            document.getElementById('settings-current-year').innerHTML = yearOpts;
            document.getElementById('settings-current-year').value = window.db.currentYear;
            document.getElementById('promote-from-year').innerHTML = yearOpts;
            document.getElementById('promote-to-year').innerHTML = yearOpts;
        }

        window.saveIdentity = async () => {
            window.db.schoolName = document.getElementById('set-school-name').value;
            await window.saveToCloud();
            document.getElementById('dash-school-name').innerText = window.db.schoolName;
            alert("โ ุชู ุญูุธ ุงููููุฉ ุจูุฌุงุญ");
        };

        window.handleLogoUpload = (input) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                window.db.logo = e.target.result;
                document.getElementById('logo-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-contain">`;
                const img = document.getElementById('dash-logo');
                img.src = e.target.result;
                img.classList.remove('hidden');
                document.getElementById('dash-logo-placeholder').classList.add('hidden');
                await window.saveToCloud();
            };
            if(input.files[0]) reader.readAsDataURL(input.files[0]);
        };

        window.addGrade = async () => {
            const name = document.getElementById('new-grade-name').value;
            const price = parseInt(document.getElementById('new-grade-price').value);
            const order = parseInt(document.getElementById('new-grade-order').value) || 0;
            if(name && price) {
                window.db.grades.push({id: Date.now(), name, price, order});
                await window.saveToCloud();
                renderGrades();
                document.getElementById('new-grade-name').value = '';
                document.getElementById('new-grade-price').value = '';
            }
        };

        function renderGrades() {
            const sorted = window.db.grades.sort((a,b) => a.order - b.order);
            document.getElementById('grades-list').innerHTML = sorted.map(g => `
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition group">
                    <div class="flex items-center gap-4">
                        <span class="w-8 h-8 bg-slate-100 text-slate-500 rounded-lg flex items-center justify-center font-bold text-sm">${g.order}</span>
                        <span class="font-bold text-slate-700 text-lg">${g.name}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-xl">${g.price.toLocaleString()} ุฏ.ู</span>
                        <button onclick="window.db.grades = window.db.grades.filter(x => x.id !== ${g.id}); window.saveToCloud(); renderGrades();" class="w-10 h-10 bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white rounded-xl transition flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Users & Permissions Management
        window.togglePermissionsEditor = () => {
            const role = document.getElementById('new-u-role').value;
            const editor = document.getElementById('permissions-editor');
            if(role === 'staff') {
                editor.classList.remove('hidden');
            } else {
                editor.classList.add('hidden');
            }
        };

        window.addNewUser = async () => {
            const name = document.getElementById('new-u-name').value.trim();
            const pin = document.getElementById('new-u-pin').value;
            const role = document.getElementById('new-u-role').value;
            
            if(!name || pin.length !== 4) {
                alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ูุณุชุฎุฏู ุตุญูุญ ูุฑูุฒ ูููู ูู 4 ุฃุฑูุงู");
                return;
            }

            let permissions = ['all']; // Admin has all
            if(role === 'staff') {
                permissions = Array.from(document.querySelectorAll('.perm-check:checked')).map(cb => cb.value);
                if(permissions.length === 0) {
                    alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุตูุงุญูุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู ููููุธู");
                    return;
                }
            }

            window.db.users.push({
                id: Date.now(), 
                name, 
                pin, 
                role, 
                lastLogin: '-',
                permissions: permissions
            });
            
            await window.saveToCloud();
            renderUsersTable();
            document.getElementById('new-u-name').value = '';
            document.getElementById('new-u-pin').value = '';
            alert(`โ ุชู ุฅุถุงูุฉ ุงููุณุชุฎุฏู ${name} ุจูุฌุงุญ`);
        };

        function renderUsersTable() {
            document.getElementById('users-table-body').innerHTML = window.db.users.map(u => {
                const permText = u.role === 'admin' ? '<span class="text-emerald-600">ุฌููุน ุงูุตูุงุญูุงุช</span>' : u.permissions.map(p => {
                    const labels = {receipts: 'ูุจุถ', payments: 'ุตุฑู', parents: 'ุนุงุฆูุงุช', reports: 'ุชูุงุฑูุฑ', daily: 'ุฅุบูุงู', logs: 'ุณุฌูุงุช'};
                    return `<span class="inline-block bg-slate-100 px-2 py-1 rounded text-xs ml-1">${labels[p] || p}</span>`;
                }).join('');
                
                return `
                    <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                        <td class="p-4 font-bold text-slate-800">${u.name}</td>
                        <td class="p-4">
                            <span class="px-3 py-1.5 rounded-lg text-xs font-bold ${u.role === 'admin' ? 'bg-rose-100 text-rose-700' : 'bg-blue-100 text-blue-700'}">
                                ${u.role === 'admin' ? 'ูุฏูุฑ' : 'ููุธู'}
                            </span>
                        </td>
                        <td class="p-4 text-xs">${permText}</td>
                        <td class="p-4 text-xs font-mono text-slate-400">${u.lastLogin}</td>
                        <td class="p-4">
                            ${u.id !== currentUser?.id ? 
                                `<button onclick="deleteUser(${u.id})" class="text-rose-500 hover:text-rose-700 text-xs font-bold bg-rose-50 px-3 py-1.5 rounded-lg transition hover:bg-rose-100">ุญุฐู</button>` : 
                                '<span class="text-xs text-slate-400">ุฃูุช</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.deleteUser = async (id) => {
            if(!confirm("ุญุฐู ูุฐุง ุงููุณุชุฎุฏูุ")) return;
            window.db.users = window.db.users.filter(u => u.id !== id);
            await window.saveToCloud();
            renderUsersTable();
        };

        window.createYearFromSettings = () => {
            const year = document.getElementById('settings-new-year').value.trim();
            if(!year || window.db.years.includes(year)) return alert("ุงูุนุงู ููุฌูุฏ ุฃู ุบูุฑ ุตุงูุญ");
            window.db.years.push(year);
            window.yearData[year] = { parents: [], transactions: [], dailyNotes: {} };
            window.saveToCloud();
            initSettings();
            alert(`โ ุชู ุฅูุดุงุก ุงูุนุงู ${year}`);
        };

        window.switchYearFromSettings = () => {
            window.db.currentYear = document.getElementById('settings-current-year').value;
            window.saveToCloud();
            alert("ุชู ุชุบููุฑ ุงูุนุงู ุงูุญุงูู: " + window.db.currentYear);
        };

        window.promoteStudents = async () => {
            const from = document.getElementById('promote-from-year').value;
            const to = document.getElementById('promote-to-year').value;
            
            if(from === to) return alert("ุงุฎุชุฑ ุนุงููู ูุฎุชูููู");
            if(!window.yearData[to]) return alert("ุงูุนุงู ุงููุฌูุฉ ุบูุฑ ููุฌูุฏ");
            
            const count = window.yearData[from].parents.length;
            if(!confirm(`ุณูุชู ููู ${count} ุนุงุฆูุฉ ูู ${from} ุฅูู ${to} ูุน ุฅุนุงุฏุฉ ุชุนููู ุงูุฏููู. ูุชุงุจุนุฉุ`)) return;
            
            const promoted = window.yearData[from].parents.map(p => ({
                ...p, 
                id: Date.now() + Math.random(), 
                paid: 0, 
                promotedFrom: from,
                createdAt: new Date().toLocaleDateString('ar-LY')
            }));
            
            window.yearData[to].parents = [...window.yearData[to].parents, ...promoted];
            await window.saveToCloud();
            alert(`โ ุชู ุชุฑููุฉ ${count} ุนุงุฆูุฉ ุจูุฌุงุญ`);
        };

        // Backup & Restore Functions (Fixed)
        window.exportBackup = () => {
            const backupData = {
                global: window.db,
                years: window.yearData,
                exportDate: new Date().toISOString(),
                version: '2.0',
                exportedBy: currentUser?.name || 'unknown'
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `backup_${window.db.schoolName}_${window.db.currentYear}_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        window.importBackup = (input) => {
            const file = input.files[0];
            if(!file) return;
            
            document.getElementById('selected-file-name').innerText = file.name;
            document.getElementById('restore-filename').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    restoreBuffer = JSON.parse(e.target.result);
                    console.log("Backup loaded:", restoreBuffer);
                } catch(err) {
                    alert("โ๏ธ ููู ุบูุฑ ุตุงูุญ ุฃู ุชุงูู");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        };

        window.confirmRestore = async () => {
            if(!restoreBuffer) {
                alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุฃููุงู");
                return;
            }
            
            if(!confirm("โ๏ธ ุชุญุฐูุฑ: ุณูุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ุจุงูุจูุงูุงุช ูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ. ูู ุฃูุช ูุชุฃูุฏุ")) return;
            if(!confirm("ุชุฃููุฏ ููุงุฆู: ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐู ุงูุนูููุฉ. ูุชุงุจุนุฉุ")) return;
            
            try {
                if(restoreBuffer.global) window.db = restoreBuffer.global;
                if(restoreBuffer.years) window.yearData = restoreBuffer.years;
                
                await window.saveToCloud();
                alert("โ ุชู ุงุณุชุฑุฏุงุฏ ุงูุจูุงูุงุช ุจูุฌุงุญ! ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ...");
                setTimeout(() => location.reload(), 1500);
            } catch(err) {
                alert("โ ุฎุทุฃ ูู ุงุณุชุฑุฏุงุฏ ุงูุจูุงูุงุช");
                console.error(err);
            }
        };

        window.importExcel = (input) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const wb = XLSX.read(e.target.result, {type:'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws, {header:1});
                    
                    let count = 0;
                    for(let i=1; i<data.length; i++) {
                        const row = data[i];
                        if(!row[0]) continue;
                        
                        let p = getCurrentData().parents.find(x => x.name === row[0]);
                        if(!p) {
                            p = {
                                id: Date.now() + i,
                                name: row[0],
                                phone: row[1]?.toString() || "",
                                students: [],
                                totalFees: 0,
                                paid: 0,
                                createdAt: new Date().toLocaleDateString('ar-LY')
                            };
                            getCurrentData().parents.push(p);
                        }
                        
                        const price = parseInt(row[5]) || 0;
                        p.students.push({
                            name: row[2],
                            mother: row[3] || "-",
                            grade: row[4] || "ุบูุฑ ูุญุฏุฏ",
                            price: price
                        });
                        p.totalFees += price;
                        count++;
                    }
                    
                    await window.saveToCloud();
                    alert(`โ ุชู ุงุณุชูุฑุงุฏ ${count} ุทุงูุจ ุจูุฌุงุญ`);
                    if(!document.getElementById('mod-parents').classList.contains('hidden')) {
                        initParents();
                    }
                } catch(err) {
                    alert("โ ุฎุทุฃ ูู ุงุณุชูุฑุงุฏ ุงูููู");
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(input.files[0]);
        };

        // Global click handler for modals
        window.onclick = (e) => {
            if(e.target === document.getElementById('parent-modal')) closeParentModal();
        };
    </script>
</body>
</html>