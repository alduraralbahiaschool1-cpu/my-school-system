<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --font-main: 'Tajawal', sans-serif; 
            --primary-color: #4f46e5;
            --secondary-color: #6366f1;
        }
        
        * {
            font-family: var(--font-main);
            box-sizing: border-box;
        }
        
        body { 
            background-color: #f1f5f9; 
            overflow-x: hidden;
            direction: rtl;
            margin: 0;
            padding: 0;
        }
        
        .glass-panel { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        
        .input-std { 
            width: 100%;
            padding: 1rem;
            border-radius: 1rem;
            border: 2px solid #e2e8f0;
            background-color: #ffffff;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #1e293b;
            outline: none;
        }
        
        .input-std:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }
        
        .btn-action { 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            font-weight: 700;
            padding: 1rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px -5px rgba(79, 70, 229, 0.4);
        }
        
        .btn-emerald { 
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn-rose { 
            background: linear-gradient(135deg, #e11d48 0%, #f43f5e 100%);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(225, 29, 72, 0.25);
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .dash-card { 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .dash-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .dash-card:hover::before {
            opacity: 1;
        }
        
        .dash-card:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 25px 40px -5px rgba(0, 0, 0, 0.2); 
        }
        
        .dash-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(0.8);
        }
        
        .fade-in { 
            animation: fadeIn 0.5s ease-out forwards; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .pin-dot { 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            border: 2px solid #94a3b8; 
            transition: all 0.2s; 
            background: transparent;
        }
        
        .pin-dot.active { 
            background-color: #4f46e5; 
            border-color: #4f46e5; 
            transform: scale(1.3); 
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
        }
        
        .custom-scroll::-webkit-scrollbar { 
            width: 8px; 
        }
        
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .custom-scroll::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 8px;
            border: 2px solid #f1f5f9;
        }
        
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        
        @media print {
            body * { 
                visibility: hidden; 
            }
            #print-area, #print-area * { 
                visibility: visible; 
            }
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                height: 100%; 
            }
            @page { 
                size: A5 landscape; 
                margin: 0; 
            }
            .no-print { 
                display: none !important; 
            }
        }
        
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        
        .student-edit-item {
            transition: all 0.2s;
        }
        .student-edit-item:hover {
            background-color: #f8fafc;
            transform: translateX(-5px);
        }
        
        .dir-ltr {
            direction: ltr;
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #1e293b;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .data-table th {
            background: #f8fafc;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }
        
        .data-table td {
            font-weight: 600;
            color: #334155;
        }
        
        .data-table tr:hover td {
            background: #f8fafc;
        }
        
        .search-highlight {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col antialiased">

    <!-- 1. GOOGLE LOGIN LAYER -->
    <div id="view-google-login" class="fixed inset-0 z-[70] bg-slate-900 flex flex-col items-center justify-center p-6 text-center">
        <div class="bg-white p-12 rounded-[3rem] shadow-2xl max-w-md w-full fade-in relative overflow-hidden border border-slate-200">
            <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
            
            <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center text-5xl mb-8 mx-auto text-indigo-600 shadow-inner ring-4 ring-white">
                ğŸ«
            </div>
            
            <h1 class="text-4xl font-black text-slate-800 mb-3 tracking-tight">Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</h1>
            <p class="text-slate-500 mb-10 font-medium text-lg">Ù†Ø¸Ø§Ù… Ù…Ø§Ù„ÙŠ Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Google Cloud</p>
            
            <button id="google-signin-btn" class="w-full flex items-center justify-center gap-4 bg-white border-2 border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 text-slate-700 font-bold py-5 px-6 rounded-2xl transition-all shadow-sm group mb-6">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 group-hover:scale-110 transition duration-300">
                <span class="text-lg">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</span>
            </button>
            
            <div class="flex items-center gap-3 mb-6">
                <div class="h-px bg-slate-200 flex-1"></div>
                <span class="text-slate-400 text-sm font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</span>
                <div class="h-px bg-slate-200 flex-1"></div>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                <p class="text-sm text-slate-600 mb-2">
                    <span class="font-bold text-indigo-600">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span> admin
                </p>
                <p class="text-sm text-slate-600">
                    <span class="font-bold text-indigo-600">Ø§Ù„Ø±Ù…Ø²:</span> 1111
                </p>
                <p class="text-xs text-slate-400 mt-3">ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¯Ø®ÙˆÙ„</p>
            </div>
            
            <p id="login-status" class="mt-8 text-sm text-indigo-600 font-black animate-pulse hidden">
                <i class="fa-solid fa-circle-notch fa-spin ml-2"></i>
                Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
            </p>
        </div>
        
        <div class="mt-8 text-slate-500 text-sm">
            <p>Â© 2025 Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
        </div>
    </div>

    <!-- 2. YEAR SELECTION LAYER -->
    <div id="view-year-select" class="hidden fixed inset-0 z-[60] bg-slate-900 flex flex-col items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl max-w-5xl w-full fade-in max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-black text-slate-800 mb-3">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h2>
                <p class="text-slate-500">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„ÙŠÙ‡ (ÙŠØªÙ… ÙØµÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ù…)</p>
            </div>
            
            <div id="years-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-10">
                <!-- Years will be injected here -->
            </div>
            
            <div class="border-t-2 border-slate-100 pt-8">
                <h3 class="font-bold text-slate-700 mb-4 text-center">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø§Ù… Ø¯Ø±Ø§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯</h3>
                <div class="flex gap-4 justify-center max-w-md mx-auto">
                    <input type="text" id="new-year-input" placeholder="Ù…Ø«Ø§Ù„: 2026-2027" class="input-std text-center flex-1">
                    <button onclick="createNewYear()" class="btn-emerald whitespace-nowrap">
                        <i class="fa-solid fa-plus ml-2"></i> Ø¥Ù†Ø´Ø§Ø¡
                    </button>
                </div>
                <p class="text-center text-xs text-slate-400 mt-4">Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø§Ù… Ø¬Ø¯ÙŠØ¯ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚</p>
            </div>
        </div>
    </div>

    <!-- 3. PIN LOGIN LAYER -->
    <div id="view-pin-login" class="hidden fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-6">
        <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
            <div class="space-y-8 text-white">
                <div>
                    <div class="flex items-center gap-4 mb-6 opacity-90 flex-wrap">
                        <span class="w-3 h-3 bg-emerald-400 rounded-full animate-pulse"></span>
                        <span class="text-sm font-mono bg-slate-800 px-3 py-1 rounded-lg" id="cloud-email-display">waiting...</span>
                        <span id="current-year-display" class="bg-indigo-600 px-4 py-1.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-500/30">2025-2026</span>
                        <button onclick="changeYear()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg text-indigo-200 transition border border-white/10">
                            <i class="fa-solid fa-rotate ml-1"></i> ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù…
                        </button>
                    </div>
                    
                    <h1 class="text-6xl font-black mb-6 leading-tight drop-shadow-2xl">
                        Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©<br>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</span>
                    </h1>
                    
                    <p class="text-slate-400 text-xl font-light">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø§Ù„ÙŠ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹ÙˆØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
                </div>
                
                <div class="bg-white/5 backdrop-blur-xl border border-white/10 p-6 rounded-3xl shadow-2xl">
                    <h3 class="font-bold mb-5 text-indigo-200 flex items-center gap-3 text-lg">
                        <i class="fa-solid fa-users-viewfinder bg-indigo-500/20 p-2 rounded-lg"></i>
                        Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
                    </h3>
                    <div id="login-users-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-72 overflow-y-auto custom-scroll pr-2">
                        <!-- Users injected here -->
                    </div>
                </div>
                
                <button onclick="fullLogout()" class="text-white/60 hover:text-white text-sm font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket rotate-180"></i>
                    ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙƒØ§Ù…Ù„ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
                </button>
            </div>
            
            <div id="pin-pad-area" class="bg-white/10 backdrop-blur-2xl border border-white/10 p-10 rounded-[3.5rem] shadow-2xl opacity-50 pointer-events-none transition-all duration-500 max-w-md mx-auto w-full">
                <div class="text-center mb-10">
                    <p id="pin-target-name" class="text-white font-bold mb-8 text-2xl">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
                    <div class="flex justify-center gap-5 dir-ltr mb-2">
                        <div class="pin-dot" id="pd-1"></div>
                        <div class="pin-dot" id="pd-2"></div>
                        <div class="pin-dot" id="pd-3"></div>
                        <div class="pin-dot" id="pd-4"></div>
                    </div>
                    <p id="pin-error" class="text-rose-400 text-sm mt-4 h-6 opacity-0 transition-opacity font-bold">
                        <i class="fa-solid fa-circle-exclamation ml-1"></i> Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­
                    </p>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <button onclick="typePin('1')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">1</button>
                    <button onclick="typePin('2')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">2</button>
                    <button onclick="typePin('3')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">3</button>
                    <button onclick="typePin('4')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">4</button>
                    <button onclick="typePin('5')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">5</button>
                    <button onclick="typePin('6')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">6</button>
                    <button onclick="typePin('7')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">7</button>
                    <button onclick="typePin('8')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">8</button>
                    <button onclick="typePin('9')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">9</button>
                    <button onclick="clearPin()" class="h-20 rounded-2xl bg-rose-500/20 hover:bg-rose-500/40 text-rose-300 text-xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">
                        <i class="fa-solid fa-delete-left"></i>
                    </button>
                    <button onclick="typePin('0')" class="h-20 rounded-2xl bg-white/5 hover:bg-white/20 text-white text-3xl font-bold transition-all shadow-lg border border-white/5 active:scale-95">0</button>
                    <button onclick="submitPin()" class="h-20 rounded-2xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white text-xl font-bold transition-all shadow-lg shadow-indigo-900/50 active:scale-95 flex items-center justify-center">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. DASHBOARD -->
    <div id="view-dashboard" class="hidden min-h-screen flex flex-col p-6 md:p-8 relative bg-slate-50">
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 bg-slate-50 rounded-2xl border-2 border-slate-100 flex items-center justify-center overflow-hidden shadow-inner relative group">
                    <img id="dash-logo" src="" alt="logo" class="w-full h-full object-contain hidden">
                    <span id="dash-logo-placeholder" class="text-3xl group-hover:scale-110 transition">ğŸ«</span>
                    <div class="absolute inset-0 bg-indigo-500/10 hidden group-hover:block transition"></div>
                </div>
                <div>
                    <h1 id="dash-school-name" class="text-2xl font-black text-slate-800 tracking-tight">Ù…Ø¯Ø±Ø³ØªÙŠ</h1>
                    <div class="flex items-center gap-3 mt-1">
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold border border-indigo-200" id="dash-year-badge">2025-2026</span>
                        <span class="flex items-center gap-1.5 text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg border border-emerald-100">
                            <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
                            Ù…ØªØµÙ„
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="toggleFullScreen()" class="w-12 h-12 rounded-2xl bg-slate-100 text-slate-600 flex items-center justify-center hover:bg-slate-200 transition shadow-sm" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©">
                    <i class="fa-solid fa-expand text-lg"></i>
                </button>
                
                <div class="bg-slate-50 px-5 py-3 rounded-2xl border border-slate-200 flex flex-col items-start min-w-[140px]">
                    <p id="current-user-name" class="font-bold text-sm text-slate-800">...</p>
                    <p id="current-user-role" class="text-[11px] text-indigo-600 font-black uppercase tracking-wide">...</p>
                </div>
                
                <button onclick="userLogout()" class="w-12 h-12 rounded-2xl bg-rose-50 text-rose-500 flex items-center justify-center hover:bg-rose-500 hover:text-white transition shadow-sm border border-rose-100" title="ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬">
                    <i class="fa-solid fa-power-off text-lg"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-10">
            
            <div id="card-receipts" onclick="checkPermissionAndNav('receipts')" class="dash-card bg-gradient-to-br from-emerald-500 to-teal-600 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-emerald-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-file-invoice-dollar"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</h2>
                    <p class="opacity-90 text-sm font-medium">ØªØ­ØµÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</p>
                </div>
                <div class="absolute bottom-6 left-6 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-4 group-hover:translate-y-0">
                    <i class="fa-solid fa-arrow-left text-2xl"></i>
                </div>
            </div>

            <div id="card-payments" onclick="checkPermissionAndNav('payments')" class="dash-card bg-gradient-to-br from-rose-500 to-pink-600 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-rose-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-money-bill-transfer"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø³Ù†Ø¯ Ø¯ÙØ¹</h2>
                    <p class="opacity-90 text-sm font-medium">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ù†Ø«Ø±ÙŠØ§Øª</p>
                </div>
            </div>

            <div id="card-parents" onclick="checkPermissionAndNav('parents')" class="dash-card bg-gradient-to-br from-indigo-600 to-blue-700 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-indigo-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-users-viewfinder"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</h2>
                    <p class="opacity-90 text-sm font-medium">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø§Ø¨</p>
                </div>
            </div>

            <div id="card-reports" onclick="checkPermissionAndNav('reports')" class="dash-card bg-gradient-to-br from-amber-500 to-orange-600 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-amber-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-chart-pie"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
                    <p class="opacity-90 text-sm font-medium">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                </div>
            </div>

            <div id="card-daily" onclick="checkPermissionAndNav('daily')" class="dash-card bg-gradient-to-br from-cyan-600 to-sky-700 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-cyan-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-cash-register"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
                    <p class="opacity-90 text-sm font-medium">ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</p>
                </div>
            </div>

            <div id="card-logs" onclick="checkPermissionAndNav('logs')" class="dash-card bg-gradient-to-br from-purple-600 to-violet-700 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-purple-200/50 h-64 flex flex-col justify-between group">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition duration-700"></div>
                <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h2>
                    <p class="opacity-90 text-sm font-medium">Ø³Ø¬Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
                </div>
            </div>

            <div id="card-settings" onclick="checkPermissionAndNav('settings')" class="dash-card bg-gradient-to-br from-slate-800 to-slate-900 text-white p-8 rounded-[2.5rem] relative overflow-hidden shadow-xl shadow-slate-300/50 lg:col-span-2 h-64 flex flex-col justify-between group border border-slate-700">
                <div class="absolute -top-20 -left-20 w-64 h-64 bg-white/5 rounded-full blur-3xl group-hover:bg-white/10 transition duration-700"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/10">
                        <i class="fa-solid fa-gears"></i>
                    </div>
                    <span class="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest border border-white/10">
                        Admin Only
                    </span>
                </div>
                <div class="relative z-10">
                    <h2 class="text-3xl font-black mb-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
                    <p class="opacity-90 text-sm font-medium">Ø§Ù„Ø£Ø¹ÙˆØ§Ù…ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. MODULES -->
    <div id="view-modules" class="hidden min-h-screen flex flex-col bg-slate-50">
        <div class="bg-white px-8 py-5 shadow-sm border-b border-slate-200 flex justify-between items-center sticky top-0 z-40 no-print">
            <div class="flex items-center gap-4">
                <h2 id="module-title" class="text-2xl font-black text-slate-800">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…</h2>
                <span id="module-year-badge" class="bg-slate-100 text-slate-600 px-4 py-1.5 rounded-xl text-xs font-bold border border-slate-200">2025-2026</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleFullScreen()" class="w-11 h-11 bg-slate-100 rounded-xl hover:bg-slate-200 flex items-center justify-center text-slate-600 transition">
                    <i class="fa-solid fa-expand"></i>
                </button>
                <button onclick="goHome()" class="flex items-center gap-2 bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg shadow-slate-300/50">
                    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                    <i class="fa-solid fa-house"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full custom-scroll overflow-y-auto">
            
            <!-- Parents Module -->
            <div id="mod-parents" class="module-view hidden space-y-8 fade-in">
                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-600 to-blue-600 p-6 text-white flex justify-between items-center">
                        <h3 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-user-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø¹Ø§Ø¦Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                        <span class="text-xs bg-white/20 px-3 py-1.5 rounded-lg border border-white/10">Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø³Ø­Ø§Ø¨Ø©</span>
                    </div>
                    <div class="p-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
                                <input type="text" id="parent-name" class="input-std" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input type="tel" id="parent-phone" class="input-std font-mono" placeholder="09XXXXXXXX">
                            </div>
                        </div>

                        <div class="bg-slate-50 rounded-3xl p-6 border border-slate-200 mb-8">
                            <h4 class="font-bold text-slate-700 mb-5 flex items-center gap-2 text-lg">
                                <i class="fa-solid fa-children text-indigo-500"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
                            </h4>
                            <div class="flex flex-col md:flex-row gap-3 mb-4">
                                <input type="text" id="new-student-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="flex-[2] p-3.5 rounded-xl border-2 border-slate-200 outline-none focus:border-indigo-500 transition font-bold">
                                <input type="text" id="new-student-mother" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="flex-[1] p-3.5 rounded-xl border-2 border-slate-200 outline-none focus:border-pink-400 transition bg-pink-50/30 font-bold">
                                <select id="new-student-grade" class="flex-1 p-3.5 rounded-xl border-2 border-slate-200 outline-none focus:border-indigo-500 transition font-bold text-sm bg-white cursor-pointer"></select>
                                <button onclick="addTempStudent()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 rounded-xl font-bold transition shadow-lg shadow-indigo-200 flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                                </button>
                            </div>
                            <div id="temp-students-list" class="space-y-2 max-h-48 overflow-y-auto custom-scroll"></div>
                        </div>

                        <div class="flex flex-col md:flex-row justify-between items-center gap-6 pt-6 border-t border-slate-100">
                            <div class="text-center md:text-right">
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</p>
                                <p id="parent-total-calc" class="text-5xl font-black text-indigo-600 tracking-tight">
                                    0 <span class="text-lg text-slate-400 font-medium">Ø¯.Ù„</span>
                                </p>
                            </div>
                            <button onclick="saveFamily()" class="btn-action w-full md:w-auto text-lg">
                                <span>Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ÙˆÙ…Ø²Ø§Ù…Ù†Ø©</span>
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 p-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <h3 class="font-bold text-slate-800 text-xl flex items-center gap-2">
                            <i class="fa-solid fa-list text-slate-400"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª
                        </h3>
                        <div class="relative w-full md:w-80">
                            <i class="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" oninput="filterParentsTable(this.value)" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." class="w-full p-4 pr-12 border-2 border-slate-200 rounded-2xl outline-none focus:border-indigo-500 transition font-bold">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto custom-scroll rounded-2xl border border-slate-100">
                        <table class="w-full text-right">
                            <thead class="bg-slate-50 text-slate-500 font-bold text-sm border-b border-slate-200">
                                <tr>
                                    <th class="p-5 rounded-tr-2xl">Ø§Ù„Ø±Ù‚Ù…</th>
                                    <th class="p-5">ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                                    <th class="p-5">Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th class="p-5 text-center">Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</th>
                                    <th class="p-5">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…</th>
                                    <th class="p-5">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                    <th class="p-5">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                    <th class="p-5 rounded-tl-2xl">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="parents-list-body" class="divide-y divide-slate-100 text-sm font-bold text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Parent Modal -->
            <div id="parent-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
                <div class="bg-white rounded-[2.5rem] max-w-4xl w-full max-h-[90vh] overflow-y-auto custom-scroll shadow-2xl border border-slate-100 transform transition-all scale-100">
                    <div class="bg-gradient-to-r from-indigo-600 to-blue-600 p-6 text-white flex justify-between items-center sticky top-0 z-10">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-xl backdrop-blur-sm">
                                <i class="fa-solid fa-user-group"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold" id="modal-p-name">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3>
                                <p class="text-indigo-100 text-sm opacity-90">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ <span id="modal-p-year"></span></p>
                            </div>
                        </div>
                        <button onclick="closeParentModal()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl transition flex items-center justify-center">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <div class="p-8 space-y-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <span class="text-slate-400 text-xs font-bold uppercase block mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span>
                                <span id="modal-p-phone" class="font-bold text-lg text-slate-800 font-mono">---</span>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <span class="text-slate-400 text-xs font-bold uppercase block mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ</span>
                                <span id="modal-p-id" class="font-bold text-lg text-slate-800 font-mono">#---</span>
                            </div>
                            <div class="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <span class="text-slate-400 text-xs font-bold uppercase block mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span>
                                <span id="modal-p-date" class="font-bold text-lg text-slate-800">---</span>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                                <h4 class="font-bold text-slate-700 flex items-center gap-2">
                                    <i class="fa-solid fa-graduation-cap text-indigo-500"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
                                </h4>
                                <button onclick="openStudentsEditModal()" class="text-sm bg-amber-100 text-amber-700 px-3 py-1.5 rounded-lg font-bold hover:bg-amber-200 transition">
                                    <i class="fa-solid fa-pen-to-square ml-1"></i> ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡
                                </button>
                            </div>
                            <div id="modal-students-list" class="divide-y divide-slate-100"></div>
                        </div>

                        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-2xl p-6 border border-indigo-100">
                            <h4 class="font-bold text-indigo-900 mb-6 flex items-center gap-2">
                                <i class="fa-solid fa-chart-line"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„ÙŠ
                            </h4>
                            <div class="grid grid-cols-3 gap-6 text-center">
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-indigo-100">
                                    <div class="text-xs text-slate-500 font-bold uppercase mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…</div>
                                    <div id="modal-p-total" class="text-2xl font-black text-slate-800">0</div>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100">
                                    <div class="text-xs text-emerald-600 font-bold uppercase mb-2">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
                                    <div id="modal-p-paid" class="text-2xl font-black text-emerald-600">0</div>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-rose-100">
                                    <div class="text-xs text-rose-600 font-bold uppercase mb-2">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                                    <div id="modal-p-remaining" class="text-2xl font-black text-rose-600">0</div>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-4 pt-4">
                            <button onclick="openEditModal(currentParentId)" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-4 rounded-2xl font-bold text-lg transition shadow-lg shadow-amber-200 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                            </button>
                            <button onclick="deleteCurrentParent()" class="flex-1 bg-rose-500 hover:bg-rose-600 text-white py-4 rounded-2xl font-bold text-lg transition shadow-lg shadow-rose-200 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Students Modal -->
            <div id="edit-students-modal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
                <div class="bg-white rounded-[2.5rem] max-w-3xl w-full max-h-[85vh] overflow-y-auto custom-scroll shadow-2xl border border-slate-100">
                    <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-6 text-white flex justify-between items-center sticky top-0 z-10">
                        <h3 class="text-xl font-bold"><i class="fa-solid fa-user-pen ml-2"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡</h3>
                        <button onclick="closeStudentsEditModal()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl transition">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="p-8 space-y-6">
                        <div id="edit-students-list" class="space-y-3">
                            <!-- Students edit forms injected here -->
                        </div>
                        
                        <div class="border-t-2 border-dashed border-slate-200 pt-6 mt-6">
                            <h4 class="font-bold text-slate-700 mb-4">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ø§Ø¦Ù„Ø©</h4>
                            <div class="flex gap-3">
                                <input type="text" id="edit-new-student-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="input-std flex-1">
                                <input type="text" id="edit-new-student-mother" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ù…" class="input-std w-48">
                                <select id="edit-new-student-grade" class="input-std w-48 bg-white cursor-pointer"></select>
                                <button onclick="addStudentToExisting()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 rounded-xl font-bold shadow-lg shadow-emerald-200">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button onclick="saveStudentsEdit()" class="flex-1 btn-emerald py-3 text-lg">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                            <button onclick="closeStudentsEditModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold text-lg transition">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Parent Modal -->
            <div id="edit-parent-modal" class="hidden fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4">
                <div class="bg-white rounded-[2.5rem] max-w-lg w-full p-8 shadow-2xl border border-slate-100 transform scale-100 transition-transform">
                    <h3 class="text-2xl font-black mb-8 text-slate-800 text-center">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h3>
                    <input type="hidden" id="edit-p-id">
                    
                    <div class="space-y-6 mb-8">
                        <div>
                            <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
                            <input type="text" id="edit-p-name" class="input-std text-lg">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="tel" id="edit-p-phone" class="input-std font-mono text-lg">
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="saveParentEdit()" class="flex-1 btn-emerald py-3 text-lg shadow-lg shadow-emerald-200">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                        <button onclick="document.getElementById('edit-parent-modal').classList.add('hidden')" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-3 rounded-xl font-bold text-lg transition">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            </div>

            <!-- Receipts Module -->
            <div id="mod-receipts" class="module-view hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white rounded-[2.5rem] shadow-xl border border-emerald-100 p-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-50 rounded-full -translate-y-1/2 translate-x-1/3 blur-3xl opacity-50"></div>
                        
                        <h3 class="text-2xl font-black text-emerald-700 mb-8 flex items-center gap-3 relative z-10">
                            <i class="fa-solid fa-file-invoice"></i> Ø¥ØµØ¯Ø§Ø± Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ Ø¬Ø¯ÙŠØ¯
                        </h3>
                        
                        <div class="relative mb-8 z-10">
                            <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ)</label>
                            <div class="relative">
                                <i class="fa-solid fa-magnifying-glass absolute right-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="rec-search" oninput="searchParent(this.value)" class="w-full p-5 pr-12 bg-slate-50 border-2 border-transparent focus:border-emerald-500 rounded-2xl outline-none font-bold text-lg transition-all shadow-inner" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
                            </div>
                            <div id="rec-results" class="absolute w-full bg-white shadow-2xl rounded-2xl mt-3 max-h-60 overflow-y-auto z-30 hidden border border-slate-100 custom-scroll"></div>
                        </div>

                        <div id="rec-info-card" class="hidden bg-emerald-50 rounded-2xl p-6 border-2 border-emerald-100 mb-8 relative z-10 shadow-sm">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h4 id="rec-p-name" class="font-black text-xl text-emerald-900 mb-1">---</h4>
                                    <p class="text-sm text-emerald-600 font-bold">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: <span id="rec-p-id" class="font-mono">---</span></p>
                                    <p class="text-sm text-emerald-600 font-bold mt-1">Ø§Ù„Ù‡Ø§ØªÙ: <span id="rec-p-phone" class="font-mono">---</span></p>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100 text-center min-w-[120px]">
                                    <p class="text-[11px] text-slate-400 font-bold uppercase mb-1">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</p>
                                    <p id="rec-p-debt" class="text-3xl font-black text-rose-600">0</p>
                                </div>
                            </div>
                            <div class="bg-white/70 p-4 rounded-xl border border-emerald-100/50">
                                <p class="text-xs text-slate-500 mb-2 font-bold uppercase">Ø§Ù„Ø·Ù„Ø§Ø¨:</p>
                                <p id="rec-students-preview" class="text-sm font-bold text-slate-700"></p>
                            </div>
                        </div>

                        <div class="space-y-6 relative z-10">
                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ØµÙŠÙ„Ù‡ (Ø¯.Ù„)</label>
                                <input type="number" id="rec-amount" class="input-std text-4xl font-black text-emerald-600 h-20 text-center shadow-inner" placeholder="0.00">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                                    <select id="rec-method" onchange="toggleBankInfo()" class="input-std h-16 bg-white cursor-pointer text-lg">
                                        <option value="Ù†Ù‚Ø¯Ø§Ù‹">Ù†Ù‚Ø¯Ø§Ù‹ ğŸ’µ</option>
                                        <option value="ØµÙƒ">ØµÙƒ Ø¨Ù†ÙƒÙŠ ğŸ“„</option>
                                        <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ ğŸ“²</option>
                                    </select>
                                </div>
                                <div id="bank-field" class="hidden">
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ / Ø§Ù„Ù…ØµØ±Ù</label>
                                    <input type="text" id="rec-ref" class="input-std h-16 text-lg" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù…Ø© - Ø±Ù‚Ù… 12345">
                                </div>
                            </div>

                            <button onclick="printReceipt()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-5 rounded-2xl font-black text-xl transition shadow-xl shadow-emerald-200 flex items-center justify-center gap-3 mt-4">
                                <i class="fa-solid fa-print"></i> Ø¥ØµØ¯Ø§Ø± ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ù†Ø¯
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 p-8 h-fit">
                        <h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2 text-lg">
                            <i class="fa-solid fa-clock-rotate-left text-slate-400"></i> Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¨Ø¶
                        </h3>
                        <ul id="recent-receipts-list" class="space-y-4 max-h-[600px] overflow-y-auto custom-scroll"></ul>
                    </div>
                </div>
            </div>

            <!-- Payments Module -->
            <div id="mod-payments" class="module-view hidden fade-in">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white rounded-[2.5rem] shadow-xl border border-rose-100 p-10 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-rose-500 to-pink-600"></div>
                        <div class="absolute -top-20 -right-20 w-64 h-64 bg-rose-50 rounded-full blur-3xl opacity-50"></div>
                        
                        <h3 class="text-3xl font-black text-rose-700 mb-10 flex items-center gap-3 relative z-10">
                            <i class="fa-solid fa-money-bill-wave"></i> Ø³Ù†Ø¯ ØµØ±Ù (Ù…ØµØ±ÙˆÙØ§Øª)
                        </h3>
                        
                        <div class="space-y-8 relative z-10">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ÙŠØµØ±Ù Ù„Ø£Ù…Ø± (Ø§Ù„Ø¬Ù‡Ø©/Ø§Ù„Ø´Ø®Øµ)</label>
                                    <input type="text" id="pay-to" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯Ø©" class="input-std text-xl font-bold h-16">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                    <select id="pay-cat" class="input-std bg-slate-50 cursor-pointer text-lg h-16">
                                        <option>Ø±ÙˆØ§ØªØ¨ Ù…ÙˆØ¸ÙÙŠÙ†</option>
                                        <option>ØµÙŠØ§Ù†Ø© ÙˆØªØ¬Ù‡ÙŠØ²Ø§Øª</option>
                                        <option>Ù†Ø«Ø±ÙŠØ§Øª ÙˆÙ…ØµØ§Ø±ÙŠÙ ØªØ´ØºÙŠÙ„</option>
                                        <option>Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ø¹Ø¯Ø§Øª</option>
                                        <option>ÙÙˆØ§ØªÙŠØ± Ù…Ø±Ø§ÙÙ‚ (ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…Ø§Ø¡)</option>
                                        <option>Ù…ØµØ§Ø±ÙŠÙ ØªØ³ÙˆÙŠÙ‚</option>
                                        <option>Ø£Ø®Ø±Ù‰</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ù…Ø¨Ù„Øº Ø§Ù„ØµØ±Ù (Ø¯.Ù„)</label>
                                <input type="number" id="pay-amount" class="input-std text-5xl font-black text-rose-600 h-24 text-center shadow-inner" placeholder="0.00">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 mb-2 block uppercase">Ø§Ù„Ø¨ÙŠØ§Ù† / Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
                                <input type="text" id="pay-reason" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„ØµØ±Ù Ùˆ Ø§Ù„ØªÙØ§ØµÙŠÙ„..." class="input-std h-20 text-lg">
                            </div>

                            <button onclick="printPayment()" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-5 rounded-2xl font-black text-xl transition shadow-xl shadow-rose-200 flex items-center justify-center gap-3 mt-4">
                                <i class="fa-solid fa-print"></i> ØµØ±Ù Ù…Ø¨Ù„Øº ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ù†Ø¯
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports Module - ENHANCED WITH FILTERS -->
            <div id="mod-reports" class="module-view hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 no-print">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª</p>
                            <h2 id="rep-total-in" class="text-3xl font-black text-emerald-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-600 text-2xl">
                            <i class="fa-solid fa-arrow-down"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                            <h2 id="rep-total-out" class="text-3xl font-black text-rose-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-rose-100 rounded-2xl flex items-center justify-center text-rose-600 text-2xl">
                            <i class="fa-solid fa-arrow-up"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</p>
                            <h2 id="rep-balance" class="text-3xl font-black text-indigo-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 text-2xl">
                            <i class="fa-solid fa-scale-balanced"></i>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold uppercase text-slate-400 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</p>
                            <h2 id="rep-total-debt" class="text-3xl font-black text-amber-600">0</h2>
                        </div>
                        <div class="w-14 h-14 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 text-2xl">
                            <i class="fa-solid fa-circle-exclamation"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8 mb-8 no-print">
                    <h3 class="font-bold text-xl text-slate-800 mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-filter text-indigo-500"></i> ØªØµÙÙŠØ© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙŠÙˆÙ†
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 mb-2 block">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¯ÙŠÙ† (Ø¯.Ù„)</label>
                            <input type="number" id="filter-min-debt" class="input-std" placeholder="Ù…Ø«Ø§Ù„: 1000" oninput="applyDebtFilters()">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 mb-2 block">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¯ÙŠÙ† (Ø¯.Ù„)</label>
                            <input type="number" id="filter-max-debt" class="input-std" placeholder="Ù…Ø«Ø§Ù„: 5000" oninput="applyDebtFilters()">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 mb-2 block">Ù†Ø³Ø¨Ø© Ø¹Ø¯Ù… Ø§Ù„Ø³Ø¯Ø§Ø¯ (%)</label>
                            <select id="filter-percentage" class="input-std bg-white cursor-pointer" onchange="applyDebtFilters()">
                                <option value="0">Ø§Ù„ÙƒÙ„</option>
                                <option value="100">Ù„Ù… ÙŠØ³Ø¯Ø¯ Ø´ÙŠØ¦Ø§Ù‹ (100%)</option>
                                <option value="75">Ø£ÙƒØ«Ø± Ù…Ù† 75%</option>
                                <option value="50">Ø£ÙƒØ«Ø± Ù…Ù† 50%</option>
                                <option value="25">Ø£ÙƒØ«Ø± Ù…Ù† 25%</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <button onclick="resetFilters()" class="text-slate-500 hover:text-slate-700 font-bold text-sm flex items-center gap-2">
                            <i class="fa-solid fa-rotate-left"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
                        </button>
                        <span id="filter-count" class="text-sm font-bold text-indigo-600"></span>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8 mb-8">
                    <div class="flex justify-between items-center mb-8 no-print">
                        <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-file-contract text-slate-400"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©
                        </h3>
                        <button onclick="printReport()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded-xl text-sm font-bold flex items-center gap-2 transition shadow-lg">
                            <i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                        </button>
                    </div>
                    <div id="report-print-area">
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200">
                                    <tr>
                                        <th class="p-4 rounded-tr-2xl">Ù…</th>
                                        <th class="p-4">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                                        <th class="p-4">Ø§Ù„Ù‡Ø§ØªÙ</th>
                                        <th class="p-4">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                                        <th class="p-4">Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„ÙƒÙ„ÙŠØ©</th>
                                        <th class="p-4">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                        <th class="p-4 text-rose-600 rounded-tl-2xl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø§Ù„Ø¯ÙŠÙ†)</th>
                                        <th class="p-4">Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯</th>
                                    </tr>
                                </thead>
                                <tbody id="report-debt-body" class="divide-y divide-slate-100 font-bold"></tbody>
                            </table>
                        </div>
                        <div id="no-results-msg" class="hidden text-center py-12 text-slate-400 text-lg">
                            <i class="fa-solid fa-inbox text-4xl mb-4"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Daily Module -->
            <div id="mod-daily" class="module-view hidden fade-in">
                <div class="max-w-5xl mx-auto">
                    <div class="bg-white rounded-[2.5rem] shadow-xl border border-cyan-100 p-8 mb-6 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-cyan-500 to-blue-600"></div>
                        
                        <div class="flex justify-between items-center mb-10 flex-wrap gap-4">
                            <div>
                                <h3 class="text-3xl font-black text-cyan-800 mb-2 flex items-center gap-3">
                                    <i class="fa-solid fa-cash-register text-cyan-600"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ
                                </h3>
                                <p class="text-slate-500" id="daily-date-display"></p>
                            </div>
                            <div class="flex gap-3 no-print">
                                <input type="date" id="daily-date-picker" onchange="loadDailyClosing()" class="input-std py-3 px-4 text-sm w-44">
                                <button onclick="printDailyClosing()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg shadow-cyan-200 flex items-center gap-2">
                                    <i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                            <div class="bg-emerald-50 rounded-3xl p-6 border border-emerald-100">
                                <h4 class="font-bold text-emerald-800 mb-6 flex items-center gap-2 text-lg pb-4 border-b border-emerald-200">
                                    <i class="fa-solid fa-arrow-down text-emerald-600"></i> Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª (Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª)
                                </h4>
                                <div class="space-y-3 max-h-80 overflow-y-auto custom-scroll" id="daily-in-list"></div>
                                <div class="mt-6 pt-6 border-t-2 border-emerald-200 flex justify-between items-center">
                                    <span class="font-bold text-emerald-800 text-lg">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯</span>
                                    <span id="daily-in-total" class="text-2xl font-black text-emerald-700">0 Ø¯.Ù„</span>
                                </div>
                            </div>

                            <div class="bg-rose-50 rounded-3xl p-6 border border-rose-100">
                                <h4 class="font-bold text-rose-800 mb-6 flex items-center gap-2 text-lg pb-4 border-b border-rose-200">
                                    <i class="fa-solid fa-arrow-up text-rose-600"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (Ø§Ù„ØµØ§Ø¯Ø±)
                                </h4>
                                <div class="space-y-3 max-h-80 overflow-y-auto custom-scroll" id="daily-out-list"></div>
                                <div class="mt-6 pt-6 border-t-2 border-rose-200 flex justify-between items-center">
                                    <span class="font-bold text-rose-800 text-lg">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµØ§Ø¯Ø±</span>
                                    <span id="daily-out-total" class="text-2xl font-black text-rose-700">0 Ø¯.Ù„</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-cyan-50 to-blue-50 rounded-3xl p-8 border border-cyan-200 flex justify-between items-center shadow-inner">
                            <div>
                                <p class="text-lg text-cyan-800 font-bold mb-1">ØµØ§ÙÙŠ Ø­Ø±ÙƒØ© Ø§Ù„ÙŠÙˆÙ…</p>
                                <p class="text-sm text-cyan-600">Ø§Ù„ÙˆØ§Ø±Ø¯ - Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                            </div>
                            <div id="daily-net" class="text-5xl font-black text-cyan-700 tracking-tight">0 Ø¯.Ù„</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
                        <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-note-sticky text-amber-500"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ… (Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)
                        </h4>
                        <textarea id="daily-notes" class="w-full p-5 rounded-2xl border-2 border-slate-200 outline-none focus:border-cyan-500 transition resize-none h-40 text-lg font-medium" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø¹Ù† ÙŠÙˆÙ… Ø§Ù„Ø¹Ù…Ù„ Ù‡Ù†Ø§..."></textarea>
                        <div class="flex justify-end mt-4">
                            <button onclick="saveDailyNotes()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-cyan-200">
                                <i class="fa-solid fa-floppy-disk ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Module - REPRINT FIXED -->
            <div id="mod-logs" class="module-view hidden fade-in">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <h3 class="font-bold text-2xl text-slate-800 flex items-center gap-3">
                            <i class="fa-solid fa-clock-rotate-left text-purple-600 text-3xl"></i> Ø³Ø¬Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                        </h3>
                        <div class="flex gap-3 w-full md:w-auto">
                            <div class="relative flex-1 md:w-64">
                                <i class="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="logs-search" oninput="filterLogs()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©..." class="w-full p-3 pr-12 border-2 border-slate-200 rounded-xl outline-none focus:border-purple-500 transition font-bold">
                            </div>
                            <select id="logs-filter" onchange="filterLogs()" class="input-std py-3 px-4 w-36 bg-white cursor-pointer">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                                <option value="in">Ù‚Ø¨Ø¶ ÙÙ‚Ø·</option>
                                <option value="out">ØµØ±Ù ÙÙ‚Ø·</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto custom-scroll max-h-[70vh] rounded-2xl border border-slate-100">
                        <table class="w-full text-right text-sm">
                            <thead class="bg-slate-50 text-slate-600 font-bold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-4">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th class="p-4">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                                    <th class="p-4">Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th class="p-4">Ø§Ù„Ø¬Ù‡Ø©/Ø§Ù„Ø§Ø³Ù…</th>
                                    <th class="p-4">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th class="p-4">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©/Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                    <th class="p-4">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                    <th class="p-4 text-center">Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body" class="divide-y divide-slate-100 font-bold text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Module - FIXED USERS AND YEARS -->
            <div id="mod-settings" class="module-view hidden fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                        <h3 class="font-bold text-xl mb-8 text-indigo-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-school text-indigo-500"></i> Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
                        </h3>
                        <div class="space-y-6">
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø±Ø³Ù…ÙŠ</label>
                                <input type="text" id="set-school-name" class="input-std text-lg" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†ÙˆØ± Ø§Ù„Ø£Ù‡Ù„ÙŠØ©">
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-2 uppercase">Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Logo)</label>
                                <div class="flex items-center gap-4">
                                    <div id="logo-preview" class="w-24 h-24 bg-slate-50 rounded-2xl border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden">
                                        <span class="text-xs text-slate-400 text-center px-2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø¹Ø§Ø±</span>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" id="set-logo-file" accept="image/*" onchange="handleLogoUpload(this)" class="block w-full text-sm text-slate-600 file:mr-4 file:py-3 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer border-2 border-slate-200 rounded-xl p-2">
                                        <p class="text-xs text-slate-400 mt-2">ÙŠÙØ¶Ù„ ØµÙˆØ±Ø© Ù…Ø±Ø¨Ø¹Ø© Ø¨Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© (PNG)</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="saveIdentity()" class="btn-action w-full py-4 text-lg shadow-lg shadow-indigo-200">
                                <i class="fa-solid fa-floppy-disk"></i> Ø­ÙØ¸ Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆÙ…Ø²Ø§Ù…Ù†ØªÙ‡Ø§
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200">
                        <h3 class="font-bold text-xl mb-8 text-emerald-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-cloud-arrow-up text-emerald-500"></i> Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯
                        </h3>
                        <div class="space-y-6">
                            
                            <div class="p-6 bg-blue-50 rounded-2xl border border-blue-100">
                                <h4 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-download"></i> ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                                </h4>
                                <p class="text-sm text-blue-700 mb-4">Ù‚Ù… Ø¨ØªÙ†Ø²ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙƒÙ…Ù„Ù JSON Ù…Ø­ÙÙˆØ¸ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
                                <button onclick="exportBackup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-blue-200 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-file-export"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                                </button>
                            </div>

                            <div class="p-6 bg-amber-50 rounded-2xl border border-amber-100">
                                <h4 class="font-bold text-amber-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-upload"></i> Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                                </h4>
                                <p class="text-sm text-amber-700 mb-4">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON (ÙŠØ³ØªØ¨Ø¯Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</p>
                                
                                <div class="space-y-3">
                                    <label class="flex items-center gap-2 p-3 bg-white rounded-xl border border-amber-200 cursor-pointer hover:bg-amber-50 transition">
                                        <i class="fa-solid fa-file-import text-amber-500 text-xl"></i>
                                        <span class="flex-1 text-sm font-bold text-amber-900">Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</span>
                                        <input type="file" id="restore-file" accept=".json" onchange="importBackup(this)" class="hidden">
                                    </label>
                                    
                                    <div id="restore-filename" class="text-sm text-slate-600 font-bold hidden">
                                        <i class="fa-solid fa-check-circle text-emerald-500 ml-1"></i> ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: <span id="selected-file-name"></span>
                                    </div>

                                    <button onclick="confirmRestore()" class="w-full bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-amber-200 flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-rotate"></i> Ø¨Ø¯Ø¡ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-8 text-indigo-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-calendar-days text-indigo-500"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹ÙˆØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØªØ±Ù‚ÙŠØ©
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                <h4 class="font-bold text-slate-700 mb-4">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø§Ù… Ø¬Ø¯ÙŠØ¯</h4>
                                <div class="flex gap-3">
                                    <input type="text" id="settings-new-year" placeholder="Ù…Ø«Ø§Ù„: 2026-2027" class="input-std text-sm flex-1">
                                    <button onclick="createYearFromSettings()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 rounded-xl font-bold shadow-lg shadow-indigo-200 transition">
                                        <i class="fa-solid fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                <h4 class="font-bold text-slate-700 mb-4">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù…Ù„</h4>
                                <select id="settings-current-year" onchange="switchYearFromSettings()" class="input-std text-sm bg-white cursor-pointer w-full"></select>
                            </div>
                        </div>

                        <!-- Years List with Delete - THIS IS THE FIX -->
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8">
                            <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-list-check text-rose-500"></i> Ø§Ù„Ø£Ø¹ÙˆØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø§Ù„Ù…Ø³Ø¬Ù„Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­Ø°Ù Ù‡Ù†Ø§)
                            </h4>
                            <div id="settings-years-list" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <!-- Years injected here -->
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 p-8 rounded-3xl border border-emerald-100">
                            <h4 class="font-bold text-emerald-900 mb-6 text-lg flex items-center gap-2">
                                <i class="fa-solid fa-graduation-cap"></i> ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ
                            </h4>
                            <div class="flex items-center gap-4 flex-wrap">
                                <div class="flex-1 min-w-[200px]">
                                    <label class="text-xs font-bold text-slate-500 block mb-2">Ù…Ù† Ø§Ù„Ø¹Ø§Ù… (Ø§Ù„Ù…ØµØ¯Ø±)</label>
                                    <select id="promote-from-year" class="input-std text-sm bg-white cursor-pointer w-full"></select>
                                </div>
                                
                                <div class="text-2xl text-slate-400 pt-6">
                                    <i class="fa-solid fa-arrow-left"></i>
                                </div>
                                
                                <div class="flex-1 min-w-[200px]">
                                    <label class="text-xs font-bold text-slate-500 block mb-2">Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø§Ù… (Ø§Ù„ÙˆØ¬Ù‡Ø©)</label>
                                    <select id="promote-to-year" class="input-std text-sm bg-white cursor-pointer w-full"></select>
                                </div>
                                
                                <button onclick="promoteStudents()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-emerald-200 transition flex items-center gap-2 mt-6 md:mt-0">
                                    <i class="fa-solid fa-user-graduate"></i> ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨
                                </button>
                            </div>
                            <p class="text-sm text-emerald-700 mt-4 bg-white/50 p-3 rounded-xl">
                                <i class="fa-solid fa-circle-info ml-2"></i>
                                Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø¥Ù„Ù‰ ØµÙØ± Ù„Ù„Ø¹Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            </p>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-8 text-amber-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-tags text-amber-500"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø±Ø³ÙˆÙ…
                        </h3>
                        <div class="flex gap-3 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-200">
                            <input type="text" id="new-grade-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ (Ù…Ø«Ø§Ù„: Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„)" class="input-std text-sm flex-1 h-12">
                            <input type="number" id="new-grade-price" placeholder="Ø§Ù„Ø±Ø³ÙˆÙ…" class="input-std text-sm w-40 h-12">
                            <input type="number" id="new-grade-order" placeholder="Ø§Ù„ØªØ±ØªÙŠØ¨" class="input-std text-sm w-32 h-12" value="0">
                            <button onclick="addGrade()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 rounded-xl font-bold shadow-lg shadow-emerald-200 transition h-12 flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                            </button>
                        </div>
                        <div id="grades-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                    </div>

                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-8 text-rose-900 flex items-center gap-2 pb-4 border-b border-slate-100">
                            <i class="fa-solid fa-users-gear text-rose-500"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                        </h3>
                        
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-8">
                            <h4 class="font-bold text-slate-700 mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input type="text" id="new-u-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="input-std text-sm h-12">
                                <input type="password" id="new-u-pin" placeholder="Ø§Ù„Ø±Ù…Ø² (4 Ø£Ø±Ù‚Ø§Ù…)" class="input-std text-sm h-12 font-mono" maxlength="4">
                                <select id="new-u-role" class="input-std text-sm bg-white cursor-pointer h-12" onchange="togglePermissionsEditor()">
                                    <option value="staff">Ù…ÙˆØ¸Ù (Ù…Ø­Ø¯ÙˆØ¯)</option>
                                    <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… (ÙƒØ§Ù…Ù„)</option>
                                </select>
                                <button onclick="addNewUser()" class="bg-slate-800 hover:bg-slate-900 text-white rounded-xl font-bold shadow-lg transition h-12 flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ©
                                </button>
                            </div>
                        </div>

                        <div id="permissions-editor" class="hidden mb-8 p-6 bg-indigo-50 rounded-2xl border border-indigo-100">
                            <h4 class="font-bold text-indigo-900 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-shield-halved"></i> ØªØ­Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-indigo-600 rounded" value="receipts" checked>
                                    <span class="font-bold text-slate-700">Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-rose-600 rounded" value="payments" checked>
                                    <span class="font-bold text-slate-700">Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-indigo-600 rounded" value="parents" checked>
                                    <span class="font-bold text-slate-700">Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-amber-600 rounded" value="reports" checked>
                                    <span class="font-bold text-slate-700">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-cyan-600 rounded" value="daily" checked>
                                    <span class="font-bold text-slate-700">Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
                                </label>
                                <label class="flex items-center gap-3 bg-white p-3 rounded-xl cursor-pointer hover:shadow-md transition">
                                    <input type="checkbox" class="perm-check w-5 h-5 text-purple-600 rounded" value="logs" checked>
                                    <span class="font-bold text-slate-700">Ø§Ù„Ø³Ø¬Ù„Ø§Øª</span>
                                </label>
                            </div>
                        </div>

                        <!-- Users Table - THIS IS THE FIX -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-right text-sm">
                                <thead class="bg-slate-100 text-slate-600 font-bold border-b border-slate-200">
                                    <tr>
                                        <th class="p-4">Ø§Ù„Ø§Ø³Ù…</th>
                                        <th class="p-4">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                                        <th class="p-4">Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø³Ù…ÙˆØ­</th>
                                        <th class="p-4">Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„</th>
                                        <th class="p-4">Ø§Ù„Ø±Ù…Ø²</th>
                                        <th class="p-4">Ø¥Ø¯Ø§Ø±Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="font-bold divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-200 lg:col-span-2">
                        <h3 class="font-bold text-xl mb-4 text-green-700 flex items-center gap-2">
                            <i class="fa-solid fa-file-excel text-green-600"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel
                        </h3>
                        <div class="p-6 bg-green-50 rounded-2xl border border-green-100">
                            <div class="flex items-center gap-4 mb-4">
                                <input type="file" accept=".xlsx,.xls" onchange="importExcel(this)" class="block w-full text-sm text-green-800 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 cursor-pointer">
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-green-200">
                                <p class="text-sm text-green-800 font-bold mb-2">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Ù…Ù„Ù Excel:</p>
                                <div class="flex flex-wrap gap-2 text-xs font-mono">
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">A: Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">B: Ø§Ù„Ù‡Ø§ØªÙ</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">C: Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">D: Ø§Ø³Ù… Ø§Ù„Ø£Ù…</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">E: Ø§Ù„ØµÙ</span>
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg">F: Ø§Ù„Ø±Ø³ÙˆÙ…</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="print-area" class="hidden"></div>
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBPdIGZ-V1efsO4Ohzq6ioRoBR4YyDzQb0",
            authDomain: "schoolsystem-7be7a.firebaseapp.com",
            projectId: "schoolsystem-7be7a",
            storageBucket: "schoolsystem-7be7a.firebasestorage.app",
            messagingSenderId: "191775387521",
            appId: "1:191775387521:web:9009678837327f697d8280"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const dbCloud = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // State Management
        window.db = { 
            schoolName: 'Ù…Ø¯Ø±Ø³ØªÙŠ', 
            logo: '', 
            users: [
                {
                    id: 1, 
                    name: 'admin', 
                    pin: '1111', 
                    role: 'admin', 
                    lastLogin: '-',
                    permissions: ['all']
                }
            ], 
            grades: [
                {id: 1, name: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„', price: 1000, order: 1},
                {id: 2, name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ', price: 1200, order: 2}
            ], 
            years: ['2025-2026'], 
            currentYear: '2025-2026' 
        };
        
        window.yearData = { '2025-2026': { parents: [], transactions: [], dailyNotes: {} } };
        
        let currentUser = null;
        let pinBuffer = "";
        let tempStudentsBuffer = [];
        let activeParentReceipt = null;
        let currentParentId = null;
        let editingStudentsParentId = null;
        let editingStudents = [];
        let selectedUserForPin = null;
        let restoreBuffer = null;
        let currentFilteredDebtors = [];

        // Auth Functions
        window.signInWithGoogle = async () => {
            try {
                document.getElementById('login-status').classList.remove('hidden');
                await signInWithPopup(auth, provider);
            } catch(err) {
                alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + err.message);
                document.getElementById('login-status').classList.add('hidden');
            }
        };

        window.fullLogout = async () => {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) {
                await signOut(auth);
                location.reload();
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('view-google-login').classList.add('hidden');
                document.getElementById('cloud-email-display').innerText = user.email;
                await loadData(user.email);
                showYearSelection();
            }
        });

        async function loadData(email) {
            try {
                const snap = await getDoc(doc(dbCloud, "schools", email));
                if (snap.exists()) {
                    const data = snap.data();
                    window.db = data.global || window.db;
                    window.yearData = data.years || window.yearData;
                } else {
                    await window.saveToCloud();
                }
            } catch (e) {
                console.error("Error loading data:", e);
                showToast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©");
            }
        }

        window.saveToCloud = async () => {
            if(auth.currentUser) {
                try {
                    await setDoc(doc(dbCloud, "schools", auth.currentUser.email), {
                        global: window.db,
                        years: window.yearData
                    });
                    showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© âœ…");
                } catch (e) {
                    console.error("Error saving:", e);
                    showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
                }
            }
        };

        // Year Selection
        function showYearSelection() {
            const container = document.getElementById('years-grid');
            container.innerHTML = window.db.years.map(year => `
                <button onclick="selectYear('${year}')" class="p-8 rounded-3xl border-2 ${year === window.db.currentYear ? 'border-indigo-500 bg-indigo-50 text-indigo-700 shadow-lg shadow-indigo-200' : 'border-slate-200 bg-white text-slate-700 hover:border-indigo-300'} transition-all font-bold text-xl flex flex-col items-center gap-4 group">
                    <div class="w-16 h-16 ${year === window.db.currentYear ? 'bg-indigo-500 text-white' : 'bg-slate-100 text-slate-400 group-hover:bg-indigo-100 group-hover:text-indigo-600'} rounded-2xl flex items-center justify-center text-3xl transition-all">
                        <i class="fa-solid fa-calendar-check"></i>
                    </div>
                    <span>${year}</span>
                    ${year === window.db.currentYear ? '<span class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded-lg shadow-md">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</span>' : ''}
                </button>
            `).join('');
            document.getElementById('view-year-select').classList.remove('hidden');
        }

        window.selectYear = (year) => {
            window.db.currentYear = year;
            if (!window.yearData[year]) {
                window.yearData[year] = { parents: [], transactions: [], dailyNotes: {} };
            }
            document.getElementById('view-year-select').classList.add('hidden');
            document.getElementById('view-pin-login').classList.remove('hidden');
            document.getElementById('current-year-display').innerText = year;
            document.getElementById('dash-year-badge').innerText = year;
            document.getElementById('module-year-badge').innerText = year;
            renderLoginUsers();
        };

        window.createNewYear = () => {
            const input = document.getElementById('new-year-input');
            const year = input.value.trim();
            if (!year || window.db.years.includes(year)) {
                showToast("Ø§Ù„Ø¹Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­!");
                return;
            }
            window.db.years.push(year);
            window.db.years.sort();
            window.yearData[year] = { parents: [], transactions: [], dailyNotes: {} };
            window.saveToCloud();
            input.value = '';
            showYearSelection();
            showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
        };

        window.changeYear = () => {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-modules').classList.add('hidden');
            document.getElementById('view-pin-login').classList.add('hidden');
            showYearSelection();
        };

        function renderLoginUsers() {
            const container = document.getElementById('login-users-container');
            container.innerHTML = window.db.users.map(u => `
                <button onclick="selectUserForPin(${u.id})" class="w-full p-4 bg-white/10 hover:bg-white/20 border border-white/10 rounded-xl text-right transition flex items-center gap-3 group">
                    <div class="w-10 h-10 rounded-lg bg-indigo-500/30 flex items-center justify-center text-lg">
                        ${u.role === 'admin' ? 'ğŸ‘‘' : 'ğŸ‘¤'}
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-white">${u.name}</div>
                        <div class="text-xs text-indigo-200">${u.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…' : 'Ù…ÙˆØ¸Ù'}</div>
                    </div>
                    <i class="fa-solid fa-chevron-left text-white/50 group-hover:text-white transition"></i>
                </button>
            `).join('');
        }

        window.selectUserForPin = (userId) => {
            selectedUserForPin = window.db.users.find(u => u.id === userId);
            document.getElementById('pin-target-name').textContent = selectedUserForPin.name;
            document.getElementById('pin-pad-area').classList.remove('opacity-50', 'pointer-events-none');
            clearPin();
        };

        window.typePin = (num) => {
            if(pinBuffer.length < 4) {
                pinBuffer += num;
                updatePinDots();
            }
        };

        window.clearPin = () => {
            pinBuffer = '';
            updatePinDots();
            document.getElementById('pin-error').style.opacity = '0';
        };

        function updatePinDots() {
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById(`pd-${i}`);
                if(i <= pinBuffer.length) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            }
        }

        window.submitPin = async () => {
            if(!selectedUserForPin) return;
            
            if(pinBuffer === selectedUserForPin.pin) {
                currentUser = selectedUserForPin;
                currentUser.lastLogin = new Date().toLocaleString('ar-LY');
                await window.saveToCloud();
                document.getElementById('view-pin-login').classList.add('hidden');
                initDashboard();
            } else {
                document.getElementById('pin-error').style.opacity = '1';
                setTimeout(clearPin, 1000);
            }
        };

        window.userLogout = () => {
            currentUser = null;
            selectedUserForPin = null;
            pinBuffer = '';
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-modules').classList.add('hidden');
            document.getElementById('view-pin-login').classList.remove('hidden');
            clearPin();
        };

        function initDashboard() {
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('dash-school-name').textContent = window.db.schoolName;
            document.getElementById('dash-year-badge').textContent = window.db.currentYear;
            document.getElementById('current-user-name').textContent = currentUser.name;
            document.getElementById('current-user-role').textContent = currentUser.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…' : 'Ù…ÙˆØ¸Ù';
            
            if(window.db.logo) {
                document.getElementById('dash-logo').src = window.db.logo;
                document.getElementById('dash-logo').classList.remove('hidden');
                document.getElementById('dash-logo-placeholder').classList.add('hidden');
            }
            
            updatePermissions();
        }

        function updatePermissions() {
            const cards = ['receipts', 'payments', 'parents', 'reports', 'daily', 'logs', 'settings'];
            const isAdmin = currentUser.role === 'admin';
            
            cards.forEach(card => {
                const el = document.getElementById(`card-${card}`);
                if(card === 'settings' && !isAdmin) {
                    el.classList.add('disabled');
                } else if(!isAdmin && !currentUser.permissions.includes(card) && !currentUser.permissions.includes('all')) {
                    el.classList.add('disabled');
                } else {
                    el.classList.remove('disabled');
                }
            });
        }

        function hasPermission(module) {
            if(!currentUser) return false;
            if(currentUser.role === 'admin') return true;
            return currentUser.permissions && currentUser.permissions.includes(module);
        }

        window.checkPermissionAndNav = (mod) => {
            if(!hasPermission(mod)) {
                showToast('âš ï¸ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©');
                return;
            }
            nav(mod);
        };

        window.toggleFullScreen = () => {
            if(!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        };

        window.nav = (mod) => {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-modules').classList.remove('hidden');
            document.querySelectorAll('.module-view').forEach(e => e.classList.add('hidden'));
            document.getElementById('mod-'+mod).classList.remove('hidden');
            
            const titles = {
                'parents': 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª', 
                'receipts': 'Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶', 
                'payments': 'Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù', 
                'reports': 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©', 
                'daily': 'Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ', 
                'logs': 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª', 
                'settings': 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©'
            };
            document.getElementById('module-title').innerText = titles[mod];
            
            if(mod === 'parents') initParents();
            if(mod === 'receipts') initReceipts();
            if(mod === 'reports') initReports();
            if(mod === 'daily') initDaily();
            if(mod === 'logs') initLogs();
            if(mod === 'settings') initSettings();
        };

        window.goHome = () => {
            document.getElementById('view-modules').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
        };

        window.showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        function getCurrentData() {
            return window.yearData[window.db.currentYear];
        }

        // Parents Module Functions (abbreviated for space)
        function initParents() {
            const grades = window.db.grades.sort((a,b) => a.order - b.order);
            const gradeSelect = document.getElementById('new-student-grade');
            if(gradeSelect) {
                gradeSelect.innerHTML = grades.map(g => 
                    `<option value="${g.name}" data-price="${g.price}">${g.name} (${g.price.toLocaleString()} Ø¯.Ù„)</option>`
                ).join('');
            }
            renderParentsTable();
            tempStudentsBuffer = [];
            renderTempList();
            const parentName = document.getElementById('parent-name');
            const parentPhone = document.getElementById('parent-phone');
            if(parentName) parentName.value = '';
            if(parentPhone) parentPhone.value = '';
        }

        window.addTempStudent = () => {
            const nameInput = document.getElementById('new-student-name');
            const motherInput = document.getElementById('new-student-mother');
            const sel = document.getElementById('new-student-grade');
            
            if(!nameInput || !sel) return;
            
            const name = nameInput.value.trim();
            const mother = motherInput ? motherInput.value.trim() || "-" : "-";
            const grade = sel.value;
            const price = parseInt(sel.options[sel.selectedIndex].dataset.price) || 0;
            
            if(name) {
                tempStudentsBuffer.push({
                    id: Date.now(),
                    name, 
                    mother, 
                    grade,
                    price
                });
                renderTempList();
                nameInput.value = "";
                if(motherInput) motherInput.value = "";
            }
        };

        function renderTempList() {
            let total = 0;
            const container = document.getElementById('temp-students-list');
            if(!container) return;
            
            container.innerHTML = tempStudentsBuffer.map((s, i) => {
                total += s.price;
                return `
                    <div class="flex justify-between items-center bg-white p-4 rounded-xl border-2 border-slate-100 hover:border-indigo-200 transition group">
                        <div>
                            <span class="font-bold text-slate-700 block">${s.name}</span>
                            <span class="text-slate-400 text-xs">${s.grade} - Ø§Ù„Ø£Ù…: ${s.mother}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg">${s.price.toLocaleString()} Ø¯.Ù„</span>
                            <button onclick="tempStudentsBuffer.splice(${i},1); renderTempList();" class="w-8 h-8 bg-rose-50 text-rose-400 hover:bg-rose-500 hover:text-white rounded-lg transition flex items-center justify-center">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>`;
            }).join('');
            
            const totalCalc = document.getElementById('parent-total-calc');
            if(totalCalc) {
                totalCalc.innerHTML = total.toLocaleString() + ' <span class="text-lg text-slate-400 font-medium">Ø¯.Ù„</span>';
            }
        }

        window.saveFamily = async () => {
            const nameInput = document.getElementById('parent-name');
            const phoneInput = document.getElementById('parent-phone');
            
            if(!nameInput) return;
            
            const name = nameInput.value.trim();
            const phone = phoneInput ? phoneInput.value.trim() : '';
            
            if(!name || tempStudentsBuffer.length === 0) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ÙˆØ¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
                return;
            }
            const total = tempStudentsBuffer.reduce((a,b) => a + b.price, 0);
            const newParent = {
                id: Date.now(),
                name, 
                phone, 
                students: [...tempStudentsBuffer], 
                totalFees: total, 
                paid: 0,
                createdAt: new Date().toLocaleDateString('ar-LY')
            };
            getCurrentData().parents.push(newParent);
            await window.saveToCloud();
            showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            initParents();
        };

        function renderParentsTable(query="") {
            let parents = getCurrentData().parents.slice().reverse();
            if(query) parents = parents.filter(p => p.name.includes(query) || p.phone.includes(query));
            
            const tbody = document.getElementById('parents-list-body');
            if(!tbody) return;
            
            tbody.innerHTML = parents.map(p => {
                const remaining = p.totalFees - p.paid;
                return `
                    <tr class="border-b border-slate-50 hover:bg-slate-50/80 transition group">
                        <td class="p-5 text-slate-400 font-mono text-xs">#${p.id.toString().slice(-4)}</td>
                        <td class="p-5 font-bold text-slate-800">${p.name}</td>
                        <td class="p-5 font-mono text-slate-500 text-xs">${p.phone}</td>
                        <td class="p-5 text-center">
                            <span class="bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-lg text-xs font-bold">${p.students.length}</span>
                        </td>
                        <td class="p-5 font-bold text-slate-700">${p.totalFees.toLocaleString()}</td>
                        <td class="p-5 font-bold text-emerald-600">${p.paid.toLocaleString()}</td>
                        <td class="p-5 font-bold ${remaining > 0 ? 'text-rose-600' : 'text-emerald-600'}">${remaining.toLocaleString()}</td>
                        <td class="p-5">
                            <button onclick="openParentModal(${p.id})" class="bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white px-4 py-2 rounded-xl text-xs font-bold transition ml-1">
                                Ø¹Ø±Ø¶
                            </button>
                            <button onclick="openEditModal(${p.id})" class="bg-amber-50 text-amber-600 hover:bg-amber-600 hover:text-white px-4 py-2 rounded-xl text-xs font-bold transition">
                                ØªØ¹Ø¯ÙŠÙ„
                            </button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="8" class="p-12 text-center text-slate-400 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø§Ø¦Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
        }

        window.filterParentsTable = renderParentsTable;

        window.openParentModal = (id) => {
            const p = getCurrentData().parents.find(x => x.id === id);
            if(!p) return;
            currentParentId = id;
            
            const modal = document.getElementById('parent-modal');
            const nameEl = document.getElementById('modal-p-name');
            const phoneEl = document.getElementById('modal-p-phone');
            const idEl = document.getElementById('modal-p-id');
            const dateEl = document.getElementById('modal-p-date');
            const yearEl = document.getElementById('modal-p-year');
            const studentsList = document.getElementById('modal-students-list');
            const totalEl = document.getElementById('modal-p-total');
            const paidEl = document.getElementById('modal-p-paid');
            const remainingEl = document.getElementById('modal-p-remaining');
            
            if(nameEl) nameEl.innerText = p.name;
            if(phoneEl) phoneEl.innerText = p.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if(idEl) idEl.innerText = '#' + p.id.toString().slice(-4);
            if(dateEl) dateEl.innerText = p.createdAt || '-';
            if(yearEl) yearEl.innerText = window.db.currentYear;
            
            if(studentsList) {
                studentsList.innerHTML = p.students.map(s => `
                    <div class="flex justify-between items-center p-4 hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                        <div>
                            <span class="font-bold text-slate-700 block text-base">${s.name}</span>
                            <span class="text-slate-400 text-xs">Ø§Ù„ØµÙ: ${s.grade} | Ø§Ù„Ø£Ù…: ${s.mother}</span>
                        </div>
                        <span class="font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-xl">${s.price.toLocaleString()} Ø¯.Ù„</span>
                    </div>
                `).join('');
            }
            
            const remaining = p.totalFees - p.paid;
            if(totalEl) totalEl.innerText = p.totalFees.toLocaleString() + ' Ø¯.Ù„';
            if(paidEl) paidEl.innerText = p.paid.toLocaleString() + ' Ø¯.Ù„';
            if(remainingEl) remainingEl.innerText = remaining.toLocaleString() + ' Ø¯.Ù„';
            
            if(modal) modal.classList.remove('hidden');
        };

        window.closeParentModal = () => {
            const modal = document.getElementById('parent-modal');
            if(modal) modal.classList.add('hidden');
        };

        window.openEditModal = (id) => {
            const p = getCurrentData().parents.find(x => x.id === id);
            if(!p) return;
            currentParentId = id;
            
            const editModal = document.getElementById('edit-parent-modal');
            const nameInput = document.getElementById('edit-p-name');
            const phoneInput = document.getElementById('edit-p-phone');
            
            if(nameInput) nameInput.value = p.name;
            if(phoneInput) phoneInput.value = p.phone;
            if(editModal) editModal.classList.remove('hidden');
        };

        window.saveParentEdit = async () => {
            const p = getCurrentData().parents.find(x => x.id == currentParentId);
            if(p) {
                const nameInput = document.getElementById('edit-p-name');
                const phoneInput = document.getElementById('edit-p-phone');
                
                if(nameInput) p.name = nameInput.value;
                if(phoneInput) p.phone = phoneInput.value;
                
                await window.saveToCloud();
                const editModal = document.getElementById('edit-parent-modal');
                if(editModal) editModal.classList.add('hidden');
                renderParentsTable();
                showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
            }
        };

        window.deleteCurrentParent = async () => {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            getCurrentData().parents = getCurrentData().parents.filter(p => p.id !== currentParentId);
            await window.saveToCloud();
            closeParentModal();
            renderParentsTable();
            showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
        };

        // Receipts Functions
        function initReceipts() {
            activeParentReceipt = null;
            const searchInput = document.getElementById('rec-search');
            const infoCard = document.getElementById('rec-info-card');
            const amountInput = document.getElementById('rec-amount');
            const refInput = document.getElementById('rec-ref');
            
            if(searchInput) searchInput.value = '';
            if(infoCard) infoCard.classList.add('hidden');
            if(amountInput) amountInput.value = '';
            if(refInput) refInput.value = '';
            
            renderRecentReceipts();
        }

        window.searchParent = (q) => {
            const res = document.getElementById('rec-results');
            if(!res) return;
            
            if(q.length < 1) { res.classList.add('hidden'); return; }
            
            const matches = getCurrentData().parents.filter(p => 
                p.name.includes(q) || p.phone.includes(q)
            );
            
            matches.sort((a, b) => {
                const aExact = a.name.startsWith(q) || a.phone === q;
                const bExact = b.name.startsWith(q) || b.phone === q;
                return bExact - aExact;
            });
            
            res.innerHTML = matches.map(p => {
                const remaining = p.totalFees - p.paid;
                const nameHighlighted = p.name.replace(new RegExp(q, 'gi'), match => `<span class="search-highlight">${match}</span>`);
                const phoneHighlighted = p.phone.replace(new RegExp(q, 'gi'), match => `<span class="search-highlight">${match}</span>`);
                
                return `
                    <div onclick="selectParentForReceipt(${p.id})" class="p-4 hover:bg-slate-50 border-b border-slate-100 cursor-pointer flex justify-between items-center transition bg-white">
                        <div class="flex-1">
                            <div class="font-bold text-slate-800 text-lg mb-1">${nameHighlighted}</div>
                            <div class="text-xs text-slate-500 font-mono">${phoneHighlighted}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold ${remaining > 0 ? 'text-rose-500' : 'text-emerald-500'} mb-1">
                                ${remaining > 0 ? 'Ù…Ø³ØªØ­Ù‚: ' + remaining.toLocaleString() : 'Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„'}
                            </div>
                            <div class="text-[10px] text-slate-400">${p.students.length} Ø·Ø§Ù„Ø¨</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            res.classList.remove('hidden');
        };

        window.selectParentForReceipt = (parentId) => {
            activeParentReceipt = getCurrentData().parents.find(p => p.id === parentId);
            const results = document.getElementById('rec-results');
            const infoCard = document.getElementById('rec-info-card');
            const nameEl = document.getElementById('rec-p-name');
            const idEl = document.getElementById('rec-p-id');
            const phoneEl = document.getElementById('rec-p-phone');
            const debtEl = document.getElementById('rec-p-debt');
            const studentsEl = document.getElementById('rec-students-preview');
            
            if(results) results.classList.add('hidden');
            if(infoCard) infoCard.classList.remove('hidden');
            if(nameEl) nameEl.textContent = activeParentReceipt.name;
            if(idEl) idEl.textContent = "#" + activeParentReceipt.id.toString().slice(-4);
            if(phoneEl) phoneEl.textContent = activeParentReceipt.phone || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
            
            const debt = activeParentReceipt.totalFees - activeParentReceipt.paid;
            if(debtEl) debtEl.textContent = debt.toLocaleString();
            if(studentsEl) studentsEl.textContent = activeParentReceipt.students.map(s => s.name).join('ØŒ ');
        };

        window.toggleBankInfo = () => {
            const method = document.getElementById('rec-method');
            const bankField = document.getElementById('bank-field');
            if(method && bankField) {
                bankField.classList.toggle('hidden', method.value === 'Ù†Ù‚Ø¯Ø§Ù‹');
            }
        };

        window.printReceipt = async () => {
            if(!activeParentReceipt) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }
            
            const amountInput = document.getElementById('rec-amount');
            const amt = parseInt(amountInput ? amountInput.value : 0);
            
            if(!amt || amt <= 0) {
                showToast("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±");
                return;
            }
            
            const oldDebt = activeParentReceipt.totalFees - activeParentReceipt.paid;
            if(amt > oldDebt) {
                showToast("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ù„ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚!");
                return;
            }
            
            const methodSelect = document.getElementById('rec-method');
            const refInput = document.getElementById('rec-ref');
            
            const method = methodSelect ? methodSelect.value : 'Ù†Ù‚Ø¯Ø§Ù‹';
            const ref = refInput ? refInput.value : '-';
            
            activeParentReceipt.paid += amt;
            
            const txn = {
                id: Date.now(),
                type: 'in',
                parentId: activeParentReceipt.id,
                parentName: activeParentReceipt.name,
                amount: amt,
                method: method,
                ref: ref || '-',
                date: new Date().toLocaleDateString('ar-LY'),
                time: new Date().toLocaleTimeString('ar-LY'),
                by: currentUser.name,
                year: window.db.currentYear
            };
            
            getCurrentData().transactions.push(txn);
            await window.saveToCloud();
            
            printReceiptHTML(txn, activeParentReceipt, oldDebt, amt);
        };

        function printReceiptHTML(txn, parent, oldDebt, amt) {
            const logoHTML = window.db.logo ? `<img src="${window.db.logo}" style="height:70px; float:right; margin-left:15px;">` : '';
            const printArea = document.getElementById('print-area');
            if(!printArea) return;
            
            printArea.innerHTML = `
                <div style="padding:20mm; font-family:Tajawal, Arial; direction:rtl; border:3px double #333; min-height:140mm; position:relative; background:#fff;">
                    <div style="text-align:center; border-bottom:3px double #000; padding-bottom:15px; margin-bottom:25px; overflow:hidden;">
                        ${logoHTML}
                        <h1 style="font-size:28px; font-weight:900; margin:0; color:#000;">${window.db.schoolName}</h1>
                        <p style="margin:8px 0; font-size:16px; color:#333;">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ Ø±Ø³Ù…ÙŠ - Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ${window.db.currentYear}</p>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin-bottom:25px; font-size:14px; border:1px solid #ddd; padding:10px; border-radius:8px;">
                        <span><b>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</b> #${txn.id.toString().slice(-6)}</span>
                        <span><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${txn.date}</span>
                        <span><b>Ø§Ù„ÙˆÙ‚Øª:</b> ${txn.time}</span>
                    </div>
                    
                    <div style="line-height:2.2; font-size:16px; margin-bottom:30px;">
                        <p style="font-size:18px; margin-bottom:15px;"><b>Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ¯/Ø©:</b> <span style="border-bottom:2px dotted #999; padding:0 20px; font-weight:bold; font-size:20px;">${txn.parentName}</span></p>
                        <p style="font-size:18px; margin-bottom:15px;"><b>Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:</b> <span style="background:#f0fdf4; border:2px solid #86efac; padding:5px 20px; font-weight:bold; font-size:24px; color:#059669; border-radius:8px;">${amt.toLocaleString()} Ø¯.Ù„</span></p>
                        <p style="font-size:16px;"><b>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</b> ${txn.method} ${txn.ref !== '-' ? '(' + txn.ref + ')' : ''}</p>
                    </div>
                    
                    <table style="width:100%; border-collapse:collapse; text-align:center; font-size:14px; margin:30px 0; border:2px solid #333;">
                        <tr style="background:#f8fafc;">
                            <td style="border:2px solid #333; padding:12px; font-weight:bold; width:33%;">Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚</td>
                            <td style="border:2px solid #333; padding:12px; font-weight:bold; width:33%;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</td>
                            <td style="border:2px solid #333; padding:12px; font-weight:bold; width:33%;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</td>
                        </tr>
                        <tr>
                            <td style="border:2px solid #333; padding:15px; font-size:18px;">${oldDebt.toLocaleString()}</td>
                            <td style="border:2px solid #333; padding:15px; font-size:20px; color:#059669; font-weight:bold; background:#f0fdf4;">${amt.toLocaleString()}</td>
                            <td style="border:2px solid #333; padding:15px; font-size:18px; color:#dc2626; font-weight:bold;">${(oldDebt - amt).toLocaleString()}</td>
                        </tr>
                    </table>
                    
                    <div style="display:flex; justify-content:space-between; margin-top:60px; font-size:14px;">
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; margin-bottom:5px; font-weight:bold;">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</div>
                            <div style="color:#666; font-size:12px;">${currentUser.name}</div>
                        </div>
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; margin-bottom:5px; font-weight:bold;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
                            <div style="color:#666; font-size:12px;">${txn.parentName}</div>
                        </div>
                    </div>
                </div>
            `;
            printArea.classList.remove('hidden');
            window.print();
            setTimeout(() => {
                printArea.classList.add('hidden');
                goHome();
            }, 1000);
        }

        function renderRecentReceipts() {
            const list = document.getElementById('recent-receipts-list');
            if(!list) return;
            
            const txns = getCurrentData().transactions.filter(t => t.type === 'in').slice(-15).reverse();
            list.innerHTML = txns.map(t => `
                <li class="flex justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-white hover:shadow-md transition cursor-pointer" onclick="selectParentForReceipt(${t.parentId})">
                    <div>
                        <span class="block font-bold text-slate-700">${t.parentName}</span>
                        <span class="text-[11px] text-slate-400 font-mono">${t.date} | ${t.by}</span>
                    </div>
                    <span class="font-black text-emerald-600 text-lg">${t.amount.toLocaleString()}</span>
                </li>
            `).join('') || '<p class="text-slate-400 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©</p>';
        }

        window.printPayment = async () => {
            const toInput = document.getElementById('pay-to');
            const amountInput = document.getElementById('pay-amount');
            const reasonInput = document.getElementById('pay-reason');
            const catSelect = document.getElementById('pay-cat');
            
            const to = toInput ? toInput.value.trim() : '';
            const amt = parseInt(amountInput ? amountInput.value : 0);
            const reason = reasonInput ? reasonInput.value.trim() : '';
            
            if(!to || !amt) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© ÙˆØ§Ù„Ù…Ø¨Ù„Øº");
                return;
            }
            
            const txn = {
                id: Date.now(),
                type: 'out',
                pName: to,
                amount: amt,
                category: catSelect ? catSelect.value : 'Ø£Ø®Ø±Ù‰',
                reason: reason,
                date: new Date().toLocaleDateString('ar-LY'),
                time: new Date().toLocaleTimeString('ar-LY'),
                by: currentUser.name,
                year: window.db.currentYear
            };
            
            getCurrentData().transactions.push(txn);
            await window.saveToCloud();
            
            printPaymentHTML(txn, to, amt, reason);
        };

        function printPaymentHTML(txn, to, amt, reason) {
            const printArea = document.getElementById('print-area');
            if(!printArea) return;
            
            printArea.innerHTML = `
                <div style="padding:20mm; font-family:Tajawal, Arial; direction:rtl; border:3px double #333; min-height:140mm; background:#fff;">
                    <div style="text-align:center; border-bottom:3px double #000; padding-bottom:15px; margin-bottom:25px;">
                        <h1 style="font-size:28px; font-weight:900; margin:0;">Ø³Ù†Ø¯ ØµØ±Ù Ù†Ù‚Ø¯ÙŠ</h1>
                        <p style="margin:8px 0; font-size:16px; color:#666;">${window.db.schoolName} - ${window.db.currentYear}</p>
                    </div>
                    
                    <div style="line-height:2.5; font-size:18px;">
                        <p><b>ØµØ±ÙÙ†Ø§ Ù„Ù„Ø³ÙŠØ¯/Ø©:</b> <span style="border-bottom:2px dotted #999; padding:0 20px; font-weight:bold; font-size:22px;">${to}</span></p>
                        <p><b>Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:</b> <span style="background:#fff1f2; border:2px solid #fda4af; padding:5px 20px; font-weight:bold; font-size:26px; color:#e11d48; border-radius:8px;">${amt.toLocaleString()} Ø¯.Ù„</span></p>
                        <p><b>Ø§Ù„ØªØµÙ†ÙŠÙ:</b> ${txn.category}</p>
                        <p><b>Ø§Ù„Ø¨ÙŠØ§Ù†:</b> ${reason || '---'}</p>
                        <p><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${txn.date}</p>
                    </div>
                    
                    <div style="margin-top:80px; display:flex; justify-content:space-between; font-size:14px;">
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; font-weight:bold;">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</div>
                            <div style="color:#666; font-size:12px;">${currentUser.name}</div>
                        </div>
                        <div style="text-align:center; width:150px;">
                            <div style="border-top:2px solid #000; padding-top:10px; font-weight:bold;">Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
                        </div>
                    </div>
                </div>
            `;
            printArea.classList.remove('hidden');
            window.print();
            setTimeout(() => {
                printArea.classList.add('hidden');
                goHome();
            }, 1000);
        }

        // Reports Functions
        function initReports() {
            applyDebtFilters();
        }

        window.applyDebtFilters = () => {
            const data = getCurrentData();
            const minDebtInput = document.getElementById('filter-min-debt');
            const maxDebtInput = document.getElementById('filter-max-debt');
            const percentageSelect = document.getElementById('filter-percentage');
            
            const minDebt = parseFloat(minDebtInput ? minDebtInput.value : 0) || 0;
            const maxDebt = parseFloat(maxDebtInput ? maxDebtInput.value : Infinity) || Infinity;
            const percentage = parseInt(percentageSelect ? percentageSelect.value : 0) || 0;
            
            const totalIn = data.transactions.filter(t => t.type === 'in').reduce((a,b) => a + b.amount, 0);
            const totalOut = data.transactions.filter(t => t.type === 'out').reduce((a,b) => a + b.amount, 0);
            let totalDebt = 0;
            
            let debtors = data.parents.filter(p => {
                const remaining = p.totalFees - p.paid;
                if (remaining <= 0) return false;
                
                const percentRemaining = p.totalFees > 0 ? (remaining / p.totalFees) * 100 : 0;
                
                const matchDebt = remaining >= minDebt && remaining <= maxDebt;
                const matchPercent = percentage === 0 || percentRemaining >= percentage;
                
                return matchDebt && matchPercent;
            }).sort((a,b) => (b.totalFees - b.paid) - (a.totalFees - a.paid));
            
            currentFilteredDebtors = debtors;
            totalDebt = debtors.reduce((sum, p) => sum + (p.totalFees - p.paid), 0);
            
            const repTotalIn = document.getElementById('rep-total-in');
            const repTotalOut = document.getElementById('rep-total-out');
            const repBalance = document.getElementById('rep-balance');
            const repTotalDebt = document.getElementById('rep-total-debt');
            const filterCount = document.getElementById('filter-count');
            
            if(repTotalIn) repTotalIn.innerText = totalIn.toLocaleString() + ' Ø¯.Ù„';
            if(repTotalOut) repTotalOut.innerText = totalOut.toLocaleString() + ' Ø¯.Ù„';
            if(repBalance) repBalance.innerText = (totalIn - totalOut).toLocaleString() + ' Ø¯.Ù„';
            if(repTotalDebt) repTotalDebt.innerText = totalDebt.toLocaleString() + ' Ø¯.Ù„';
            if(filterCount) filterCount.innerText = `Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${debtors.length}`;
            
            const tbody = document.getElementById('report-debt-body');
            const noResults = document.getElementById('no-results-msg');
            
            if (debtors.length === 0) {
                if(tbody) tbody.innerHTML = '';
                if(noResults) noResults.classList.remove('hidden');
            } else {
                if(noResults) noResults.classList.add('hidden');
                if(tbody) {
                    tbody.innerHTML = debtors.map((p, idx) => {
                        const remaining = p.totalFees - p.paid;
                        const paidPercent = p.totalFees > 0 ? Math.round((p.paid / p.totalFees) * 100) : 0;
                        
                        return `
                            <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                                <td class="p-4 text-slate-400">${idx + 1}</td>
                                <td class="p-4 font-bold text-slate-800">${p.name}</td>
                                <td class="p-4 font-mono text-xs text-slate-500">${p.phone}</td>
                                <td class="p-4 text-center">${p.students.length}</td>
                                <td class="p-4 font-bold">${p.totalFees.toLocaleString()}</td>
                                <td class="p-4 text-emerald-600 font-bold">${p.paid.toLocaleString()}</td>
                                <td class="p-4 text-rose-600 font-black text-lg">${remaining.toLocaleString()}</td>
                                <td class="p-4">
                                    <div class="w-full bg-slate-200 rounded-full h-2.5 mb-1">
                                        <div class="bg-emerald-500 h-2.5 rounded-full" style="width: ${paidPercent}%"></div>
                                    </div>
                                    <span class="text-xs text-slate-500">${paidPercent}% Ù…Ø³Ø¯Ø¯</span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }
        };

        window.resetFilters = () => {
            const minDebtInput = document.getElementById('filter-min-debt');
            const maxDebtInput = document.getElementById('filter-max-debt');
            const percentageSelect = document.getElementById('filter-percentage');
            
            if(minDebtInput) minDebtInput.value = '';
            if(maxDebtInput) maxDebtInput.value = '';
            if(percentageSelect) percentageSelect.value = '0';
            
            applyDebtFilters();
        };

        window.printReport = () => {
            const printArea = document.getElementById('print-area');
            const reportPrintArea = document.getElementById('report-print-area');
            const minDebtInput = document.getElementById('filter-min-debt');
            const maxDebtInput = document.getElementById('filter-max-debt');
            const percentageSelect = document.getElementById('filter-percentage');
            
            if(!printArea || !reportPrintArea) return;
            
            const filtersText = `
                ${minDebtInput && minDebtInput.value ? 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰: ' + minDebtInput.value + ' Ø¯.Ù„ | ' : ''}
                ${maxDebtInput && maxDebtInput.value ? 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ' + maxDebtInput.value + ' Ø¯.Ù„ | ' : ''}
                ${percentageSelect && percentageSelect.value !== '0' ? 'Ù†Ø³Ø¨Ø© Ø¹Ø¯Ù… Ø§Ù„Ø³Ø¯Ø§Ø¯: ' + percentageSelect.value + '%' : 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨'}
            `;
            
            printArea.innerHTML = `
                <div style="padding:15mm; font-family:Tajawal; direction:rtl;">
                    <h1 style="text-align:center; margin-bottom:10px; font-size:24px; font-weight:900;">ÙƒØ´Ù Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</h1>
                    <h2 style="text-align:center; margin-bottom:30px; color:#666; font-size:16px;">${window.db.schoolName} - Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ${window.db.currentYear}</h2>
                    <div style="margin-bottom:20px; padding:10px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; font-size:12px;">
                        <b>Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©:</b> ${filtersText}
                    </div>
                    ${reportPrintArea.innerHTML}
                    <div style="margin-top:50px; text-align:center; font-size:12px; color:#999; border-top:1px solid #eee; padding-top:10px;">
                        ØªÙ… Ø·Ø¨Ø§Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ØªØ§Ø±ÙŠØ® ${new Date().toLocaleDateString('ar-LY')} Ø¨ÙˆØ§Ø³Ø·Ø© ${currentUser ? currentUser.name : ''} | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª: ${currentFilteredDebtors.length}
                    </div>
                </div>
            `;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
        };

        // Daily Closing Functions
        function initDaily() {
            const datePicker = document.getElementById('daily-date-picker');
            if(datePicker) datePicker.valueAsDate = new Date();
            loadDailyClosing();
        }

        window.loadDailyClosing = () => {
            const datePicker = document.getElementById('daily-date-picker');
            if(!datePicker) return;
            
            const date = new Date(datePicker.value);
            const dateDisplay = document.getElementById('daily-date-display');
            if(dateDisplay) dateDisplay.innerText = date.toLocaleDateString('ar-LY', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            
            const data = getCurrentData();
            const dateStr = date.toLocaleDateString('ar-LY');
            const dayTxns = data.transactions.filter(t => t.date === dateStr);
            
            const inTxns = dayTxns.filter(t => t.type === 'in');
            const outTxns = dayTxns.filter(t => t.type === 'out');
            
            const inList = document.getElementById('daily-in-list');
            const outList = document.getElementById('daily-out-list');
            
            if(inList) {
                inList.innerHTML = inTxns.map(t => `
                    <div class="flex justify-between text-sm border-b border-emerald-100 py-3 hover:bg-emerald-50/50 px-2 transition rounded-lg">
                        <div>
                            <span class="font-bold text-slate-700 block">${t.parentName}</span>
                            <span class="text-xs text-slate-400">${t.by}</span>
                        </div>
                        <span class="font-bold text-emerald-600">${t.amount.toLocaleString()} Ø¯.Ù„</span>
                    </div>
                `).join('') || '<div class="text-center text-emerald-400 py-8 text-sm font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</div>';
            }
            
            if(outList) {
                outList.innerHTML = outTxns.map(t => `
                    <div class="flex justify-between text-sm border-b border-rose-100 py-3 hover:bg-rose-50/50 px-2 transition rounded-lg">
                        <div>
                            <span class="font-bold text-slate-700 block">${t.pName}</span>
                            <span class="text-xs text-slate-400">${t.category}</span>
                        </div>
                        <span class="font-bold text-rose-600">${t.amount.toLocaleString()} Ø¯.Ù„</span>
                    </div>
                `).join('') || '<div class="text-center text-rose-400 py-8 text-sm font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</div>';
            }
            
            const inTotal = inTxns.reduce((a,b) => a+b.amount, 0);
            const outTotal = outTxns.reduce((a,b) => a+b.amount, 0);
            
            const inTotalEl = document.getElementById('daily-in-total');
            const outTotalEl = document.getElementById('daily-out-total');
            const netEl = document.getElementById('daily-net');
            const notesArea = document.getElementById('daily-notes');
            
            if(inTotalEl) inTotalEl.innerText = inTotal.toLocaleString() + ' Ø¯.Ù„';
            if(outTotalEl) outTotalEl.innerText = outTotal.toLocaleString() + ' Ø¯.Ù„';
            if(netEl) netEl.innerText = (inTotal - outTotal).toLocaleString() + ' Ø¯.Ù„';
            if(notesArea) notesArea.value = data.dailyNotes?.[datePicker.value] || '';
        };

        window.saveDailyNotes = async () => {
            const datePicker = document.getElementById('daily-date-picker');
            const notesArea = document.getElementById('daily-notes');
            if(!datePicker || !notesArea) return;
            
            const date = datePicker.value;
            if(!getCurrentData().dailyNotes) getCurrentData().dailyNotes = {};
            getCurrentData().dailyNotes[date] = notesArea.value;
            await window.saveToCloud();
            showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª");
        };

        window.printDailyClosing = () => {
            window.print();
        };

        // Logs Functions
        function initLogs() {
            filterLogs();
        }

        window.filterLogs = () => {
            const searchInput = document.getElementById('logs-search');
            const filterSelect = document.getElementById('logs-filter');
            
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            const filter = filterSelect ? filterSelect.value : 'all';
            
            let txns = getCurrentData().transactions.slice().reverse();
            
            if(filter !== 'all') txns = txns.filter(t => t.type === filter);
            if(search) txns = txns.filter(t => {
                const name = (t.parentName || t.pName || '').toLowerCase();
                return name.includes(search);
            });
            
            const tbody = document.getElementById('logs-table-body');
            if(!tbody) return;
            
            tbody.innerHTML = txns.map(t => `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                    <td class="p-4 text-xs font-mono text-slate-400">#${t.id.toString().slice(-6)}</td>
                    <td class="p-4 text-xs">
                        <span class="block font-bold">${t.date}</span>
                        <span class="text-slate-400">${t.time}</span>
                    </td>
                    <td class="p-4">
                        <span class="px-3 py-1.5 rounded-lg text-xs font-bold ${t.type === 'in' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}">
                            ${t.type === 'in' ? 'Ù‚Ø¨Ø¶' : 'ØµØ±Ù'}
                        </span>
                    </td>
                    <td class="p-4 font-bold text-slate-800">${t.parentName || t.pName}</td>
                    <td class="p-4 font-bold text-lg ${t.type === 'in' ? 'text-emerald-600' : 'text-rose-600'}">${t.amount.toLocaleString()}</td>
                    <td class="p-4 text-xs font-mono text-slate-500">${t.method || t.category || '-'}</td>
                    <td class="p-4 text-xs text-slate-500">${t.by}</td>
                    <td class="p-4 text-center">
                        <button onclick="reprintTransaction(${t.id})" class="w-8 h-8 bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white rounded-lg transition flex items-center justify-center mx-auto" title="Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©">
                            <i class="fa-solid fa-print text-xs"></i>
                        </button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="8" class="p-8 text-center text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</td></tr>';
        };

        window.reprintTransaction = async (txnId) => {
            const txn = getCurrentData().transactions.find(t => t.id === txnId);
            if(!txn) {
                showToast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
                return;
            }
            
            if(txn.type === 'in') {
                const parent = getCurrentData().parents.find(p => p.id === txn.parentId);
                if(parent) {
                    const currentDebt = parent.totalFees - parent.paid;
                    const oldDebt = currentDebt + txn.amount;
                    printReceiptHTML(txn, parent, oldDebt, txn.amount);
                }
            } else {
                printPaymentHTML(txn, txn.pName, txn.amount, txn.reason);
            }
        };

        // Settings Functions - FIXED TO SHOW USERS AND YEARS
        function initSettings() {
            const schoolNameInput = document.getElementById('set-school-name');
            const logoPreview = document.getElementById('logo-preview');
            
            if(schoolNameInput) schoolNameInput.value = window.db.schoolName;
            if(logoPreview && window.db.logo) {
                logoPreview.innerHTML = `<img src="${window.db.logo}" class="w-full h-full object-contain">`;
            }
            
            renderGrades();
            renderUsersTable(); // This will now work
            renderSettingsYearsList(); // This will now show years with delete buttons
            
            const yearOpts = window.db.years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            const currentYearSelect = document.getElementById('settings-current-year');
            const promoteFromSelect = document.getElementById('promote-from-year');
            const promoteToSelect = document.getElementById('promote-to-year');
            
            if(currentYearSelect) {
                currentYearSelect.innerHTML = yearOpts;
                currentYearSelect.value = window.db.currentYear;
            }
            if(promoteFromSelect) promoteFromSelect.innerHTML = yearOpts;
            if(promoteToSelect) promoteToSelect.innerHTML = yearOpts;
        }

        // FIXED: Function to render years list in settings
        window.renderSettingsYearsList = function() {
            const container = document.getElementById('settings-years-list');
            if(!container) {
                console.error('settings-years-list container not found');
                return;
            }
            
            if(!window.db.years || window.db.years.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center col-span-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹ÙˆØ§Ù… Ù…Ø³Ø¬Ù„Ø©</p>';
                return;
            }
            
            container.innerHTML = window.db.years.map(year => {
                const isCurrent = year === window.db.currentYear;
                const canDelete = window.db.years.length > 1 && !isCurrent;
                
                return `
                    <div class="bg-white border border-slate-200 rounded-xl p-3 flex justify-between items-center shadow-sm hover:shadow-md transition ${isCurrent ? 'ring-2 ring-indigo-200 bg-indigo-50' : ''}">
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-700 ${isCurrent ? 'text-indigo-700' : ''}">
                                ${year}
                            </span>
                            ${isCurrent ? '<span class="text-[10px] text-indigo-500 font-bold">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ</span>' : ''}
                        </div>
                        ${canDelete ? `
                            <button onclick="deleteYear('${year}')" class="text-rose-400 hover:text-rose-600 hover:bg-rose-50 w-8 h-8 rounded-lg transition flex items-center justify-center" title="Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù… ${year}">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        ` : '<span class="text-xs text-slate-400" title="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ø¢Ø®Ø± Ø¹Ø§Ù…">' + (isCurrent ? 'Ø§Ù„Ø­Ø§Ù„ÙŠ' : 'Ù…Ø­Ù…ÙŠ') + '</span>'}
                    </div>
                `;
            }).join('');
        };

        // FIXED: Function to delete year
        window.deleteYear = async function(year) {
            if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ${year}ØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ.`)) {
                return;
            }
            
            if(year === window.db.currentYear) {
                showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ! Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }
            
            // Remove year from array
            window.db.years = window.db.years.filter(y => y !== year);
            
            // Remove year data
            if(window.yearData[year]) {
                delete window.yearData[year];
            }
            
            await window.saveToCloud();
            
            // Refresh all year-related displays
            renderSettingsYearsList();
            
            // Update dropdowns
            const yearOpts = window.db.years.map(y => `<option value="${y}">${y}</option>`).join('');
            const currentYearSelect = document.getElementById('settings-current-year');
            const promoteFromSelect = document.getElementById('promote-from-year');
            const promoteToSelect = document.getElementById('promote-to-year');
            
            if(currentYearSelect) {
                currentYearSelect.innerHTML = yearOpts;
                currentYearSelect.value = window.db.currentYear;
            }
            if(promoteFromSelect) promoteFromSelect.innerHTML = yearOpts;
            if(promoteToSelect) promoteToSelect.innerHTML = yearOpts;
            
            showToast(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù… ${year} Ø¨Ù†Ø¬Ø§Ø­`);
        };

        window.saveIdentity = async () => {
            const schoolNameInput = document.getElementById('set-school-name');
            if(schoolNameInput) window.db.schoolName = schoolNameInput.value;
            await window.saveToCloud();
            
            const dashSchoolName = document.getElementById('dash-school-name');
            if(dashSchoolName) dashSchoolName.innerText = window.db.schoolName;
            showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‡ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
        };

        window.handleLogoUpload = (input) => {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                window.db.logo = e.target.result;
                const logoPreview = document.getElementById('logo-preview');
                const dashLogo = document.getElementById('dash-logo');
                const dashLogoPlaceholder = document.getElementById('dash-logo-placeholder');
                
                if(logoPreview) logoPreview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-contain">`;
                if(dashLogo) {
                    dashLogo.src = e.target.result;
                    dashLogo.classList.remove('hidden');
                }
                if(dashLogoPlaceholder) dashLogoPlaceholder.classList.add('hidden');
                await window.saveToCloud();
            };
            reader.readAsDataURL(input.files[0]);
        };

        window.addGrade = async () => {
            const nameInput = document.getElementById('new-grade-name');
            const priceInput = document.getElementById('new-grade-price');
            const orderInput = document.getElementById('new-grade-order');
            
            const name = nameInput ? nameInput.value : '';
            const price = parseInt(priceInput ? priceInput.value : 0);
            const order = parseInt(orderInput ? orderInput.value : 0) || 0;
            
            if(name && price) {
                window.db.grades.push({id: Date.now(), name, price, order});
                await window.saveToCloud();
                renderGrades();
                if(nameInput) nameInput.value = '';
                if(priceInput) priceInput.value = '';
            }
        };

        function renderGrades() {
            const container = document.getElementById('grades-list');
            if(!container) return;
            
            const sorted = window.db.grades.sort((a,b) => a.order - b.order);
            container.innerHTML = sorted.map(g => `
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition group">
                    <div class="flex items-center gap-4">
                        <span class="w-8 h-8 bg-slate-100 text-slate-500 rounded-lg flex items-center justify-center font-bold text-sm">${g.order}</span>
                        <span class="font-bold text-slate-700 text-lg">${g.name}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-indigo-600 bg-white px-4 py-2 rounded-xl border border-slate-200">${g.price.toLocaleString()} Ø¯.Ù„</span>
                        <button onclick="deleteGrade(${g.id})" class="w-10 h-10 bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white rounded-xl transition flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.deleteGrade = async (id) => {
            window.db.grades = window.db.grades.filter(g => g.id !== id);
            await window.saveToCloud();
            renderGrades();
        };

        window.togglePermissionsEditor = () => {
            const roleSelect = document.getElementById('new-u-role');
            const editor = document.getElementById('permissions-editor');
            if(roleSelect && editor) {
                editor.classList.toggle('hidden', roleSelect.value !== 'staff');
            }
        };

        window.addNewUser = async () => {
            const nameInput = document.getElementById('new-u-name');
            const pinInput = document.getElementById('new-u-pin');
            const roleSelect = document.getElementById('new-u-role');
            
            const name = nameInput ? nameInput.value.trim() : '';
            const pin = pinInput ? pinInput.value : '';
            const role = roleSelect ? roleSelect.value : 'staff';
            
            if(!name || pin.length !== 4) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ ÙˆØ±Ù‚Ù… Ø³Ø±ÙŠ Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…");
                return;
            }

            let permissions = ['all'];
            if(role === 'staff') {
                const checkboxes = document.querySelectorAll('.perm-check:checked');
                permissions = Array.from(checkboxes).map(cb => cb.value);
                if(permissions.length === 0) {
                    showToast("Ø§Ø®ØªØ± ØµÙ„Ø§Ø­ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
                    return;
                }
            }

            window.db.users.push({
                id: Date.now(), 
                name, 
                pin, 
                role, 
                lastLogin: '-',
                permissions
            });
            
            await window.saveToCloud();
            renderUsersTable();
            if(nameInput) nameInput.value = '';
            if(pinInput) pinInput.value = '';
            showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${name}`);
        };

        // FIXED: Function to render users table - ensuring it displays all users
        window.renderUsersTable = function() {
            const tbody = document.getElementById('users-table-body');
            if(!tbody) {
                console.error('users-table-body not found');
                return;
            }
            
            if(!window.db.users || window.db.users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>';
                return;
            }
            
            const currentUserId = currentUser ? currentUser.id : null;
            
            tbody.innerHTML = window.db.users.map(u => {
                const isCurrentUser = u.id === currentUserId;
                const permText = u.role === 'admin' ? 
                    '<span class="text-emerald-600 font-bold">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>' : 
                    (u.permissions || []).map(p => {
                        const labels = {receipts: 'Ù‚Ø¨Ø¶', payments: 'ØµØ±Ù', parents: 'Ø¹Ø§Ø¦Ù„Ø§Øª', reports: 'ØªÙ‚Ø§Ø±ÙŠØ±', daily: 'Ø¥ØºÙ„Ø§Ù‚', logs: 'Ø³Ø¬Ù„Ø§Øª'};
                        return p === 'all' ? 'Ø§Ù„ÙƒÙ„' : `<span class="inline-block bg-slate-100 px-2 py-1 rounded text-xs ml-1 border border-slate-200">${labels[p] || p}</span>`;
                    }).join('');
                
                return `
                    <tr class="border-b border-slate-50 hover:bg-slate-50 transition ${isCurrentUser ? 'bg-indigo-50/50' : ''}">
                        <td class="p-4 font-bold text-slate-800">
                            ${u.name}
                            ${isCurrentUser ? '<span class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded mr-1">Ø£Ù†Øª</span>' : ''}
                        </td>
                        <td class="p-4">
                            <span class="px-3 py-1.5 rounded-lg text-xs font-bold ${u.role === 'admin' ? 'bg-rose-100 text-rose-700' : 'bg-blue-100 text-blue-700'}">
                                ${u.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…' : 'Ù…ÙˆØ¸Ù'}
                            </span>
                        </td>
                        <td class="p-4 text-xs">${permText}</td>
                        <td class="p-4 text-xs font-mono text-slate-400">${u.lastLogin || '-'}</td>
                        <td class="p-4 text-xs font-mono text-slate-500 dir-ltr" style="text-align:right;">${u.pin}</td>
                        <td class="p-4">
                            ${!isCurrentUser ? 
                                `<button onclick="deleteUser(${u.id})" class="text-rose-500 hover:text-rose-700 text-xs font-bold bg-rose-50 hover:bg-rose-100 px-3 py-1.5 rounded-lg transition flex items-center gap-1">
                                    <i class="fa-solid fa-trash"></i> Ø­Ø°Ù
                                </button>` : 
                                '<span class="text-xs text-slate-400 italic">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ</span>'
                            }
                        </td>
                    </tr>
                `;
            }).join('');
        };

        // FIXED: Function to delete user with proper confirmation
        window.deleteUser = async function(id) {
            const userToDelete = window.db.users.find(u => u.id === id);
            if(!userToDelete) return;
            
            if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${userToDelete.name}"ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
                return;
            }
            
            window.db.users = window.db.users.filter(u => u.id !== id);
            await window.saveToCloud();
            renderUsersTable();
            showToast(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userToDelete.name}`);
        };

        window.createYearFromSettings = async () => {
            const input = document.getElementById('settings-new-year');
            const year = input ? input.value.trim() : '';
            
            if(!year || window.db.years.includes(year)) {
                showToast("Ø§Ù„Ø¹Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­");
                return;
            }
            window.db.years.push(year);
            window.db.years.sort();
            window.yearData[year] = { parents: [], transactions: [], dailyNotes: {} };
            await window.saveToCloud();
            initSettings();
            showToast(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… ${year}`);
        };

        window.switchYearFromSettings = async () => {
            const select = document.getElementById('settings-current-year');
            if(!select) return;
            
            window.db.currentYear = select.value;
            await window.saveToCloud();
            showToast("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: " + window.db.currentYear);
            
            const dashBadge = document.getElementById('dash-year-badge');
            const moduleBadge = document.getElementById('module-year-badge');
            if(dashBadge) dashBadge.innerText = window.db.currentYear;
            if(moduleBadge) moduleBadge.innerText = window.db.currentYear;
        };

        window.promoteStudents = async () => {
            const fromSelect = document.getElementById('promote-from-year');
            const toSelect = document.getElementById('promote-to-year');
            
            const from = fromSelect ? fromSelect.value : '';
            const to = toSelect ? toSelect.value : '';
            
            if(from === to) {
                showToast("Ø§Ø®ØªØ± Ø¹Ø§Ù…ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†");
                return;
            }
            if(!window.yearData[to]) {
                showToast("Ø§Ù„Ø¹Ø§Ù… Ø§Ù„ÙˆØ¬Ù‡Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                return;
            }
            
            const count = window.yearData[from].parents.length;
            if(count === 0) {
                showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…ØµØ¯Ø±");
                return;
            }
            
            if(!confirm(`Ø³ÙŠØªÙ… Ù†Ù‚Ù„ ${count} Ø¹Ø§Ø¦Ù„Ø© Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to}. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) return;
            
            const promoted = window.yearData[from].parents.map(p => ({
                ...p, 
                id: Date.now() + Math.random(), 
                paid: 0, 
                promotedFrom: from,
                createdAt: new Date().toLocaleDateString('ar-LY')
            }));
            
            window.yearData[to].parents = [...window.yearData[to].parents, ...promoted];
            await window.saveToCloud();
            showToast(`ØªÙ… ØªØ±Ù‚ÙŠØ© ${count} Ø¹Ø§Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­`);
        };

        // Backup & Restore Functions
        window.exportBackup = () => {
            const backupData = {
                global: window.db,
                years: window.yearData,
                exportDate: new Date().toISOString(),
                version: '2.0',
                exportedBy: currentUser?.name || 'unknown'
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
            const link = document.createElement('a');
            link.setAttribute("href", dataStr);
            link.setAttribute("download", `backup_${window.db.schoolName}_${window.db.currentYear}_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(link);
            link.click();
            link.remove();
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
        };

        window.importBackup = (input) => {
            const file = input.files[0];
            if(!file) return;
            
            const filenameDiv = document.getElementById('restore-filename');
            const filenameSpan = document.getElementById('selected-file-name');
            
            if(filenameDiv) filenameDiv.classList.remove('hidden');
            if(filenameSpan) filenameSpan.innerText = file.name;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    restoreBuffer = JSON.parse(e.target.result);
                    showToast("Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯");
                } catch(err) {
                    showToast("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù");
                }
            };
            reader.readAsText(file);
        };

        window.confirmRestore = async () => {
            if(!restoreBuffer) {
                showToast("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }
            
            if(!confirm("Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
            if(!confirm("ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
            
            try {
                if(restoreBuffer.global) window.db = restoreBuffer.global;
                if(restoreBuffer.years) window.yearData = restoreBuffer.years;
                
                await window.saveToCloud();
                showToast("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...");
                setTimeout(() => location.reload(), 1500);
            } catch(err) {
                showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯");
            }
        };

        window.importExcel = (input) => {
            if(!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const wb = XLSX.read(e.target.result, {type:'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws, {header:1});
                    
                    let count = 0;
                    for(let i=1; i<data.length; i++) {
                        const row = data[i];
                        if(!row[0]) continue;
                        
                        let p = getCurrentData().parents.find(x => x.name === row[0]);
                        if(!p) {
                            p = {
                                id: Date.now() + i,
                                name: row[0],
                                phone: row[1]?.toString() || "",
                                students: [],
                                totalFees: 0,
                                paid: 0,
                                createdAt: new Date().toLocaleDateString('ar-LY')
                            };
                            getCurrentData().parents.push(p);
                        }
                        
                        const price = parseInt(row[5]) || 0;
                        p.students.push({
                            name: row[2],
                            mother: row[3] || "-",
                            grade: row[4] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                            price: price
                        });
                        p.totalFees += price;
                        count++;
                    }
                    
                    await window.saveToCloud();
                    showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`);
                    const modParents = document.getElementById('mod-parents');
                    if(modParents && !modParents.classList.contains('hidden')) {
                        initParents();
                    }
                } catch(err) {
                    console.error(err);
                    showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù");
                }
            };
            reader.readAsArrayBuffer(input.files[0]);
        };

        // Initialize Google Sign-in
        const googleSigninBtn = document.getElementById('google-signin-btn');
        if(googleSigninBtn) {
            googleSigninBtn.addEventListener('click', window.signInWithGoogle);
        }
    </script>
</body>
</html>