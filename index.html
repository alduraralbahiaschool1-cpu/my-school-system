<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูููุธููุฉ ุงููุฏุฑุณูุฉ ุงูุดุงููุฉ PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --font-main: 'Tajawal', sans-serif; --color-primary: #4f46e5; --color-sec: #10b981; }
        body { font-family: var(--font-main); background-color: #f1f5f9; overflow-x: hidden; }
        
        /* ุชุญุณููุงุช ุงูุชุตููู */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); }
        .input-std { @apply w-full p-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none transition-all shadow-sm; }
        .btn-main { @apply bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2; }
        .dash-card { @apply bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100 hover:shadow-xl transition-all cursor-pointer relative overflow-hidden; }
        
        /* ุทุจุงุนุฉ */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; z-index: 9999; background: white; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 10mm; }
        }

        /* ุงููููุดู */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ุชุฎุตูุต ุดุฑูุท ุงูุชูุฑูุฑ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; rounded: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <div id="loader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin text-6xl text-indigo-600 mb-4"><i class="fas fa-circle-notch"></i></div>
        <h2 class="text-xl font-bold text-slate-700">ุฌุงุฑู ุงูุงุชุตุงู ุจุงููุธุงู ุงูุณุญุงุจู...</h2>
    </div>

    <div id="view-google-login" class="hidden fixed inset-0 z-[90] bg-slate-900 flex flex-col items-center justify-center p-6">
        <div class="glass p-12 rounded-[3rem] text-center max-w-lg w-full shadow-2xl">
            <div class="text-6xl mb-6 text-indigo-600"><i class="fas fa-school"></i></div>
            <h1 class="text-4xl font-black mb-2">ุงูููุธููุฉ ุงููุฏุฑุณูุฉ</h1>
            <p class="text-slate-500 mb-8 font-medium">ุงูุฅุตุฏุงุฑ ุงูุดุงูู PRO v4.0</p>
            <button onclick="signInWithGoogle()" class="w-full bg-white border border-slate-200 p-4 rounded-2xl flex items-center justify-center gap-3 hover:bg-slate-50 transition shadow-md group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6">
                <span class="font-bold text-slate-700 group-hover:text-indigo-600">ุชุณุฌูู ุงูุฏุฎูู ุจู Google</span>
            </button>
        </div>
    </div>

    <div id="view-year-select" class="hidden fixed inset-0 z-[80] bg-slate-800/95 backdrop-blur-md flex items-center justify-center p-6 fade-in">
        <div class="bg-white p-10 rounded-3xl w-full max-w-2xl text-center shadow-2xl">
            <h2 class="text-3xl font-black text-slate-800 mb-2">ูุฑุญุจุงู ุจู ๐</h2>
            <p class="text-slate-500 mb-8">ูุฑุฌู ุชุฃููุฏ ุงูุนุงู ุงูุฏุฑุงุณู ููุนูู ุนููู</p>
            
            <div class="text-6xl font-black text-indigo-600 mb-8 tracking-tighter" id="splash-year-display">2025-2026</div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="confirmYear()" class="bg-indigo-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200">ุฏุฎูู ุงููุธุงู โ</button>
                <button onclick="toggleYearSettings()" class="bg-slate-100 text-slate-600 py-4 rounded-xl font-bold hover:bg-slate-200">ุชุบููุฑ ุงูุนุงู โ๏ธ</button>
            </div>
            
            <div id="year-settings-panel" class="hidden mt-6 p-4 bg-slate-50 rounded-xl border text-right animate-pulse">
                <label class="block text-sm font-bold mb-2">ุงุฎุชุฑ ุนุงูุงู ุณุงุจูุงู ุฃู ุฃูุดุฆ ุฌุฏูุฏุงู:</label>
                <select id="year-selector" class="input-std mb-2"></select>
                <button onclick="createNewYear()" class="text-indigo-600 text-sm font-bold hover:underline">+ ุฅูุดุงุก ุนุงู ุฏุฑุงุณู ุฌุฏูุฏ (ุชุฑููุฉ ุงูุทูุงุจ)</button>
            </div>
        </div>
    </div>

    <div id="view-pin" class="hidden fixed inset-0 z-[70] bg-slate-900 flex items-center justify-center p-6">
        <div class="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
            <div class="text-white space-y-4">
                <h1 class="text-4xl font-black">ุชุณุฌูู ุฏุฎูู ุงูููุธููู</h1>
                <p class="opacity-70">ุงูุนุงู ุงูุฏุฑุงุณู ุงูุญุงูู: <span id="pin-current-year" class="font-mono text-amber-400 font-bold">...</span></p>
                <div id="users-list-container" class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scroll"></div>
            </div>
            <div id="pin-pad-container" class="bg-white/10 backdrop-blur-md p-6 rounded-3xl border border-white/10 opacity-50 pointer-events-none transition-all">
                <div class="text-center mb-6">
                    <p id="target-user-name" class="text-indigo-300 font-bold mb-2">ุงุฎุชุฑ ูุณุชุฎุฏูุงู</p>
                    <div class="flex justify-center gap-3">
                        <span class="dot w-3 h-3 rounded-full bg-slate-600" id="d0"></span>
                        <span class="dot w-3 h-3 rounded-full bg-slate-600" id="d1"></span>
                        <span class="dot w-3 h-3 rounded-full bg-slate-600" id="d2"></span>
                        <span class="dot w-3 h-3 rounded-full bg-slate-600" id="d3"></span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(1)">1</button>
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(2)">2</button>
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(3)">3</button>
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(4)">4</button>
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(5)">5</button>
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(6)">6</button>
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(7)">7</button>
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(8)">8</button>
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(9)">9</button>
                    <button class="btn-pin h-14 bg-rose-500/50 rounded-xl text-rose-200 font-bold hover:bg-rose-500" onclick="clearPin()">C</button>
                    <button class="btn-pin h-14 bg-white/20 rounded-xl text-white font-bold text-xl hover:bg-white/30" onclick="addPin(0)">0</button>
                    <button class="btn-pin h-14 bg-emerald-500 rounded-xl text-white font-bold hover:bg-emerald-600" onclick="login()">โ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-dashboard" class="hidden min-h-screen flex flex-col">
        <header class="bg-white shadow-sm px-8 py-4 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <img id="school-logo-img" src="" class="w-12 h-12 object-contain rounded-lg bg-slate-50 border hidden">
                <div>
                    <h1 id="header-school-name" class="font-black text-lg text-slate-800">...</h1>
                    <span id="header-year" class="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded font-bold font-mono">...</span>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="dailyClose()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700"><i class="fas fa-lock ml-2"></i>ุฅุบูุงู ูููู</button>
                <button onclick="logout()" class="bg-rose-50 text-rose-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-rose-100">ุฎุฑูุฌ</button>
            </div>
        </header>

        <main class="flex-1 p-8 max-w-7xl mx-auto w-full space-y-8">
            
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                <div onclick="openModule('receipts')" class="dash-card group">
                    <div class="w-14 h-14 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-file-invoice-dollar"></i></div>
                    <h3 class="font-bold text-lg">ุณูุฏ ูุจุถ</h3>
                </div>
                <div onclick="openModule('payments')" class="dash-card group">
                    <div class="w-14 h-14 bg-rose-100 text-rose-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-hand-holding-dollar"></i></div>
                    <h3 class="font-bold text-lg">ุณูุฏ ุตุฑู</h3>
                </div>
                <div onclick="openModule('parents')" class="dash-card group">
                    <div class="w-14 h-14 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-users"></i></div>
                    <h3 class="font-bold text-lg">ุฃูููุงุก ุงูุฃููุฑ</h3>
                </div>
                <div onclick="openModule('reports')" class="dash-card group">
                    <div class="w-14 h-14 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-chart-pie"></i></div>
                    <h3 class="font-bold text-lg">ุงูุชูุงุฑูุฑ</h3>
                </div>
                <div onclick="openModule('others')" class="dash-card group col-span-2 lg:col-span-1 bg-slate-800 text-white border-slate-700">
                    <div class="w-14 h-14 bg-white/20 text-white rounded-2xl flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition"><i class="fas fa-ellipsis-h"></i></div>
                    <h3 class="font-bold text-lg">ุฃุฎุฑู / ุงูุณุฌูุงุช</h3>
                </div>
            </div>

            <div id="modules-container" class="bg-white rounded-[2rem] shadow-sm border border-slate-200 min-h-[500px] relative overflow-hidden">
                
                <div id="mod-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300">
                    <i class="fas fa-school text-8xl mb-4 opacity-20"></i>
                    <p class="font-bold text-lg">ุงุฎุชุฑ ูุณูุงู ููุจุฏุก</p>
                </div>

                <div id="mod-receipts" class="mod-section hidden p-8 fade-in">
                    <h2 class="text-2xl font-black text-emerald-600 mb-6 flex items-center gap-2"><i class="fas fa-file-invoice-dollar"></i> ุณูุฏ ูุจุถ ุฌุฏูุฏ</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="relative mb-4">
                                <input type="text" id="rec-search" oninput="searchParent(this.value)" placeholder="๐ ุงุจุญุซ ุนู ููู ุงูุฃูุฑ..." class="input-std font-bold">
                                <div id="rec-results" class="absolute top-full left-0 right-0 bg-white shadow-xl rounded-xl z-20 max-h-48 overflow-y-auto border hidden"></div>
                            </div>
                            <div id="rec-parent-card" class="hidden bg-emerald-50 border border-emerald-100 p-6 rounded-2xl mb-6">
                                <h3 id="rec-p-name" class="font-bold text-lg text-emerald-900">...</h3>
                                <div id="rec-students-list" class="text-sm text-emerald-700 my-2"></div>
                                <div class="flex gap-4 mt-4 text-center">
                                    <div class="bg-white p-2 rounded-lg flex-1"><p class="text-xs text-slate-500">ุงูุฏููู</p><strong id="rec-debt" class="text-rose-500">0</strong></div>
                                    <div class="bg-white p-2 rounded-lg flex-1"><p class="text-xs text-slate-500">ุงููุฏููุน</p><strong id="rec-paid" class="text-emerald-500">0</strong></div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <input type="number" id="rec-amount" placeholder="ุงููุจูุบ" class="input-std text-3xl font-black text-emerald-600">
                            <div class="flex gap-2">
                                <select id="rec-method" class="input-std"><option>ููุฏุงู</option><option>ุตู</option><option>ุชุญููู</option></select>
                                <input id="rec-note" type="text" placeholder="ููุงุญุธุฉ / ุฑูู ุงูุตู" class="input-std flex-[2]">
                            </div>
                            <button onclick="submitReceipt()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-emerald-700">ุฅุตุฏุงุฑ ุณูุฏ ูุจุถ</button>
                        </div>
                    </div>
                </div>

                <div id="mod-payments" class="mod-section hidden p-8 fade-in">
                    <h2 class="text-2xl font-black text-rose-600 mb-6 flex items-center gap-2"><i class="fas fa-hand-holding-dollar"></i> ุณูุฏ ุตุฑู</h2>
                    <div class="max-w-2xl mx-auto space-y-6">
                        <input type="text" id="pay-to" placeholder="ูุตุฑู ููุณูุฏ / ุงูุฌูุฉ..." class="input-std">
                        <input type="text" id="pay-reason" placeholder="ูุฐูู ููุงุจู..." class="input-std">
                        <div class="flex gap-4">
                            <input type="number" id="pay-amount" placeholder="ุงููุจูุบ" class="input-std text-rose-600 font-bold text-2xl">
                            <select id="pay-cat" class="input-std w-1/3"><option>ุนุงู</option><option>ุฑูุงุชุจ</option><option>ุตูุงูุฉ</option><option>ูุดุชุฑูุงุช</option></select>
                        </div>
                        <button onclick="submitPayment()" class="w-full bg-rose-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-rose-700">ุฅุตุฏุงุฑ ุณูุฏ ุตุฑู</button>
                    </div>
                </div>

                <div id="mod-parents" class="mod-section hidden p-8 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-black text-indigo-600"><i class="fas fa-users"></i> ุฅุฏุงุฑุฉ ุงูุนุงุฆูุงุช</h2>
                        <button onclick="document.getElementById('modal-add-family').classList.remove('hidden')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm">+ ุนุงุฆูุฉ ุฌุฏูุฏุฉ</button>
                    </div>
                    <input type="text" oninput="renderParentsTable(this.value)" placeholder="ุจุญุซ ุณุฑูุน..." class="input-std mb-4">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-slate-50 text-slate-500 font-bold"><tr><th class="p-3">ุงูุงุณู</th><th class="p-3">ุงููุงุชู</th><th class="p-3">ุงูุฑุณูู</th><th class="p-3">ุงููุฏููุน</th><th class="p-3">ุงููุชุจูู</th><th class="p-3">ุชุญูู</th></tr></thead>
                            <tbody id="parents-tbody" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <div id="mod-reports" class="mod-section hidden p-8 fade-in">
                    <div class="flex justify-between items-center mb-6 no-print">
                        <h2 class="text-2xl font-black text-amber-600"><i class="fas fa-chart-pie"></i> ุงูุชูุงุฑูุฑ ุงููุงููุฉ</h2>
                        <button onclick="window.print()" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fas fa-print ml-2"></i>ุทุจุงุนุฉ</button>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mb-8">
                        <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 text-center"><p class="text-sm text-emerald-800">ุฅุฌูุงูู ุงูููุจูุถุงุช</p><h3 id="rep-in" class="text-2xl font-black text-emerald-600">0</h3></div>
                        <div class="bg-rose-50 p-4 rounded-2xl border border-rose-100 text-center"><p class="text-sm text-rose-800">ุฅุฌูุงูู ุงููุตุฑููุงุช</p><h3 id="rep-out" class="text-2xl font-black text-rose-600">0</h3></div>
                        <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 text-center"><p class="text-sm text-indigo-800">ุงูุฏููู ุงููุณุชุญูุฉ</p><h3 id="rep-debt" class="text-2xl font-black text-indigo-600">0</h3></div>
                    </div>
                    <h3 class="font-bold mb-4 border-b pb-2">ูุงุฆูุฉ ุงูุฏููู (ูููุทุงูุจุฉ)</h3>
                    <div id="rep-debt-list" class="space-y-2 text-sm"></div>
                </div>

                <div id="mod-others" class="mod-section hidden p-0 flex flex-col h-full fade-in">
                    <div class="flex border-b bg-slate-50">
                        <button onclick="switchTab('records')" class="tab-btn flex-1 p-4 font-bold text-slate-500 hover:bg-white hover:text-indigo-600 transition">๐ ุณุฌู ุงูุนูููุงุช</button>
                        <button onclick="switchTab('settings')" class="tab-btn flex-1 p-4 font-bold text-slate-500 hover:bg-white hover:text-indigo-600 transition">โ๏ธ ุงูุฅุนุฏุงุฏุงุช ูุงููุณุฎ</button>
                    </div>
                    
                    <div id="tab-records" class="tab-content p-8 h-full overflow-y-auto">
                        <div class="flex justify-between mb-4">
                            <h3 class="font-bold">ุณุฌู ุงูููุงุชูุฑ (ูุจุถ ูุตุฑู)</h3>
                            <button onclick="exportToExcel()" class="text-emerald-600 text-sm font-bold">ุชุตุฏูุฑ Excel <i class="fas fa-file-excel"></i></button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-right"><thead class="bg-slate-100"><tr><th class="p-2">ุฑูู</th><th class="p-2">ุงูููุน</th><th class="p-2">ุงูุงุณู / ุงูุจูุงู</th><th class="p-2">ุงููุจูุบ</th><th class="p-2">ุงูุชุงุฑูุฎ</th><th class="p-2">ุงูููุธู</th></tr></thead><tbody id="records-tbody" class="divide-y"></tbody></table></div>
                    </div>

                    <div id="tab-settings" class="tab-content hidden p-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <h4 class="font-bold border-r-4 border-indigo-500 pr-2">ูููุฉ ุงููุฏุฑุณุฉ</h4>
                                <input type="text" id="set-school-name" class="input-std" placeholder="ุงุณู ุงููุฏุฑุณุฉ">
                                <div class="flex gap-2 items-center">
                                    <input type="file" id="logo-upload" class="text-sm" accept="image/*">
                                    <button onclick="uploadLogo()" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">ุฑูุน ุงูุดุนุงุฑ</button>
                                </div>
                                <button onclick="saveGlobalSettings()" class="btn-main w-full">ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
                            </div>
                            
                            <div class="space-y-4">
                                <h4 class="font-bold border-r-4 border-amber-500 pr-2">ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุณููุงุช</h4>
                                <div class="flex gap-2">
                                    <button onclick="downloadBackup()" class="flex-1 bg-emerald-100 text-emerald-700 p-3 rounded-lg font-bold text-sm">โฌ๏ธ ุชุญููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
                                    <button onclick="document.getElementById('restore-file').click()" class="flex-1 bg-amber-100 text-amber-700 p-3 rounded-lg font-bold text-sm">โฌ๏ธ ุงุณุชุฑุฌุงุน ูุณุฎุฉ</button>
                                    <input type="file" id="restore-file" class="hidden" onchange="restoreBackup(this)">
                                </div>
                                <div class="bg-slate-800 text-white p-4 rounded-xl">
                                    <h5 class="font-bold mb-2 text-sm text-amber-400">ูุธุงู ุงูุณููุงุช</h5>
                                    <p class="text-xs opacity-70 mb-3">ููููู ุงูุงูุชูุงู ูุนุงู ุฌุฏูุฏ ูุชุฑุญูู ุงูุทูุงุจ ุขููุงู.</p>
                                    <button onclick="toggleYearSettings(); goHome();" class="w-full bg-white/10 hover:bg-white/20 py-2 rounded text-sm">ุฅุฏุงุฑุฉ ุงูุนุงู ุงูุฏุฑุงุณู</button>
                                </div>
                            </div>

                            <div class="col-span-1 md:col-span-2 pt-4 border-t">
                                <h4 class="font-bold mb-4">ุงููุณุชุฎุฏููู ูุงูุตูุงุญูุงุช</h4>
                                <div class="flex gap-2 mb-4">
                                    <input id="new-u-name" placeholder="ุงุณู ุงูููุธู" class="input-std">
                                    <input id="new-u-pin" placeholder="PIN (4)" maxlength="4" class="input-std w-24">
                                    <select id="new-u-role" class="input-std w-32"><option value="user">ููุธู</option><option value="admin">ูุฏูุฑ</option></select>
                                    <button onclick="addNewUser()" class="bg-slate-800 text-white px-4 rounded-xl">+</button>
                                </div>
                                <div id="users-setting-list" class="grid grid-cols-2 gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-add-family" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-3xl rounded-3xl p-8 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-black mb-6">ุชุณุฌูู ุนุงุฆูุฉ ุฌุฏูุฏุฉ</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input type="text" id="new-fam-name" placeholder="ุงุณู ููู ุงูุฃูุฑ" class="input-std">
                <input type="text" id="new-fam-phone" placeholder="ุฑูู ุงููุงุชู" class="input-std">
            </div>
            
            <div class="bg-slate-50 p-4 rounded-xl border mb-4">
                <h4 class="font-bold mb-2 text-sm">ุฅุถุงูุฉ ุงูุฃุจูุงุก</h4>
                <div class="flex gap-2 mb-2">
                    <input id="temp-stud-name" placeholder="ุงุณู ุงูุทุงูุจ" class="flex-1 p-2 border rounded">
                    <select id="temp-stud-grade" class="w-32 p-2 border rounded font-bold text-sm"></select>
                    <button onclick="addTempStudent()" class="bg-indigo-600 text-white px-3 rounded">+</button>
                </div>
                <div id="temp-students-display" class="space-y-1"></div>
            </div>
            
            <div class="flex justify-between items-center">
                <p class="font-bold text-lg">ุงูุฅุฌูุงูู: <span id="new-fam-total" class="text-indigo-600">0</span></p>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('modal-add-family').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold">ุฅูุบุงุก</button>
                    <button onclick="saveNewFamily()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold">ุญูุธ ุงูุนุงุฆูุฉ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-edit-family" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-4xl rounded-3xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg">ุชูุงุตูู ุงูุนุงุฆูุฉ ูุชุนุฏูู ุงูุจูุงูุงุช</h3>
                <button onclick="closeEditModal()" class="text-2xl hover:text-rose-400">ร</button>
            </div>
            <div class="p-8 overflow-y-auto">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><label class="text-xs font-bold text-slate-400">ููู ุงูุฃูุฑ</label><input id="edit-p-name" class="input-std font-bold"></div>
                    <div><label class="text-xs font-bold text-slate-400">ุงููุงุชู</label><input id="edit-p-phone" class="input-std font-mono"></div>
                </div>
                
                <h4 class="font-bold text-indigo-600 mb-2 border-b pb-1">ุงูุฃุจูุงุก ุงููุณุฌููู</h4>
                <div id="edit-students-list" class="space-y-2 mb-6"></div>
                
                <div class="flex gap-2 bg-slate-50 p-3 rounded-lg border mb-6">
                    <input id="add-exist-stud-name" placeholder="ุทุงูุจ ุฅุถุงูู..." class="flex-1 text-sm p-2 border rounded">
                    <select id="add-exist-stud-grade" class="text-sm border rounded"></select>
                    <button onclick="addStudentToExistingFamily()" class="bg-emerald-600 text-white px-3 rounded text-sm font-bold">ุฅุถุงูุฉ</button>
                </div>

                <div class="flex justify-between items-center pt-4 border-t">
                    <button onclick="deleteFamilyFully()" class="text-rose-600 font-bold hover:bg-rose-50 px-4 py-2 rounded transition">โ๏ธ ุญุฐู ุงูุนุงุฆูุฉ ุจุงููุงูู</button>
                    <button onclick="saveFamilyChanges()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700">ุญูุธ ุงูุชุนุฏููุงุช</button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-area"></div>
<script>
        // --- 1. ุฅุนุฏุงุฏุงุช FIREBASE (ุงุณุชุจุฏู ุงูููู ุจููุงุชูุญ ูุดุฑูุนู) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBPdIGZ-V1efsO4Ohzq6ioRoBR4YyDzQb0", // ุงุณุชุจุฏู ูุฐุง
            authDomain: "schoolsystem-7be7a.firebaseapp.com",
            projectId: "schoolsystem-7be7a",
            storageBucket: "schoolsystem-7be7a.firebasestorage.app",
            messagingSenderId: "191775387521",
            appId: "1:191775387521:web:9009678837327f697d8280"
        };
        
        // ุชููุฆุฉ ุงูุชุทุจูู
        const app = firebase.initializeApp(firebaseConfig);
        const db_cloud = firebase.firestore();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        // --- 2. ุงููุชุบูุฑุงุช ุงูุนุงูุฉ (Global State) ---
        window.fullDB = {}; // ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฎุงู (ูู ุงูุณููุงุช)
        window.activeData = { parents: [], transactions: [], grades: [] }; // ุจูุงูุงุช ุงูุนุงู ุงูุญุงูู ููุท
        window.currentYear = "";
        window.currentUser = null;
        
        let pinBuffer = "";
        let tempStudents = []; // ูุฎุฒู ูุคูุช ูุฅุถุงูุฉ ุงูุทูุงุจ
        let activeParentForReceipt = null;
        let activeParentIdForEdit = null;

        // --- 3. ูุธุงู ุงูุฏุฎูู ูุงููุฒุงููุฉ (Auth & Sync) ---
        function signInWithGoogle() {
            auth.signInWithPopup(provider).catch(err => alert("ุฎุทุฃ: " + err.message));
        }

        auth.onAuthStateChanged(async (user) => {
            const loader = document.getElementById('loader');
            if (user) {
                document.getElementById('view-google-login').classList.add('hidden');
                await loadCloudData(user.email);
            } else {
                loader.classList.add('hidden');
                document.getElementById('view-google-login').classList.remove('hidden');
            }
        });

        async function loadCloudData(email) {
            const docRef = db_cloud.collection('schools').doc(email);
            const docSnap = await docRef.get();

            if (docSnap.exists) {
                window.fullDB = docSnap.data();
            } else {
                // ุฅูุดุงุก ูุงุนุฏุฉ ุจูุงูุงุช ุฌุฏูุฏุฉ ูุฃูู ูุฑุฉ
                const thisYear = "2025-2026";
                window.fullDB = {
                    schoolName: "ุงููุฏุฑุณุฉ ุงููููุฐุฌูุฉ",
                    logo: "",
                    users: [{id: 1, name: "ุงููุฏูุฑ ุงูุนุงู", pin: "1234", role: "admin"}],
                    years: [thisYear],
                    currentYear: thisYear,
                    [`data_${thisYear}`]: { parents: [], transactions: [], grades: defaultGrades() }
                };
                await docRef.set(window.fullDB);
            }
            
            // ุฅุฎูุงุก ุงูุชุญููู ูุฅุธูุงุฑ ุดุงุดุฉ ุงุฎุชูุงุฑ ุงูุณูุฉ
            document.getElementById('loader').classList.add('hidden');
            initYearSystem();
        }

        async function saveToCloud() {
            if (!auth.currentUser) return;
            // ุชุญุฏูุซ ุจูุงูุงุช ุงูุณูุฉ ุงูุญุงููุฉ ุฏุงุฎู ุงููุงุฆู ุงูุฑุฆูุณู
            window.fullDB[`data_${window.currentYear}`] = window.activeData;
            window.fullDB.currentYear = window.currentYear;
            
            // ุงูุญูุธ
            await db_cloud.collection('schools').doc(auth.currentUser.email).set(window.fullDB);
        }

        function defaultGrades() {
            return [
                {id:1, name:'ุฃูู ุงุจุชุฏุงุฆู', price:3000},
                {id:2, name:'ุซุงูู ุงุจุชุฏุงุฆู', price:3000},
                {id:3, name:'ุซุงูุซ ุซุงููู', price:4500}
            ];
        }

        // --- 4. ูุธุงู ุงูุณููุงุช ุงูุฏุฑุงุณูุฉ (Year System) ---
        function initYearSystem() {
            window.currentYear = window.fullDB.currentYear || window.fullDB.years[0];
            document.getElementById('splash-year-display').innerText = window.currentYear;
            document.getElementById('view-year-select').classList.remove('hidden');
            
            // ููุก ูุงุฆูุฉ ุงูุณููุงุช
            const selector = document.getElementById('year-selector');
            selector.innerHTML = window.fullDB.years.map(y => `<option value="${y}">${y}</option>`).join('');
            selector.value = window.currentYear;
        }

        function toggleYearSettings() {
            document.getElementById('year-settings-panel').classList.toggle('hidden');
        }

        async function createNewYear() {
            const lastYear = window.fullDB.years[window.fullDB.years.length - 1];
            // ููุทู ุชูููุฏ ุงุณู ุงูุณูุฉ ุงููุงุฏูุฉ (ูุซูุงู 2026-2027)
            const parts = lastYear.split('-');
            const newYear = `${parseInt(parts[0])+1}-${parseInt(parts[1])+1}`;
            
            if(confirm(`ูู ุชุฑูุฏ ุฅูุดุงุก ุนุงู ุฏุฑุงุณู ุฌุฏูุฏ (${newYear}) ูุชุฑุญูู ุงูุทูุงุจุ`)) {
                // ูุณุฎ ุงูุทูุงุจ ุจุฏูู ุงูุฏูุนุงุช (ุชุตููุฑ ุงูุญุณุงุจุงุช)
                const oldData = window.fullDB[`data_${lastYear}`];
                const newParents = oldData.parents.map(p => ({
                    ...p,
                    totalFees: 0, // ูุฌุจ ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฑุณูู ูุงุญูุงู
                    paid: 0,
                    students: p.students.map(s => ({...s, price: 0})) // ุชุตููุฑ ุงูุฃุณุนุงุฑ ูุชุญุฏูุซูุง
                }));

                window.fullDB.years.push(newYear);
                window.fullDB[`data_${newYear}`] = {
                    parents: newParents,
                    transactions: [],
                    grades: oldData.grades
                };
                
                alert(`ุชู ุฅูุดุงุก ุงูุนุงู ${newYear} ุจูุฌุงุญ! ุชู ููู ${newParents.length} ุนุงุฆูุฉ.`);
                // ุชุญุฏูุซ ุงููุงุฆูุฉ
                initYearSystem();
            }
        }

        function confirmYear() {
            // ุงุนุชูุงุฏ ุงูุณูุฉ ุงููุฎุชุงุฑุฉ ูู ุงููุงุฆูุฉ (ุฅุฐุง ุชู ุชุบููุฑูุง) ุฃู ุงูุงูุชุฑุงุถูุฉ
            const selected = document.getElementById('year-selector').value || window.currentYear;
            window.currentYear = selected;
            
            // ุชุญููู ุจูุงูุงุช ุงูุณูุฉ ุงููุฎุชุงุฑุฉ ููุฐุงูุฑุฉ ุงููุดุทุฉ
            window.activeData = window.fullDB[`data_${selected}`] || { parents: [], transactions: [], grades: [] };
            if(!window.activeData.parents) window.activeData.parents = []; // ุญูุงูุฉ ูู ุงูุจูุงูุงุช ุงููุงุฑุบุฉ
            if(!window.activeData.transactions) window.activeData.transactions = [];

            // ุงูุงูุชูุงู ูุดุงุดุฉ ุงูู PIN
            document.getElementById('view-year-select').classList.add('hidden');
            document.getElementById('view-pin').classList.remove('hidden');
            document.getElementById('pin-current-year').innerText = window.currentYear;
            renderPinUsers();
        }

        // --- 5. ูุธุงู ุงูู PIN ูุงููุณุชุฎุฏููู ---
        function renderPinUsers() {
            const list = document.getElementById('users-list-container');
            list.innerHTML = window.fullDB.users.map(u => `
                <div onclick="selectPinUser(${u.id}, '${u.name}')" class="bg-white/10 p-3 rounded-xl cursor-pointer hover:bg-white/20 flex items-center gap-3 border border-white/5 transition">
                    <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center font-bold">${u.name[0]}</div>
                    <div><p class="font-bold">${u.name}</p><p class="text-xs opacity-70">${u.role}</p></div>
                </div>
            `).join('');
        }

        let selectedUserObj = null;
        function selectPinUser(id, name) {
            selectedUserObj = window.fullDB.users.find(u => u.id === id);
            document.getElementById('target-user-name').innerText = `ูููุฉ ุงููุฑูุฑ ูู: ${name}`;
            document.getElementById('pin-pad-container').classList.remove('opacity-50', 'pointer-events-none');
            clearPin();
        }

        function addPin(n) {
            if(pinBuffer.length < 4) {
                pinBuffer += n;
                updateDots();
            }
        }
        function clearPin() { pinBuffer = ""; updateDots(); }
        function updateDots() {
            for(let i=0; i<4; i++) document.getElementById(`d${i}`).classList.toggle('bg-white', i < pinBuffer.length);
        }
        function login() {
            if(selectedUserObj && selectedUserObj.pin === pinBuffer) {
                window.currentUser = selectedUserObj;
                document.getElementById('view-pin').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                initDashboard();
            } else {
                alert("ุฑูุฒ ุฎุทุฃ");
                clearPin();
            }
        }
        function logout() { location.reload(); }

        // --- 6. ููุญุฉ ุงูุชุญูู ูุงูุชููุฆุฉ ---
        function initDashboard() {
            document.getElementById('header-school-name').innerText = window.fullDB.schoolName;
            document.getElementById('header-year').innerText = window.currentYear;
            
            // ุงูุดุนุงุฑ
            if(window.fullDB.logo) {
                const img = document.getElementById('school-logo-img');
                img.src = window.fullDB.logo;
                img.classList.remove('hidden');
            }

            // ุชุญููู ุจูุงูุงุช ุงูููุงุฆู ุงูููุณุฏูุฉ
            renderGradesInSelects();
            renderSettingsUsers();
            renderRecordsTable(); // ุชุญุฏูุซ ุงูุณุฌูุงุช
            
            // ุฅุฎูุงุก ุฅุนุฏุงุฏุงุช ุงููุฏูุฑ ุฅุฐุง ูุงู ููุธูุงู
            if(window.currentUser.role !== 'admin') {
                document.getElementById('tab-settings').innerHTML = "<div class='text-center p-10 text-slate-400'>ููุณ ูุฏูู ุตูุงุญูุฉ ุงููุตูู ููุฅุนุฏุงุฏุงุช</div>";
            }
        }

        function openModule(modId) {
            // ุงูุชููู ุจูู ุงูุฃูุณุงู
            document.getElementById('mod-placeholder').classList.add('hidden');
            document.querySelectorAll('.mod-section').forEach(m => m.classList.add('hidden'));
            document.getElementById('mod-'+modId).classList.remove('hidden');
            
            if(modId === 'parents') renderParentsTable();
            if(modId === 'receipts') renderRecentReceipts(); // ุชุฌููุฒ ุงูุณูุฏุงุช
            if(modId === 'reports') updateReports();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById('tab-'+tabId).classList.remove('hidden');
        }

        // --- 7. ุฅุฏุงุฑุฉ ุงูุนุงุฆูุงุช ูุงูุทูุงุจ (ุงูุฅุถุงูุฉ ูุงูุชุนุฏูู) ---
        // ุฃ) ุฅุถุงูุฉ ุฌุฏูุฏุฉ
        function addTempStudent() {
            const name = document.getElementById('temp-stud-name').value;
            const gradeId = document.getElementById('temp-stud-grade').value;
            if(!name) return;
            
            const grade = window.activeData.grades.find(g => g.id == gradeId);
            tempStudents.push({ name, gradeName: grade.name, price: parseInt(grade.price) });
            
            renderTempStudentsList('temp-students-display');
            document.getElementById('temp-stud-name').value = "";
            updateNewFamilyTotal();
        }

        function renderTempStudentsList(containerId) {
            const container = document.getElementById(containerId);
            let html = tempStudents.map((s, i) => `
                <div class="flex justify-between bg-white p-2 border rounded text-xs">
                    <span>${s.name} (${s.gradeName})</span>
                    <div class="flex gap-2">
                        <span class="font-bold">${s.price}</span>
                        <button onclick="removeTempStudent(${i}, '${containerId}')" class="text-rose-500">ร</button>
                    </div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function removeTempStudent(index, containerId) {
            tempStudents.splice(index, 1);
            renderTempStudentsList(containerId);
            updateNewFamilyTotal();
        }

        function updateNewFamilyTotal() {
            const total = tempStudents.reduce((sum, s) => sum + s.price, 0);
            document.getElementById('new-fam-total').innerText = total;
        }

        async function saveNewFamily() {
            const pName = document.getElementById('new-fam-name').value;
            const pPhone = document.getElementById('new-fam-phone').value;
            const total = parseInt(document.getElementById('new-fam-total').innerText);

            if(pName && tempStudents.length > 0) {
                const newFamily = {
                    id: Date.now(),
                    name: pName,
                    phone: pPhone,
                    students: [...tempStudents],
                    totalFees: total,
                    paid: 0
                };
                window.activeData.parents.push(newFamily);
                await saveToCloud();
                
                alert("ุชู ุงูุญูุธ!");
                document.getElementById('modal-add-family').classList.add('hidden');
                tempStudents = []; // ุชุตููุฑ
                document.getElementById('new-fam-name').value = "";
                renderParentsTable();
            } else {
                alert("ุจูุงูุงุช ูุงูุตุฉ");
            }
        }

        // ุจ) ุนุฑุถ ุงูุฌุฏูู ูุงูุจุญุซ
        function renderParentsTable(query = "") {
            const tbody = document.getElementById('parents-tbody');
            const list = window.activeData.parents.filter(p => p.name.includes(query)).reverse();
            
            tbody.innerHTML = list.map(p => {
                const debt = p.totalFees - p.paid;
                const statusColor = debt > 0 ? 'text-rose-500' : 'text-emerald-500';
                return `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-3 font-bold">${p.name}</td>
                    <td class="p-3 font-mono text-xs">${p.phone}</td>
                    <td class="p-3">${p.totalFees.toLocaleString()}</td>
                    <td class="p-3 text-emerald-600">${p.paid.toLocaleString()}</td>
                    <td class="p-3 font-bold ${statusColor}">${debt.toLocaleString()}</td>
                    <td class="p-3">
                        <button onclick="openEditModal(${p.id})" class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded text-xs font-bold hover:bg-indigo-200">ุชูุงุตูู/ุชุนุฏูู</button>
                    </td>
                </tr>`;
            }).join('');
        }

        // ุฌ) ุงูุชุนุฏูู ูุงูุญุฐู (Fix Requested)
        function openEditModal(parentId) {
            activeParentIdForEdit = parentId;
            const p = window.activeData.parents.find(x => x.id === parentId);
            
            document.getElementById('edit-p-name').value = p.name;
            document.getElementById('edit-p-phone').value = p.phone;
            
            // ุชุนุจุฆุฉ ุงููุงุฆูุฉ ุงูููุณุฏูุฉ ููุฅุถุงูุฉ ุงูุณุฑูุนุฉ ุฏุงุฎู ุงูุชุนุฏูู
            const gradeSelect = document.getElementById('add-exist-stud-grade');
            gradeSelect.innerHTML = window.activeData.grades.map(g => `<option value="${g.id}">${g.name} (${g.price})</option>`).join('');

            renderEditStudentsList(p);
            document.getElementById('modal-edit-family').classList.remove('hidden');
        }

        function renderEditStudentsList(parent) {
            const container = document.getElementById('edit-students-list');
            container.innerHTML = parent.students.map((s, idx) => `
                <div class="flex items-center gap-2 bg-slate-50 p-2 rounded border">
                    <input value="${s.name}" onchange="updateStudentName(${parent.id}, ${idx}, this.value)" class="bg-transparent border-b outline-none text-sm font-bold flex-1">
                    <span class="text-xs bg-white px-2 py-1 rounded border">${s.gradeName}</span>
                    <button onclick="removeStudentFromFamily(${parent.id}, ${idx})" class="text-rose-500 hover:bg-rose-100 p-1 rounded">๐๏ธ</button>
                </div>
            `).join('');
        }

        function addStudentToExistingFamily() {
            const name = document.getElementById('add-exist-stud-name').value;
            const gradeId = document.getElementById('add-exist-stud-grade').value;
            if(!name) return;

            const p = window.activeData.parents.find(x => x.id === activeParentIdForEdit);
            const grade = window.activeData.grades.find(g => g.id == gradeId);
            
            p.students.push({ name, gradeName: grade.name, price: parseInt(grade.price) });
            p.totalFees += parseInt(grade.price); // ุชุญุฏูุซ ุงูุฏูู
            
            renderEditStudentsList(p);
            document.getElementById('add-exist-stud-name').value = "";
        }

        function removeStudentFromFamily(pId, sIdx) {
            if(confirm("ุญุฐู ุงูุทุงูุจ ุณูููู ูู ุฑุณูู ููู ุงูุฃูุฑ. ูู ุฃูุช ูุชุฃูุฏุ")) {
                const p = window.activeData.parents.find(x => x.id === pId);
                const removedPrice = p.students[sIdx].price;
                p.students.splice(sIdx, 1);
                p.totalFees -= removedPrice;
                renderEditStudentsList(p);
            }
        }

        function updateStudentName(pId, sIdx, val) {
            const p = window.activeData.parents.find(x => x.id === pId);
            p.students[sIdx].name = val;
        }

        async function saveFamilyChanges() {
            const p = window.activeData.parents.find(x => x.id === activeParentIdForEdit);
            p.name = document.getElementById('edit-p-name').value;
            p.phone = document.getElementById('edit-p-phone').value;
            
            await saveToCloud();
            alert("ุชู ุญูุธ ุงูุชุนุฏููุงุช");
            document.getElementById('modal-edit-family').classList.add('hidden');
            renderParentsTable();
        }

        async function deleteFamilyFully() {
            if(confirm("ุชุญุฐูุฑ ุฎุทูุฑ: ุณูุชู ุญุฐู ุงูุนุงุฆูุฉ ููู ุณุฌูุงุชูุง ุงููุงููุฉ ููุงุฆูุงู!")) {
                window.activeData.parents = window.activeData.parents.filter(x => x.id !== activeParentIdForEdit);
                await saveToCloud();
                document.getElementById('modal-edit-family').classList.add('hidden');
                renderParentsTable();
            }
        }
        function closeEditModal() { document.getElementById('modal-edit-family').classList.add('hidden'); }


        // --- 8. ุงููุนุงููุงุช ุงููุงููุฉ (ุณูุฏุงุช ุงููุจุถ ูุงูุตุฑู) ---
        function searchParent(q) {
            const res = document.getElementById('rec-results');
            if(q.length < 2) { res.classList.add('hidden'); return; }
            
            const matches = window.activeData.parents.filter(p => p.name.includes(q));
            res.innerHTML = matches.map(p => `
                <div onclick="selectParentForReceipt(${p.id})" class="p-3 border-b hover:bg-slate-50 cursor-pointer flex justify-between">
                    <span class="font-bold text-sm">${p.name}</span>
                    <span class="text-xs text-rose-500 font-bold">ุนููู: ${(p.totalFees - p.paid)}</span>
                </div>
            `).join('');
            res.classList.remove('hidden');
        }

        function selectParentForReceipt(id) {
            activeParentForReceipt = window.activeData.parents.find(p => p.id === id);
            document.getElementById('rec-search').value = activeParentForReceipt.name;
            document.getElementById('rec-results').classList.add('hidden');
            document.getElementById('rec-parent-card').classList.remove('hidden');
            
            document.getElementById('rec-p-name').innerText = activeParentForReceipt.name;
            document.getElementById('rec-debt').innerText = (activeParentForReceipt.totalFees - activeParentForReceipt.paid).toLocaleString();
            document.getElementById('rec-paid').innerText = activeParentForReceipt.paid.toLocaleString();
            document.getElementById('rec-students-list').innerText = "ุนู: " + activeParentForReceipt.students.map(s=>s.name).join('ุ ');
        }

        async function submitReceipt() {
            if(!activeParentForReceipt) return alert("ุงุฎุชุฑ ููู ุฃูุฑ");
            const amount = parseFloat(document.getElementById('rec-amount').value);
            if(!amount) return alert("ุงุฏุฎู ุงููุจูุบ");

            const oldDebt = activeParentForReceipt.totalFees - activeParentForReceipt.paid;
            
            // ุชุญุฏูุซ ุจูุงูุงุช ุงูููู
            activeParentForReceipt.paid += amount;

            // ุฅูุดุงุก ุงูุณูุฏ
            const txn = {
                id: Date.now(),
                type: 'in', // ูุงุฑุฏ
                pName: activeParentForReceipt.name,
                amount: amount,
                method: document.getElementById('rec-method').value,
                note: document.getElementById('rec-note').value,
                date: new Date().toLocaleDateString('ar-LY'),
                time: new Date().toLocaleTimeString('ar-LY'),
                by: window.currentUser.name,
                oldDebt: oldDebt,
                newDebt: oldDebt - amount
            };
            
            window.activeData.transactions.push(txn);
            await saveToCloud();
            
            // ุงูุทุจุงุนุฉ
            printReceiptSlip(txn);
            
            // ุชูุธูู
            document.getElementById('rec-parent-card').classList.add('hidden');
            document.getElementById('rec-amount').value = "";
            document.getElementById('rec-search').value = "";
            activeParentForReceipt = null;
        }

        async function submitPayment() {
            const to = document.getElementById('pay-to').value;
            const amount = parseFloat(document.getElementById('pay-amount').value);
            if(!to || !amount) return alert("ุจูุงูุงุช ูุงูุตุฉ");

            const txn = {
                id: Date.now(),
                type: 'out', // ุตุงุฏุฑ
                pName: to,
                amount: amount,
                cat: document.getElementById('pay-cat').value,
                note: document.getElementById('pay-reason').value,
                date: new Date().toLocaleDateString('ar-LY'),
                time: new Date().toLocaleTimeString('ar-LY'),
                by: window.currentUser.name
            };

            window.activeData.transactions.push(txn);
            await saveToCloud();
            
            printPaymentSlip(txn);
            
            document.getElementById('pay-to').value = "";
            document.getElementById('pay-amount').value = "";
        }

        // --- 9. ููุทู ุงูุทุจุงุนุฉ (Receipts) ---
        function printReceiptSlip(txn) {
            const area = document.getElementById('print-area');
            const logoHtml = window.fullDB.logo ? `<img src="${window.fullDB.logo}" style="height:50px; margin:0 auto 10px;">` : '';
            
            area.innerHTML = `
                <div style="font-family:'Tajawal'; text-align:center; padding:20px; border:2px solid #000; height:138mm;">
                    ${logoHtml}
                    <h2 style="margin:0; font-size:22px; font-weight:900;">${window.fullDB.schoolName}</h2>
                    <p style="margin:5px 0 20px;">ุณูุฏ ูุจุถ ูุงูู</p>
                    
                    <table style="width:100%; text-align:right; direction:rtl; margin-bottom:20px; font-size:16px;">
                        <tr><td style="font-weight:bold;">ุฑูู ุงูุณูุฏ:</td><td>#${txn.id.toString().slice(-5)}</td></tr>
                        <tr><td style="font-weight:bold;">ุงูุชุงุฑูุฎ:</td><td>${txn.date}</td></tr>
                        <tr><td style="font-weight:bold;">ุงุณุชูููุง ูู:</td><td>${txn.pName}</td></tr>
                        <tr><td style="font-weight:bold;">ูุจูุบ ููุฏุฑู:</td><td style="font-size:20px; font-weight:900;">${txn.amount.toLocaleString()} ุฏ.ู</td></tr>
                        <tr><td style="font-weight:bold;">ุทุฑููุฉ ุงูุฏูุน:</td><td>${txn.method} - ${txn.note}</td></tr>
                    </table>
                    
                    <div style="border-top:1px dashed #000; border-bottom:1px dashed #000; padding:10px 0; display:flex; justify-content:space-between; text-align:center;">
                        <div><small>ุงูุฏูู ุงูุณุงุจู</small><br><strong>${txn.oldDebt}</strong></div>
                        <div><small>ุงููุฏููุน</small><br><strong>${txn.amount}</strong></div>
                        <div><small>ุงููุชุจูู</small><br><strong>${txn.newDebt}</strong></div>
                    </div>
                    
                    <div style="margin-top:40px; display:flex; justify-content:space-between;">
                        <div>ุงููุญุงุณุจ: ${txn.by}</div>
                        <div>ุงูุชูููุน: .................</div>
                    </div>
                </div>
            `;
            window.print();
        }

        function printPaymentSlip(txn) {
            const area = document.getElementById('print-area');
            area.innerHTML = `
                <div style="font-family:'Tajawal'; text-align:center; padding:20px; border:2px solid #000; height:138mm;">
                    <h2 style="margin:0; font-size:22px; font-weight:900;">${window.fullDB.schoolName}</h2>
                    <p style="margin:5px 0 20px;">ุณูุฏ ุตุฑู ููุฏู</p>
                    <div style="text-align:right; font-size:18px; line-height:2.5;">
                        <p>ุตุฑููุง ููุณูุฏ/ <b>${txn.pName}</b></p>
                        <p>ูุจูุบ ููุฏุฑู/ <b style="border:1px solid #000; padding:2px 10px;">${txn.amount.toLocaleString()}</b></p>
                        <p>ูุฐูู ููุงุจู/ ${txn.note}</p>
                        <p>ุงูุชุตููู/ ${txn.cat}</p>
                    </div>
                    <div style="margin-top:50px; display:flex; justify-content:space-between;">
                        <div>ุฃููู ุงูุตูุฏูู<br>${txn.by}</div>
                        <div>ุงููุณุชูู<br>................</div>
                    </div>
                </div>
            `;
            window.print();
        }

        // --- 10. ุงูุชูุงุฑูุฑ ูุงูุฅุบูุงู ุงููููู ---
        function updateReports() {
            const txns = window.activeData.transactions;
            const parents = window.activeData.parents;
            
            const totalIn = txns.filter(t => t.type === 'in').reduce((sum, t) => sum + t.amount, 0);
            const totalOut = txns.filter(t => t.type === 'out').reduce((sum, t) => sum + t.amount, 0);
            const totalDebt = parents.reduce((sum, p) => sum + (p.totalFees - p.paid), 0);
            
            document.getElementById('rep-in').innerText = totalIn.toLocaleString();
            document.getElementById('rep-out').innerText = totalOut.toLocaleString();
            document.getElementById('rep-debt').innerText = totalDebt.toLocaleString();
            
            // ูุงุฆูุฉ ุงูุฏููู
            const debtList = parents.filter(p => (p.totalFees - p.paid) > 0).sort((a,b) => (b.totalFees-b.paid) - (a.totalFees-a.paid));
            document.getElementById('rep-debt-list').innerHTML = debtList.map(p => `
                <div class="flex justify-between bg-slate-50 p-2 border-b">
                    <span>${p.name}</span>
                    <span class="font-bold text-rose-500">${(p.totalFees - p.paid).toLocaleString()}</span>
                </div>
            `).join('');
        }

        function dailyClose() {
            const today = new Date().toLocaleDateString('ar-LY');
            const todayTxns = window.activeData.transactions.filter(t => t.date === today);
            
            if(todayTxns.length === 0) return alert("ูุง ุชูุฌุฏ ุนูููุงุช ุงูููู");

            const sumIn = todayTxns.filter(t => t.type === 'in').reduce((a,b)=>a+b.amount, 0);
            const sumOut = todayTxns.filter(t => t.type === 'out').reduce((a,b)=>a+b.amount, 0);

            const area = document.getElementById('print-area');
            area.innerHTML = `
                <div style="font-family:'Tajawal'; text-align:center; padding:30px;">
                    <h1>ุชูุฑูุฑ ุงูุฅุบูุงู ุงููููู</h1>
                    <h3>ุงูุชุงุฑูุฎ: ${today}</h3>
                    <hr>
                    <table style="width:100%; margin:20px 0; font-size:18px; border-collapse:collapse;">
                        <tr><td style="border:1px solid #000; padding:10px;">ุฅุฌูุงูู ุงูููุจูุถุงุช</td><td style="border:1px solid #000; padding:10px;">${sumIn}</td></tr>
                        <tr><td style="border:1px solid #000; padding:10px;">ุฅุฌูุงูู ุงููุตุฑููุงุช</td><td style="border:1px solid #000; padding:10px;">${sumOut}</td></tr>
                        <tr><td style="border:1px solid #000; padding:10px; font-weight:bold;">ุงูุตุงูู ูู ุงูุตูุฏูู</td><td style="border:1px solid #000; padding:10px; font-weight:bold;">${sumIn - sumOut}</td></tr>
                    </table>
                    <p>ุงูููุธู ุงููุณุคูู: ${window.currentUser.name}</p>
                </div>
            `;
            window.print();
        }

        // --- 11. ุงููุณุงุนุฏุงุช (Settings, Excel, Backup) ---
        function renderGradesInSelects() {
            const html = window.activeData.grades.map(g => `<option value="${g.id}">${g.name} (${g.price})</option>`).join('');
            document.querySelectorAll('select[id*="grade"]').forEach(s => s.innerHTML = html);
        }

        function renderSettingsUsers() {
            document.getElementById('users-setting-list').innerHTML = window.fullDB.users.map(u => `
                <div class="bg-slate-100 p-2 rounded text-xs flex justify-between items-center">
                    <span>${u.name} (${u.pin})</span>
                    <button onclick="deleteUser(${u.id})" class="text-red-500">x</button>
                </div>
            `).join('');
        }
        
        async function addNewUser() {
            const name = document.getElementById('new-u-name').value;
            const pin = document.getElementById('new-u-pin').value;
            const role = document.getElementById('new-u-role').value;
            if(name && pin) {
                window.fullDB.users.push({id: Date.now(), name, pin, role});
                await saveToCloud();
                renderSettingsUsers();
                document.getElementById('new-u-name').value = "";
            }
        }
        
        async function deleteUser(id) {
            if(window.fullDB.users.length <= 1) return alert("ูุฌุจ ุฅุจูุงุก ูุณุชุฎุฏู ูุงุญุฏ ุนูู ุงูุฃูู");
            window.fullDB.users = window.fullDB.users.filter(u => u.id !== id);
            await saveToCloud();
            renderSettingsUsers();
        }

        // ุฑูุน ุงูุดุนุงุฑ
        async function uploadLogo() {
            const file = document.getElementById('logo-upload').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    window.fullDB.logo = e.target.result; // Base64
                    await saveToCloud();
                    alert("ุชู ุฑูุน ุงูุดุนุงุฑ");
                    initDashboard();
                };
                reader.readAsDataURL(file);
            }
        }

        // ุญูุธ ุงูุงุณู
        async function saveGlobalSettings() {
            window.fullDB.schoolName = document.getElementById('set-school-name').value;
            await saveToCloud();
            alert("ุชู ุงูุญูุธ");
        }

        // ุงููุณุฎ ุงูุงุญุชูุงุทู JSON
        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.fullDB));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", `Backup_${window.currentYear}_${new Date().toISOString().slice(0,10)}.json`);
            node.click();
        }

        // ุงุณุชุนุงุฏุฉ ูุณุฎุฉ
        function restoreBackup(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.users && data.years) {
                        window.fullDB = data;
                        await saveToCloud();
                        alert("ุชู ุงุณุชุฑุฌุงุน ุงููุณุฎุฉ ุจูุฌุงุญ! ุณูุชู ุชุญุฏูุซ ุงูุตูุญุฉ.");
                        location.reload();
                    } else { alert("ููู ุบูุฑ ุตุงูุญ"); }
                } catch(err) { alert("ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู"); }
            };
            reader.readAsText(file);
        }

        // ุนุฑุถ ุงูุณุฌูุงุช (ุงูุชุจููุจ ุงูุฃุฎูุฑ)
        function renderRecordsTable() {
            const tbody = document.getElementById('records-tbody');
            // ุฏูุฌ ูู ุงูุนูููุงุช ูุนูุณ ุชุฑุชูุจูุง
            const list = window.activeData.transactions.slice().reverse();
            tbody.innerHTML = list.map(t => `
                <tr class="hover:bg-slate-50">
                    <td class="p-2 border-b">#${t.id.toString().slice(-4)}</td>
                    <td class="p-2 border-b"><span class="${t.type==='in'?'text-emerald-600':'text-rose-600'} font-bold">${t.type==='in'?'ูุจุถ':'ุตุฑู'}</span></td>
                    <td class="p-2 border-b">${t.pName} <span class="text-xs text-gray-400">(${t.note || '-'})</span></td>
                    <td class="p-2 border-b font-bold">${t.amount}</td>
                    <td class="p-2 border-b text-xs">${t.date}</td>
                    <td class="p-2 border-b text-xs">${t.by}</td>
                </tr>
            `).join('');
        }

        // ุชุตุฏูุฑ Excel
        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(window.activeData.transactions);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Records");
            XLSX.writeFile(wb, "School_Records.xlsx");
        }
    </script>
</body>
</html>